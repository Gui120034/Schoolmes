<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">

<!-- SEO & compatibilit√© navigateurs -->
<meta name="description" content="Schoolmes - L'aventure √©ducative avec 10 000 niveaux de quiz !">
<meta name="keywords" content="schoolmes, √©ducatif, quiz, jeu, apprentissage, √©cole">
<meta name="author" content="Schoolmes">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#1e3a8a">

<!-- Open Graph (Facebook, Discord, WhatsApp...) -->
<meta property="og:title" content="Schoolmes - Aventure √âducative">
<meta property="og:description" content="10 000 niveaux de quiz √©ducatifs, des badges, un classement mondial !">
<meta property="og:type" content="website">
<meta property="og:locale" content="fr_FR">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Schoolmes - Aventure √âducative">
<meta name="twitter:description" content="10 000 niveaux de quiz √©ducatifs !">

<!-- Compatibilit√© Apple / iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Schoolmes">
<meta name="format-detection" content="telephone=no">

<!-- Ic√¥ne favicon g√©n√©rique -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÆ</text></svg>">

<title>Schoolmes - Aventure √âducative</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- Polyfill pour vieux navigateurs -->
<script>
// Polyfill Promise pour IE
if (typeof Promise === 'undefined') {
  document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.2.8/es6-promise.auto.min.js"><\/script>');
}
</script>

<!-- Firebase SDK v9 compat ‚Äî chargement robuste avec CDN alternatif -->
<script>
// Pre-check: on v√©rifie que l'internet est dispo
window._fbLoadAttempt = 0;
</script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"
  onerror="window._fbCDNFailed=true"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"
  onerror="window._fbCDNFailed=true"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"
  onerror="window._fbCDNFailed=true"></script>
<style>
* { margin: 0; padding: 0; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }

body {
  font-family: 'Press Start 2P', cursive;
  background: -webkit-linear-gradient(135deg, #1e3a8a 0%, #7c3aed 50%, #ec4899 100%);
  background: -moz-linear-gradient(135deg, #1e3a8a 0%, #7c3aed 50%, #ec4899 100%);
  background: -o-linear-gradient(135deg, #1e3a8a 0%, #7c3aed 50%, #ec4899 100%);
  background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 50%, #ec4899 100%);
  color: white;
  overflow-x: hidden;
  min-height: 100vh;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

.screen {
  max-width: 1200px;
  margin: 20px auto;
  padding: 25px;
  background: rgba(0,0,0,0.7);
  border-radius: 20px;
  border: 4px solid #fbbf24;
  box-shadow: 0 0 30px rgba(251,191,36,0.5);
  display: none;
}

.screen.active { display: block; }

.game-title {
  font-size: 2.5rem;
  text-align: center;
  color: #fbbf24;
  margin-bottom: 30px;
  text-shadow: 0 0 20px rgba(251,191,36,0.8);
}

button {
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  font-family: 'Press Start 2P', cursive;
  font-size: 0.7rem;
  cursor: pointer;
  margin: 8px;
  background: -webkit-linear-gradient(135deg, #10b981, #059669);
  background: -moz-linear-gradient(135deg, #10b981, #059669);
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  -webkit-transition: all 0.3s;
  -moz-transition: all 0.3s;
  -o-transition: all 0.3s;
  transition: all 0.3s;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

button:hover {
  -webkit-transform: translateY(-3px);
  -moz-transform: translateY(-3px);
  -ms-transform: translateY(-3px);
  transform: translateY(-3px);
  -webkit-box-shadow: 0 6px 20px rgba(16,185,129,0.6);
  box-shadow: 0 6px 20px rgba(16,185,129,0.6);
}

button.primary { background: -webkit-linear-gradient(135deg, #3b82f6, #2563eb); background: linear-gradient(135deg, #3b82f6, #2563eb); }
button.danger { background: -webkit-linear-gradient(135deg, #ef4444, #dc2626); background: linear-gradient(135deg, #ef4444, #dc2626); }
button.gold { background: -webkit-linear-gradient(135deg, #fbbf24, #f59e0b); background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
button:disabled { opacity: 0.5; cursor: not-allowed; }

input {
  padding: 12px;
  border: 2px solid #fbbf24;
  border-radius: 10px;
  background: rgba(0,0,0,0.5);
  color: white;
  font-family: 'Press Start 2P', cursive;
  font-size: 0.7rem;
  margin: 8px;
  width: 100%;
  max-width: 400px;
}

.input-group {
  margin: 20px auto;
  max-width: 450px;
  text-align: center;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  color: #fbbf24;
  font-size: 0.8rem;
}

.stats-bar {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  padding: 15px;
  background: rgba(0,0,0,0.5);
  border-radius: 15px;
  margin-bottom: 20px;
}

.stat {
  text-align: center;
  padding: 10px;
  min-width: 150px;
}

.stat-label {
  font-size: 0.6rem;
  color: #9ca3af;
  margin-bottom: 5px;
}

.stat-value {
  font-size: 1rem;
  color: #fbbf24;
}

.xp-bar {
  width: 100%;
  height: 25px;
  background: rgba(0,0,0,0.7);
  border-radius: 15px;
  overflow: hidden;
  border: 2px solid #10b981;
  margin-top: 10px;
}

.xp-fill {
  height: 100%;
  background: -webkit-linear-gradient(90deg, #10b981, #059669);
  background: -moz-linear-gradient(90deg, #10b981, #059669);
  background: linear-gradient(90deg, #10b981, #059669);
  -webkit-transition: width 0.5s;
  -moz-transition: width 0.5s;
  -o-transition: width 0.5s;
  transition: width 0.5s;
  text-align: center;
  line-height: 25px;
  font-size: 0.6rem;
}

#map {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 8px;
  margin: 20px 0;
}

.tile {
  aspect-ratio: 1;
  border-radius: 10px;
  display: -webkit-flex;
  display: -moz-box;
  display: flex;
  -webkit-align-items: center;
  align-items: center;
  -webkit-justify-content: center;
  justify-content: center;
  font-size: 1.2rem;
  border: 2px solid rgba(255,255,255,0.2);
  cursor: pointer;
  -webkit-transition: all 0.3s;
  -moz-transition: all 0.3s;
  -o-transition: all 0.3s;
  transition: all 0.3s;
  position: relative;
}

.tile:hover { -webkit-transform: scale(1.05); -moz-transform: scale(1.05); -ms-transform: scale(1.05); transform: scale(1.05); }

.tile.plains { background: -webkit-linear-gradient(135deg, #065f46, #064e3b); background: linear-gradient(135deg, #065f46, #064e3b); }
.tile.forest { background: -webkit-linear-gradient(135deg, #065f46, #064e3b); background: linear-gradient(135deg, #065f46, #064e3b); }
.tile.desert { background: -webkit-linear-gradient(135deg, #d97706, #b45309); background: linear-gradient(135deg, #d97706, #b45309); }
.tile.snow { background: -webkit-linear-gradient(135deg, #0ea5e9, #0284c7); background: linear-gradient(135deg, #0ea5e9, #0284c7); }
.tile.volcano { background: -webkit-linear-gradient(135deg, #dc2626, #991b1b); background: linear-gradient(135deg, #dc2626, #991b1b); }
.tile.ocean { background: -webkit-linear-gradient(135deg, #1d4ed8, #1e40af); background: linear-gradient(135deg, #1d4ed8, #1e40af); }
.tile.boss { background: -webkit-linear-gradient(135deg, #7c3aed, #6d28d9); background: linear-gradient(135deg, #7c3aed, #6d28d9); border: 3px solid #fbbf24; }

.tile.current { border: 3px solid #10b981; box-shadow: 0 0 20px #10b981; }
.tile.locked { opacity: 0.3; cursor: not-allowed; }
.tile.completed { opacity: 0.6; }

.tile-number {
  position: absolute;
  top: 2px;
  left: 4px;
  font-size: 0.5rem;
  color: rgba(255,255,255,0.6);
}

.question-container {
  margin: 20px 0;
  padding: 20px;
  background: rgba(59,130,246,0.1);
  border-radius: 12px;
  border: 2px solid #3b82f6;
}

.question-text {
  font-size: 0.9rem;
  line-height: 1.8;
  margin-bottom: 20px;
  color: #fbbf24;
}

.shop-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.shop-item {
  background: rgba(0,0,0,0.6);
  padding: 20px;
  border-radius: 12px;
  border: 2px solid #8b5cf6;
  text-align: center;
}

.shop-item:hover {
  -webkit-transform: translateY(-5px);
  -moz-transform: translateY(-5px);
  -ms-transform: translateY(-5px);
  transform: translateY(-5px);
  border-color: #fbbf24;
}

.shop-item-icon { font-size: 2.5rem; margin-bottom: 10px; }
.shop-item-name { font-size: 0.8rem; color: #fbbf24; margin-bottom: 8px; }
.shop-item-desc { font-size: 0.6rem; color: #9ca3af; margin-bottom: 12px; line-height: 1.5; }
.shop-item-price { font-size: 0.9rem; color: #10b981; margin-bottom: 12px; }

.leaderboard-item {
  display: flex;
  align-items: center;
  padding: 15px;
  margin: 10px 0;
  background: rgba(0,0,0,0.5);
  border-radius: 12px;
  border: 2px solid rgba(251,191,36,0.3);
}

.leaderboard-item.podium {
  background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.2));
  border-color: #fbbf24;
}

.leaderboard-rank {
  font-size: 1.5rem;
  margin-right: 20px;
  min-width: 50px;
  text-align: center;
}

.leaderboard-info { flex: 1; }
.leaderboard-name { font-size: 0.9rem; color: #fbbf24; margin-bottom: 5px; }
.leaderboard-stats { font-size: 0.6rem; color: #9ca3af; }

.badge {
  display: inline-block;
  padding: 6px 12px;
  margin: 4px;
  border-radius: 20px;
  font-size: 0.6rem;
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  border: 2px solid #fbbf24;
}

.badge.admin {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #000;
  font-weight: bold;
}
.badge.ami-admin {
  background: linear-gradient(135deg, #ec4899, #be185d);
  color: #fff;
  border: 2px solid #fbbf24;
  animation: amiPulse 2s infinite;
}
.badge.oj {
  background: linear-gradient(135deg, #06b6d4, #0284c7);
  color: #fff;
  border: 2px solid #fff;
}
@keyframes amiPulse {
  0%,100% { box-shadow: 0 0 5px rgba(236,72,153,0.5); }
  50% { box-shadow: 0 0 20px rgba(236,72,153,0.9); }
}
.lb-section-title {
  font-size: 0.75rem;
  color: #fbbf24;
  padding: 10px 15px;
  background: rgba(251,191,36,0.1);
  border-radius: 10px;
  border: 2px solid rgba(251,191,36,0.3);
  margin: 15px 0 8px;
  text-align: center;
}
.lb-section-title.admin-section { background: rgba(251,191,36,0.2); border-color: #fbbf24; }
.lb-section-title.players-section { background: rgba(99,102,241,0.15); border-color: #6366f1; color: #818cf8; }
.online-player-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 15px;
  margin: 8px 0;
  background: rgba(0,0,0,0.5);
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.1);
  transition: all 0.3s;
}
.online-player-card.is-online { border-color: rgba(16,185,129,0.5); }
.online-player-card.is-offline { opacity: 0.6; }
.settings-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px;
  background: rgba(0,0,0,0.4);
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.1);
  margin: 10px 0;
}
.settings-label { font-size: 0.65rem; color: #fbbf24; }
.settings-desc { font-size: 0.5rem; color: #9ca3af; margin-top: 4px; }
.toggle-switch {
  position: relative;
  width: 52px;
  height: 28px;
  flex-shrink: 0;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background: #374151; border-radius: 28px; transition: 0.4s;
}
.toggle-slider:before {
  position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px;
  background: white; border-radius: 50%; transition: 0.4s;
}
input:checked + .toggle-slider { background: #10b981; }
input:checked + .toggle-slider:before { transform: translateX(24px); }
.settings-select {
  background: rgba(0,0,0,0.7); color: white; border: 2px solid #fbbf24;
  border-radius: 8px; padding: 8px 12px; font-family: 'Press Start 2P', cursive;
  font-size: 0.6rem; cursor: pointer;
}
/* Anticheat hidden flag */
.ac-hidden { display: none !important; }

/* INDICATEUR MUSICAL */
#musicIndicator {
  position: fixed; top: 60px; right: 12px; z-index: 7999;
  background: rgba(0,0,0,0.7); border: 1px solid rgba(251,191,36,0.4);
  border-radius: 20px; padding: 4px 10px;
  font-size: 0.35rem; color: #fbbf24;
  display: none; align-items: center; gap: 6px;
  backdrop-filter: blur(8px);
}
#musicIndicator.show { display: flex; }
.music-bars { display: flex; align-items: flex-end; gap: 2px; height: 12px; }
.music-bar {
  width: 3px; background: #fbbf24; border-radius: 2px;
  animation: musicBar 0.8s ease-in-out infinite alternate;
}
.music-bar:nth-child(2) { animation-delay: 0.15s; }
.music-bar:nth-child(3) { animation-delay: 0.3s; }
.music-bar:nth-child(4) { animation-delay: 0.45s; }
@keyframes musicBar {
  from { height: 3px; }
  to   { height: 12px; }
}

/* BAN */
.ban-screen {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: #0a0005;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 99999; padding: 30px; text-align: center;
}
.ban-screen h1 { color: #ef4444; font-size: 2rem; margin-bottom: 20px; animation: eventPulse 1.5s infinite; }
.ban-screen .ban-reason {
  background: rgba(239,68,68,0.15); border: 2px solid #ef4444;
  border-radius: 12px; padding: 20px; max-width: 500px; margin: 15px auto;
  font-size: 0.65rem; color: #fca5a5; line-height: 1.8;
}
.ban-badge {
  background: linear-gradient(135deg, #ef4444, #b91c1c) !important;
  color: #fff !important; border: 2px solid #fca5a5 !important;
  animation: none !important;
}
.admin-ban-modal {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.95); z-index: 20000;
  overflow-y: auto; padding: 20px;
}
.admin-ban-card {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 14px; margin: 6px 0;
  background: rgba(255,255,255,0.05); border-radius: 10px;
  font-size: 0.55rem;
}
.admin-ban-card.is-banned { background: rgba(239,68,68,0.15); border: 1px solid #ef4444; }

/* TH√àMES */
body.theme-dark {
  background: linear-gradient(135deg, #0a0a0f 0%, #111827 50%, #1f2937 100%) !important;
}
body.theme-dark .screen {
  background: rgba(0,0,0,0.85) !important;
  border-color: #6366f1 !important;
}
body.theme-neon {
  background: linear-gradient(135deg, #000000 0%, #0a0a1a 50%, #001100 100%) !important;
}
body.theme-neon .screen {
  background: rgba(0,10,0,0.9) !important;
  border-color: #00ff41 !important;
  box-shadow: 0 0 30px rgba(0,255,65,0.4) !important;
}
body.theme-neon .game-title { color: #00ff41 !important; text-shadow: 0 0 20px #00ff41 !important; }
body.theme-neon button { background: linear-gradient(135deg, #00ff41, #00cc33) !important; color: #000 !important; }
body.theme-neon .stat-value { color: #00ff41 !important; }

.pixel-grid {
  display: -ms-grid;
  display: grid;
  grid-template-columns: repeat(16, 1fr);
  -ms-grid-columns: (1fr)[16];
  gap: 2px;
  width: 352px;
  height: 352px;
  margin: 0 auto 20px;
  background: rgba(255,255,255,0.35);
  border: 3px solid #fbbf24;
  border-radius: 6px;
  padding: 2px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.pixel {
  aspect-ratio: 1;
  cursor: crosshair;
  border-radius: 2px;
  -webkit-transition: filter 0.1s;
  -moz-transition: filter 0.1s;
  -o-transition: filter 0.1s;
  transition: filter 0.1s;
}

.pixel:hover {
  -webkit-filter: brightness(1.3);
  filter: brightness(1.3);
  outline: 1px solid rgba(255,255,255,0.8);
}

.color-palette {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 20px 0;
  flex-wrap: wrap;
}

.color-option {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  cursor: pointer;
  border: 3px solid transparent;
}

.color-option.selected {
  border-color: #fbbf24;
  box-shadow: 0 0 15px currentColor;
}

.admin-panel {
  background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.2));
  padding: 20px;
  border-radius: 15px;
  border: 3px solid #fbbf24;
  margin: 20px 0;
  text-align: center;
}

/* NOUVEAUX STYLES POUR LES BONUS */
.bonus-bar {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 15px 0;
  padding: 15px;
  background: rgba(139,92,246,0.2);
  border-radius: 12px;
  border: 2px solid #8b5cf6;
}

.bonus-button {
  padding: 10px 20px;
  background: -webkit-linear-gradient(135deg, #8b5cf6, #7c3aed);
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
  border: 2px solid #fbbf24;
  border-radius: 10px;
  font-size: 0.7rem;
  cursor: pointer;
  -webkit-transition: all 0.3s;
  -moz-transition: all 0.3s;
  -o-transition: all 0.3s;
  transition: all 0.3s;
  display: -webkit-flex;
  display: flex;
  -webkit-align-items: center;
  align-items: center;
  gap: 8px;
}

.bonus-button:hover {
  -webkit-transform: scale(1.05);
  -moz-transform: scale(1.05);
  -ms-transform: scale(1.05);
  transform: scale(1.05);
  -webkit-box-shadow: 0 0 20px rgba(139,92,246,0.8);
  box-shadow: 0 0 20px rgba(139,92,246,0.8);
}

.bonus-button:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.bonus-count {
  background: rgba(0,0,0,0.5);
  padding: 3px 8px;
  border-radius: 8px;
  font-size: 0.6rem;
}

.choice-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin: 20px 0;
}

.choice-btn {
  padding: 15px 20px;
  background: -webkit-linear-gradient(135deg, rgba(59,130,246,0.3), rgba(37,99,235,0.3));
  background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(37,99,235,0.3));
  border: 2px solid #3b82f6;
  border-radius: 12px;
  color: white;
  font-family: 'Press Start 2P', cursive;
  font-size: 0.65rem;
  cursor: pointer;
  -webkit-transition: all 0.3s;
  -moz-transition: all 0.3s;
  -o-transition: all 0.3s;
  transition: all 0.3s;
  text-align: left;
  line-height: 1.6;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  width: 100%;
}

.choice-btn:hover {
  background: -webkit-linear-gradient(135deg, rgba(59,130,246,0.5), rgba(37,99,235,0.5));
  background: linear-gradient(135deg, rgba(59,130,246,0.5), rgba(37,99,235,0.5));
  border-color: #fbbf24;
  -webkit-transform: translateX(5px);
  -moz-transform: translateX(5px);
  -ms-transform: translateX(5px);
  transform: translateX(5px);
}

.choice-btn.selected {
  background: -webkit-linear-gradient(135deg, rgba(251,191,36,0.4), rgba(245,158,11,0.4));
  background: linear-gradient(135deg, rgba(251,191,36,0.4), rgba(245,158,11,0.4));
  border-color: #fbbf24;
}

.lives-counter {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  padding: 15px;
  background: rgba(239,68,68,0.2);
  border-radius: 12px;
  border: 2px solid #ef4444;
  margin-bottom: 20px;
}

.heart {
  font-size: 2rem;
  transition: all 0.3s;
}

.heart.lost {
  opacity: 0.2;
  filter: grayscale(100%);
}

@media (max-width: 768px) {
  .game-title { font-size: 1.5rem; }
  button { font-size: 0.6rem; padding: 10px 18px; }
  #map { grid-template-columns: repeat(5, 1fr); }
  .bonus-bar { flex-direction: column; }
}

/* CLASSEMENT EN LIGNE */
.leaderboard-online {
  max-height: 500px;
  overflow-y: auto;
  margin: 20px 0;
}

.leaderboard-item {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  margin: 8px 0;
  background: rgba(0,0,0,0.5);
  border-radius: 12px;
  border: 2px solid rgba(251,191,36,0.3);
  transition: all 0.3s;
}
.leaderboard-item:hover { border-color: rgba(251,191,36,0.7); }
.leaderboard-item.me { border-color: #10b981; background: rgba(16,185,129,0.15); }
.leaderboard-item.podium-1 { background: linear-gradient(135deg, rgba(255,215,0,0.25), rgba(251,191,36,0.1)); border-color: gold; }
.leaderboard-item.podium-2 { background: linear-gradient(135deg, rgba(192,192,192,0.25), rgba(180,180,180,0.1)); border-color: silver; }
.leaderboard-item.podium-3 { background: linear-gradient(135deg, rgba(205,127,50,0.25), rgba(180,100,30,0.1)); border-color: #cd7f32; }

.lb-rank { font-size: 1.4rem; min-width: 55px; text-align: center; }
.lb-avatar { width: 40px; height: 40px; border-radius: 8px; margin-right: 12px; background: #222; border: 2px solid #fbbf24; }
.lb-info { flex: 1; }
.lb-name { font-size: 0.75rem; color: #fbbf24; margin-bottom: 4px; }
.lb-stats { font-size: 0.55rem; color: #9ca3af; }
.lb-score { font-size: 0.8rem; color: #10b981; text-align: right; }

/* ADMIN PANEL AM√âLIOR√â */
.admin-section {
  background: rgba(0,0,0,0.4);
  border: 2px solid #fbbf24;
  border-radius: 12px;
  padding: 20px;
  margin: 15px 0;
}
.admin-section h3 { color: #fbbf24; font-size: 0.8rem; margin-bottom: 15px; }
.admin-player-list { max-height: 300px; overflow-y: auto; margin: 10px 0; }
.admin-player-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  margin: 5px 0;
  background: rgba(0,0,0,0.4);
  border-radius: 8px;
  border: 1px solid rgba(251,191,36,0.2);
  font-size: 0.6rem;
}
.admin-player-row:hover { border-color: #fbbf24; }

/* MINI AVATAR ACCUEIL & CLASSEMENT */
.mini-avatar-canvas {
  image-rendering: pixelated;
  border-radius: 6px;
  border: 2px solid #fbbf24;
  display: inline-block;
  vertical-align: middle;
  flex-shrink: 0;
}
.home-player-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* ===== M√âCANIQUES ADDICTIVES ===== */

/* COMBO & STREAK */
#comboDisplay {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 9000;
  text-align: center;
  pointer-events: none;
}
.combo-badge {
  background: linear-gradient(135deg, #ff6b00, #ff0066);
  border: 3px solid #fbbf24;
  border-radius: 15px;
  padding: 10px 18px;
  font-size: 0.75rem;
  font-family: 'Press Start 2P', cursive;
  color: white;
  animation: comboPulse 0.5s ease-out;
  text-shadow: 0 0 10px rgba(255,100,0,0.8);
  box-shadow: 0 0 20px rgba(255,107,0,0.7);
}
.combo-badge.mega { background: linear-gradient(135deg, #7c3aed, #ec4899); font-size:1rem; }
.combo-badge.ultra { background: linear-gradient(135deg, #fbbf24, #ef4444); font-size:1.2rem; }
@keyframes comboPulse {
  0% { transform: scale(0.5) rotate(-10deg); opacity:0; }
  60% { transform: scale(1.3) rotate(3deg); }
  100% { transform: scale(1) rotate(0deg); opacity:1; }
}

/* TIMER BAR */
#timerBar {
  width: 100%;
  height: 8px;
  background: rgba(0,0,0,0.5);
  border-radius: 4px;
  overflow: hidden;
  margin: 10px 0;
  border: 1px solid rgba(255,255,255,0.2);
}
#timerFill {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #fbbf24, #ef4444);
  transition: width 0.1s linear, background 0.3s;
  border-radius: 4px;
}
#timerText {
  text-align: center;
  font-size: 0.6rem;
  color: #fbbf24;
  margin-bottom: 5px;
}

/* FLOATING PARTICLES */
.particle {
  position: fixed;
  pointer-events: none;
  font-size: 1.5rem;
  z-index: 9999;
  animation: floatUp 1.5s ease-out forwards;
}
@keyframes floatUp {
  0% { opacity:1; transform: translateY(0) scale(1); }
  100% { opacity:0; transform: translateY(-150px) scale(0.5); }
}

/* SCREEN SHAKE */
@keyframes screenShake {
  0%,100% { transform: translateX(0); }
  20% { transform: translateX(-8px); }
  40% { transform: translateX(8px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(4px); }
}
.shake { animation: screenShake 0.4s ease; }

/* ANNOUNCEMENTS */
#comboAnnouncement {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  pointer-events: none;
  text-align: center;
  font-size: 2rem;
  font-family: 'Press Start 2P', cursive;
  color: #fbbf24;
  text-shadow: 0 0 30px rgba(251,191,36,0.9), 0 0 60px rgba(251,191,36,0.5);
  opacity: 0;
}
#comboAnnouncement.show {
  animation: announceShow 1.5s ease forwards;
}
@keyframes announceShow {
  0% { opacity:0; transform: translate(-50%,-50%) scale(0.3); }
  20% { opacity:1; transform: translate(-50%,-50%) scale(1.2); }
  70% { opacity:1; transform: translate(-50%,-50%) scale(1); }
  100% { opacity:0; transform: translate(-50%,-80%) scale(0.8); }
}

/* LOOT CHEST */
.loot-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  border: 4px solid #fbbf24;
  border-radius: 20px;
  padding: 30px;
  text-align: center;
  z-index: 20000;
  box-shadow: 0 0 60px rgba(251,191,36,0.5);
  animation: popIn 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
  min-width: 300px;
}
@keyframes popIn {
  0% { transform: translate(-50%,-50%) scale(0); }
  100% { transform: translate(-50%,-50%) scale(1); }
}
.rarity-common { color: #9ca3af; }
.rarity-rare { color: #3b82f6; }
.rarity-epic { color: #8b5cf6; }
.rarity-legendary { color: #fbbf24; text-shadow: 0 0 20px #fbbf24; }

/* DAILY QUEST PANEL */
#dailyQuestBanner {
  background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2));
  border: 2px solid #10b981;
  border-radius: 12px;
  padding: 15px;
  margin: 10px 0;
  cursor: pointer;
}
.quest-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  margin: 5px 0;
  background: rgba(0,0,0,0.3);
  border-radius: 8px;
  font-size: 0.6rem;
}
.quest-progress-bar {
  flex: 1;
  height: 8px;
  background: rgba(0,0,0,0.5);
  border-radius: 4px;
  overflow: hidden;
}
.quest-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #059669);
  border-radius: 4px;
  transition: width 0.3s;
}

/* LEAGUE BADGE */
.league-badge {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.65rem;
  margin: 5px;
  border: 2px solid;
  cursor: pointer;
  transition: all 0.3s;
}
.league-bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); border-color: #cd7f32; }
.league-silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); border-color: silver; color: #000; }
.league-gold { background: linear-gradient(135deg, #ffd700, #ffa500); border-color: gold; color: #000; }
.league-diamond { background: linear-gradient(135deg, #b9f2ff, #00d4ff); border-color: #00d4ff; color: #000; }

/* TALENT TREE */
.talent-node {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: 3px solid;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.5rem;
  text-align: center;
  padding: 5px;
}
.talent-node.unlocked { border-color: #10b981; background: rgba(16,185,129,0.2); }
.talent-node.available { border-color: #fbbf24; background: rgba(251,191,36,0.1); animation: talentPulse 2s infinite; }
.talent-node.locked { border-color: #4b5563; background: rgba(0,0,0,0.3); opacity: 0.5; }
@keyframes talentPulse {
  0%,100% { box-shadow: 0 0 0 rgba(251,191,36,0.4); }
  50% { box-shadow: 0 0 20px rgba(251,191,36,0.8); }
}

/* ENERGY SYSTEM */
#energyDisplay {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
  padding: 10px;
  background: rgba(239,68,68,0.1);
  border: 2px solid #ef4444;
  border-radius: 10px;
  margin: 10px 0;
  font-size: 0.65rem;
}

/* EVENT BANNER */
#eventBanner {
  background: linear-gradient(135deg, #7c3aed, #ec4899, #fbbf24);
  background-size: 200% 200%;
  animation: gradientShift 3s ease infinite, eventPulse 2s ease infinite;
  border-radius: 12px;
  padding: 12px;
  margin: 10px 0;
  text-align: center;
  font-size: 0.65rem;
  cursor: pointer;
  border: 2px solid #fbbf24;
}
@keyframes gradientShift {
  0%,100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}
@keyframes eventPulse {
  0%,100% { box-shadow: 0 0 10px rgba(251,191,36,0.3); }
  50% { box-shadow: 0 0 30px rgba(251,191,36,0.8); }
}

/* PRESTIGE */
.prestige-badge {
  background: linear-gradient(135deg, #ff6b00, #ffd700);
  color: #000;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.55rem;
  border: 2px solid #fff;
}

/* DAILY LOGIN REWARD */
.login-day {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  border-radius: 10px;
  border: 2px solid;
  min-width: 60px;
  font-size: 0.5rem;
  transition: all 0.3s;
}
.login-day.claimed { background: rgba(16,185,129,0.2); border-color: #10b981; }
.login-day.today { background: rgba(251,191,36,0.2); border-color: #fbbf24; animation: talentPulse 1.5s infinite; }
.login-day.upcoming { background: rgba(0,0,0,0.3); border-color: #4b5563; opacity: 0.6; }

/* ===== MODE MULTIJOUEUR ===== */

/* Lobby & matchmaking */
.pvp-lobby {
  background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.15));
  border: 2px solid #6366f1;
  border-radius: 16px;
  padding: 20px;
  margin: 15px 0;
}

.pvp-player-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px;
  background: rgba(0,0,0,0.5);
  border-radius: 12px;
  border: 2px solid rgba(99,102,241,0.4);
  margin: 8px 0;
  transition: all 0.3s;
}
.pvp-player-card.ready { border-color: #10b981; background: rgba(16,185,129,0.1); }
.pvp-player-card.waiting { border-color: #f59e0b; animation: waitingPulse 1.5s infinite; }
.pvp-player-card.winner { border-color: #fbbf24; background: rgba(251,191,36,0.15); box-shadow: 0 0 20px rgba(251,191,36,0.4); }
.pvp-player-card.loser { border-color: #ef4444; background: rgba(239,68,68,0.05); opacity: 0.7; }
@keyframes waitingPulse {
  0%,100% { border-color: rgba(245,158,11,0.4); }
  50% { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245,158,11,0.4); }
}

.pvp-avatar { width: 48px; height: 48px; border-radius: 10px; border: 2px solid #fbbf24; flex-shrink: 0; background: #111; }
.pvp-info { flex: 1; }
.pvp-name { font-size: 0.75rem; color: #fbbf24; margin-bottom: 4px; }
.pvp-stats { font-size: 0.55rem; color: #9ca3af; }
.pvp-score { font-size: 1.1rem; color: #10b981; text-align: right; min-width: 50px; }

/* VS divider */
.vs-divider {
  text-align: center;
  font-size: 1.5rem;
  color: #ef4444;
  text-shadow: 0 0 20px #ef4444;
  margin: 5px 0;
  animation: vsPulse 1s infinite;
}
@keyframes vsPulse {
  0%,100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

/* Duel question */
.duel-hud {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: rgba(0,0,0,0.6);
  border-radius: 12px;
  border: 2px solid #6366f1;
  margin-bottom: 15px;
  gap: 10px;
}
.duel-side { text-align: center; flex: 1; }
.duel-side-name { font-size: 0.5rem; color: #9ca3af; margin-bottom: 4px; }
.duel-side-score { font-size: 1.2rem; color: #10b981; }
.duel-sep { font-size: 0.9rem; color: #6366f1; padding: 0 8px; }

/* Duel timer ring */
.duel-timer-ring {
  position: relative;
  width: 60px;
  height: 60px;
  flex-shrink: 0;
}
.duel-timer-ring svg { transform: rotate(-90deg); }
.duel-timer-ring circle { fill: none; stroke-width: 4; }
.duel-timer-ring .bg { stroke: rgba(255,255,255,0.1); }
.duel-timer-ring .fg { stroke: #10b981; stroke-linecap: round; transition: stroke-dashoffset 0.5s, stroke 0.3s; }
.duel-timer-num {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  font-size: 0.8rem; color: #fbbf24;
}

/* Opponent status indicator */
.opponent-typing {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.55rem;
  color: #9ca3af;
  padding: 6px 10px;
  background: rgba(99,102,241,0.1);
  border-radius: 8px;
  margin: 5px 0;
}
.dot-bounce { display: inline-flex; gap: 3px; }
.dot-bounce span {
  width: 5px; height: 5px; border-radius: 50%;
  background: #6366f1;
  animation: dotBounce 1.2s infinite;
}
.dot-bounce span:nth-child(2) { animation-delay: 0.2s; }
.dot-bounce span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dotBounce {
  0%,80%,100% { transform: translateY(0); }
  40% { transform: translateY(-6px); }
}

/* Challenge notification */
.challenge-notif {
  position: fixed;
  bottom: 80px;
  right: 20px;
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  border: 3px solid #fbbf24;
  border-radius: 16px;
  padding: 16px 20px;
  z-index: 15000;
  max-width: 300px;
  box-shadow: 0 0 30px rgba(99,102,241,0.6);
  animation: slideInRight 0.4s cubic-bezier(0.34,1.56,0.64,1);
  font-family: 'Press Start 2P', cursive;
}
@keyframes slideInRight {
  from { transform: translateX(120%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Rooms list */
.room-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  background: rgba(0,0,0,0.5);
  border: 2px solid rgba(99,102,241,0.3);
  border-radius: 12px;
  margin: 8px 0;
  cursor: pointer;
  transition: all 0.3s;
}
.room-card:hover { border-color: #6366f1; background: rgba(99,102,241,0.1); transform: translateX(4px); }
.room-card.full { opacity: 0.5; cursor: not-allowed; }
.room-status { display: flex; align-items: center; gap: 6px; font-size: 0.55rem; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; }
.status-dot.open { background: #10b981; box-shadow: 0 0 6px #10b981; animation: dotPulse 1.5s infinite; }
.status-dot.full { background: #ef4444; }
.status-dot.playing { background: #f59e0b; }
@keyframes dotPulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

/* Result screen */
.result-bar {
  height: 20px;
  border-radius: 10px;
  transition: width 1s cubic-bezier(0.34,1.1,0.64,1);
  min-width: 4px;
}
.confetti-piece {
  position: fixed;
  width: 10px; height: 10px;
  border-radius: 2px;
  pointer-events: none;
  z-index: 19000;
  animation: confettiFall linear forwards;
}
@keyframes confettiFall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* Auto-save indicator */
#autosaveIndicator {
  position: fixed;
  bottom: 15px;
  right: 15px;
  background: rgba(16,185,129,0.9);
  color: white;
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 0.5rem;
  z-index: 9999;
  opacity: 0;
  -webkit-transition: opacity 0.4s;
  -moz-transition: opacity 0.4s;
  -o-transition: opacity 0.4s;
  transition: opacity 0.4s;
  pointer-events: none;
}
#autosaveIndicator.show { opacity: 1; }
</style>
</head>
<body>

<!-- AUTO-SAVE INDICATOR -->
<div id="autosaveIndicator">‚öôÔ∏è...</div>

<!-- INDICATEUR MUSICAL -->
<div id="musicIndicator">
  <div class="music-bars">
    <div class="music-bar" style="height:8px;"></div>
    <div class="music-bar" style="height:5px;"></div>
    <div class="music-bar" style="height:10px;"></div>
    <div class="music-bar" style="height:4px;"></div>
  </div>
  <span id="musicIndicatorLabel">üéµ</span>
  <button onclick="MUSIC.stop();document.getElementById('musicIndicator').classList.remove('show');" 
    style="margin:0;padding:2px 6px;font-size:0.3rem;background:rgba(239,68,68,0.5);border:none;border-radius:8px;cursor:pointer;color:#fff;font-family:'Press Start 2P';">‚ñ†</button>
</div>

<!-- SETTINGS GEAR FIXED BUTTON -->
<div id="settingsGearBtn" style="position:fixed;top:15px;right:15px;z-index:8000;display:none;">
  <button onclick="showScreen('settingsScreen'); renderSettings();" style="margin:0;padding:8px 12px;font-size:0.9rem;border-radius:50%;width:44px;height:44px;background:rgba(0,0,0,0.7);border:2px solid #fbbf24;">‚öôÔ∏è</button>
</div>

<!-- COMBO DISPLAY -->
<div id="comboDisplay"></div>

<!-- COMBO ANNOUNCEMENT -->
<div id="comboAnnouncement"></div>

<!-- PARTICLE CONTAINER -->
<div id="particles" style="position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:9998;overflow:hidden;"></div>

<!-- ERREUR CHARGEMENT FIREBASE -->
<div id="fbLoadError" style="display:none; position:fixed; top:0; left:0; right:0; background:#dc2626; color:white; padding:15px; text-align:center; font-family:'Press Start 2P',cursive; font-size:0.65rem; z-index:99999;">
  ‚ö†Ô∏è Firebase ne se charge pas ‚Äî v√©rifie ta connexion internet et que tu n'ouvres pas le fichier en file://
  <br><span style="font-size:0.5rem; margin-top:5px; display:block;">Utilise VS Code + Live Server, ou XAMPP, ou double-clique depuis un serveur web</span>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="screen active">
  <h1 class="game-title">üéÆ SCHOOLMES üéÆ</h1>
  <p style="text-align:center; font-size:0.8rem; margin-bottom:30px; color:#9ca3af;">
    L'aventure √©ducative - 10 000 niveaux !
  </p>
  
  <div class="input-group">
    <label>üìù Pseudo</label>
    <input type="text" id="loginUsername" placeholder="Ton pseudo" onkeypress="if(event.key==='Enter') login()">
  </div>
  
  <div class="input-group">
    <label>üîê Code (min 6 caract√®res)</label>
    <input type="password" id="loginCode" placeholder="Ton code secret" onkeypress="if(event.key==='Enter') login()">
  </div>
  
  <div style="text-align:center; margin-top:30px;">
    <button class="primary" onclick="login()">üöÄ Connexion / Inscription</button>
  </div>
  
  <div id="loginFirebaseStatus" style="text-align:center; margin-top:20px; font-size:0.55rem; color:#9ca3af;">
    ‚è≥ V√©rification Firebase...
  </div>
</div>

<!-- HOME -->
<div id="homeScreen" class="screen">
  <h1 class="game-title">üè† ACCUEIL</h1>
  
  <div class="stats-bar">
    <div class="stat">
      <div class="stat-label">üë§ Joueur</div>
      <div class="home-player-header">
        <canvas id="homeAvatarCanvas" class="mini-avatar-canvas" width="40" height="40" style="display:none;"></canvas>
        <div class="stat-value" id="homeUsername">-</div>
      </div>
      <div id="homePlayerBadges"></div>
    </div>
    <div class="stat">
      <div class="stat-label">‚≠ê Niveau</div>
      <div class="stat-value" id="homeLevel">-</div>
    </div>
    <div class="stat">
      <div class="stat-label">üí∞ Pi√®ces</div>
      <div class="stat-value" id="homeCoins">-</div>
    </div>
    <div class="stat">
      <div class="stat-label">‚ú® XP</div>
      <div class="stat-value" id="homeXP">-</div>
    </div>
  </div>
  
  <div id="adminPanelHome"></div>
  
  <!-- ENERGY DISPLAY -->
  <div id="energyDisplay">
    ‚ö° √âNERGIE : <span id="energyCount">10</span>/10
    <div id="energyBar" style="flex:1;height:10px;background:rgba(0,0,0,0.5);border-radius:5px;overflow:hidden;border:1px solid #ef4444;">
      <div id="energyFill" style="height:100%;background:linear-gradient(90deg,#ef4444,#f97316);width:100%;transition:width 0.5s;"></div>
    </div>
    <span id="energyTimer" style="font-size:0.5rem;color:#9ca3af;"></span>
  </div>

  <!-- EVENT BANNER -->
  <div id="eventBanner" onclick="showEventDetails()" style="display:none;"></div>

  <!-- DAILY LOGIN REWARD -->
  <div id="dailyLoginRewardBanner" style="display:none;background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(245,158,11,0.15));border:2px solid #fbbf24;border-radius:12px;padding:15px;margin:10px 0;cursor:pointer;" onclick="openDailyRewardModal()">
    üéÅ <span style="color:#fbbf24;">CONNEXION JOURNALI√àRE</span> ‚Äî R√©cup√®re ta r√©compense !
  </div>

  <!-- DAILY QUESTS BANNER -->
  <div id="dailyQuestBanner" onclick="openQuestsModal()">
    <div style="font-size:0.7rem;color:#10b981;margin-bottom:8px;">üìã QU√äTES DU JOUR</div>
    <div id="questsPreview"></div>
  </div>
  
  <!-- Indicateur Firebase -->
  <div id="firebaseStatus" style="text-align:center; margin:15px 0; padding:10px; background:rgba(16,185,129,0.2); border-radius:10px; font-size:0.6rem; display:none;">
    <span style="color:#10b981;">üî• Connect√© √† Firebase</span>
  </div>
  
  <div style="text-align:center; margin:30px 0;">
    <button class="primary" onclick="tryStartGame()">üéÆ Jouer</button>
    <button class="gold" onclick="showScreen('shopScreen'); renderShop();">üõí Boutique</button>
    <button onclick="showScreen('avatarScreen'); initAvatarEditor();">üé® Avatar</button>
    <button style="background:linear-gradient(135deg,#6366f1,#4f46e5);" onclick="showScreen('leaderboardScreen'); renderLeaderboard();">üèÜ Classement</button>
    <button style="background:linear-gradient(135deg,#ec4899,#be185d);border:2px solid #fbbf24;" onclick="showScreen('multiplayerScreen'); initMultiplayer();">‚öîÔ∏è Multijoueur</button>
    <button style="background:linear-gradient(135deg,#10b981,#059669);" onclick="manualSave()">üíæ Sauvegarder</button>
    <button style="background:linear-gradient(135deg,#f59e0b,#d97706);" onclick="openTalentTree()">üå≥ Talents</button>
    <button style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);" onclick="openQuestsModal()">üìã Qu√™tes</button>
    <button style="background:linear-gradient(135deg,#0ea5e9,#0284c7);" onclick="showScreen('onlinePlayersScreen'); renderOnlinePlayers();">üë• Joueurs connect√©s</button>
    <button style="background:linear-gradient(135deg,#6b7280,#4b5563);" onclick="showScreen('settingsScreen'); renderSettings();">‚öôÔ∏è R√©glages</button>
    <button class="danger" onclick="logout()">üö™ D√©connexion</button>
  </div>
</div>

<!-- CLASSEMENT EN LIGNE -->
<div id="leaderboardScreen" class="screen">
  <button class="danger" onclick="showScreen('homeScreen'); updateHomeScreen();">‚¨ÖÔ∏è Retour</button>
  <h2 class="game-title">üèÜ CLASSEMENT MONDIAL</h2>
  
  <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
    <button onclick="renderLeaderboard('maxLevel')" id="lbBtnLevel" class="primary">üó∫Ô∏è Niveaux atteints</button>
    <button onclick="renderLeaderboard('level')" id="lbBtnXP">‚≠ê Niveau joueur</button>
    <button onclick="renderLeaderboard('coins')" id="lbBtnCoins" class="gold">üí∞ Pi√®ces</button>
  </div>
  
  <div id="lbLoading" style="text-align:center; padding:30px; color:#9ca3af; font-size:0.7rem;">‚è≥ Chargement...</div>
  <div class="leaderboard-online" id="leaderboardList"></div>
  <div id="myRank" style="text-align:center; margin-top:15px; font-size:0.65rem; color:#fbbf24;"></div>
</div>

<!-- JOUEURS CONNECT√âS -->
<div id="onlinePlayersScreen" class="screen">
  <button class="danger" onclick="showScreen('homeScreen'); updateHomeScreen();">‚¨ÖÔ∏è Retour</button>
  <h2 class="game-title">üë• JOUEURS</h2>
  <div style="display:flex;gap:8px;justify-content:center;margin:15px 0;flex-wrap:wrap;">
    <button id="opTabOnline" class="primary" onclick="switchOpTab('online')">üü¢ En ligne</button>
    <button id="opTabAll" onclick="switchOpTab('all')">üë• Tous les joueurs</button>
    <button onclick="renderOnlinePlayers()">üîÑ Actualiser</button>
  </div>
  <div id="onlinePlayersList" style="max-height:600px;overflow-y:auto;">
    <div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:30px;">‚è≥ Chargement...</div>
  </div>
</div>

<!-- R√âGLAGES -->
<div id="settingsScreen" class="screen">
  <button class="danger" onclick="showScreen('homeScreen'); updateHomeScreen();">‚¨ÖÔ∏è Retour</button>
  <h2 class="game-title">‚öôÔ∏è R√âGLAGES</h2>
  <div id="settingsContent"></div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen">
  <button class="danger" onclick="showScreen('homeScreen'); updateHomeScreen();">‚¨ÖÔ∏è Retour</button>
  
  <div class="stats-bar">
    <div class="stat">
      <div class="stat-label">NIVEAU JOUEUR</div>
      <div class="stat-value">‚≠ê <span id="gameLevel">-</span></div>
    </div>
    <div class="stat">
      <div class="stat-label">PI√àCES</div>
      <div class="stat-value">üí∞ <span id="gameCoins">-</span></div>
    </div>
    <div class="stat">
      <div class="stat-label">EXP√âRIENCE</div>
      <div class="stat-value" id="gameXP">-</div>
      <div class="xp-bar"><div class="xp-fill" id="xpBar">0%</div></div>
    </div>
  </div>
  
  <div id="map"></div>
</div>

<!-- QUIZ -->
<div id="quizScreen" class="screen">
  <h2 class="game-title" id="quizLevelTitle">Niveau X</h2>
  <p style="text-align:center; font-size:0.9rem; margin-bottom:20px;" id="quizBiomeInfo">-</p>
  
  <!-- TIMER -->
  <div id="timerText">‚è±Ô∏è <span id="timerCountdown">15</span>s ‚Äî R√©ponds vite pour un bonus !</div>
  <div id="timerBar"><div id="timerFill" style="width:100%;"></div></div>
  
  <!-- COMPTEUR DE VIES -->
  <div class="lives-counter">
    <div style="font-size:0.8rem; color:#fbbf24;">‚ù§Ô∏è VIES:</div>
    <div id="heartsDisplay"></div>
    <div style="font-size:0.7rem; color:#9ca3af;"><span id="errorsCount">0</span>/5 erreurs</div>
  </div>
  
  <div class="question-container">
    <div class="question-text" id="questionText">-</div>
    
    <!-- BARRE DE BONUS -->
    <div class="bonus-bar" id="bonusBar">
      <div style="font-size:0.7rem; color:#fbbf24; margin-bottom:10px; width:100%; text-align:center;">‚ú® MES BONUS ‚ú®</div>
      <!-- Les bonus seront ajout√©s ici dynamiquement -->
    </div>
    
    <!-- CHOIX MULTIPLES (QCM) -->
    <div id="choiceButtons" class="choice-buttons" style="display:none;"></div>
    
    <!-- SAISIE TEXTE -->
    <div class="input-group" id="textAnswerGroup">
      <input type="text" id="answerInput" placeholder="Ta r√©ponse..." onkeypress="if(event.key==='Enter') submitAnswer()">
    </div>
    
    <div id="quizFeedback" style="text-align:center; margin:20px 0; font-size:0.8rem;"></div>
    
    <div style="text-align:center;">
      <button class="primary" onclick="submitAnswer()">‚úÖ Valider</button>
      <button class="gold" onclick="skipQuestion()">‚è≠Ô∏è Passer (<span id="skipCost">50</span> üí∞)</button>
      <button class="danger" onclick="quitQuiz()">‚ùå Quitter</button>
    </div>
  </div>
</div>

<!-- GAME OVER -->
<div id="gameOverScreen" class="screen">
  <h1 class="game-title" style="color:#ef4444;">üíÄ GAME OVER üíÄ</h1>
  
  <div style="text-align:center; font-size:1.2rem; margin:30px 0; color:#9ca3af;">
    <p>Tu as fait 5 erreurs !</p>
    <p style="margin-top:20px; font-size:0.8rem;">Statistiques de cette partie :</p>
  </div>
  
  <div class="stats-bar">
    <div class="stat">
      <div class="stat-label">NIVEAU ATTEINT</div>
      <div class="stat-value" id="goLevel">-</div>
    </div>
    <div class="stat">
      <div class="stat-label">QUESTIONS R√âUSSIES</div>
      <div class="stat-value" id="goCorrect">-</div>
    </div>
    <div class="stat">
      <div class="stat-label">PI√àCES GAGN√âES</div>
      <div class="stat-value" id="goCoins">-</div>
    </div>
  </div>
  
  <div style="text-align:center; margin-top:30px;">
    <button class="primary" onclick="restartGame()">üîÑ Rejouer</button>
    <button class="danger" onclick="showScreen('homeScreen'); updateHomeScreen();">üè† Menu</button>
  </div>
</div>

<!-- SHOP -->
<div id="shopScreen" class="screen">
  <button class="danger" onclick="showScreen('homeScreen'); updateHomeScreen();">‚¨ÖÔ∏è Retour</button>
  
  <h2 class="game-title">üõí BOUTIQUE</h2>
  <p style="text-align:center; font-size:0.9rem; margin-bottom:20px;">üí∞ <span id="shopCoins">0</span> pi√®ces</p>
  
  <div class="shop-grid" id="shopItems"></div>
</div>

</div>

<!-- ===== MULTIJOUEUR ===== -->
<div id="multiplayerScreen" class="screen">
  <button class="danger" onclick="leaveMpLobby(); showScreen('homeScreen'); updateHomeScreen();">‚¨ÖÔ∏è Retour</button>
  <h2 class="game-title" style="color:#818cf8;">‚öîÔ∏è MULTIJOUEUR</h2>

  <!-- Firebase warning -->
  <div id="mpFirebaseWarning" style="display:none;background:rgba(239,68,68,0.15);border:2px solid #ef4444;border-radius:10px;padding:15px;text-align:center;font-size:0.6rem;color:#fca5a5;margin:15px 0;">
    ‚ö†Ô∏è Firebase requis pour le multijoueur.<br>Connecte-toi avec un compte en ligne pour jouer contre d'autres joueurs.
  </div>

  <!-- Tabs -->
  <div style="display:flex;gap:8px;justify-content:center;margin:15px 0;">
    <button id="mpTabRooms" class="primary" onclick="switchMpTab('rooms')">üè† Salons</button>
    <button id="mpTabChallenge" onclick="switchMpTab('challenge')">‚öîÔ∏è D√©fier</button>
    <button id="mpTabHistory" onclick="switchMpTab('history')">üìú Historique</button>
  </div>

  <!-- TAB: ROOMS -->
  <div id="mpTabRoomsContent">
    <div style="display:flex;gap:10px;justify-content:center;margin-bottom:15px;flex-wrap:wrap;">
      <button class="primary" onclick="createRoom()">‚ûï Cr√©er un salon</button>
      <button onclick="refreshRooms()">üîÑ Actualiser</button>
    </div>
    <div id="mpRoomsList" style="max-height:400px;overflow-y:auto;">
      <div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:20px;">‚è≥ Chargement des salons...</div>
    </div>
  </div>

  <!-- TAB: CHALLENGE -->
  <div id="mpTabChallengeContent" style="display:none;">
    <div class="pvp-lobby" style="text-align:center;">
      <div style="font-size:0.7rem;color:#fbbf24;margin-bottom:15px;">‚öîÔ∏è D√âFIER UN JOUEUR EN LIGNE</div>
      <div id="mpOnlineList" style="max-height:300px;overflow-y:auto;margin-bottom:15px;">
        <div style="color:#9ca3af;font-size:0.6rem;padding:20px;">‚è≥ Recherche des joueurs en ligne...</div>
      </div>
    </div>
  </div>

  <!-- TAB: HISTORY -->
  <div id="mpTabHistoryContent" style="display:none;">
    <div id="mpHistory" style="max-height:400px;overflow-y:auto;">
      <div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:20px;">Aucune partie jou√©e encore.</div>
    </div>
  </div>
</div>

<!-- ===== DUEL SCREEN ===== -->
<div id="duelScreen" class="screen">
  <!-- HUD with both players -->
  <div class="duel-hud">
    <div class="duel-side" id="duelMySide">
      <div class="duel-side-name" id="duelMyName">-</div>
      <div class="duel-side-score" id="duelMyScore">0</div>
      <div style="font-size:0.45rem;color:#9ca3af;" id="duelMyCorrect">0 corrects</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
      <div class="duel-timer-ring" id="duelTimerRing">
        <svg width="60" height="60" viewBox="0 0 60 60">
          <circle class="bg" cx="30" cy="30" r="26"/>
          <circle class="fg" id="duelTimerCircle" cx="30" cy="30" r="26" stroke-dasharray="163" stroke-dashoffset="0"/>
        </svg>
        <div class="duel-timer-num" id="duelTimerNum">20</div>
      </div>
      <div style="font-size:0.5rem;color:#6366f1;" id="duelRoundInfo">Q 1/10</div>
    </div>
    <div class="duel-side" id="duelOppSide" style="text-align:right;">
      <div class="duel-side-name" id="duelOppName">-</div>
      <div class="duel-side-score" id="duelOppScore">0</div>
      <div style="font-size:0.45rem;color:#9ca3af;" id="duelOppCorrect">0 corrects</div>
    </div>
  </div>

  <!-- Question -->
  <div class="question-container">
    <div style="font-size:0.55rem;color:#6366f1;margin-bottom:8px;" id="duelBiome">-</div>
    <div class="question-text" id="duelQuestion">-</div>

    <!-- Opponent status -->
    <div class="opponent-typing" id="duelOppStatus">
      <span>L'adversaire r√©fl√©chit</span>
      <div class="dot-bounce"><span></span><span></span><span></span></div>
    </div>

    <!-- QCM choices -->
    <div id="duelChoices" class="choice-buttons" style="display:none;"></div>

    <!-- Text input -->
    <div id="duelTextGroup" class="input-group">
      <input type="text" id="duelAnswerInput" placeholder="Ta r√©ponse..." onkeypress="if(event.key==='Enter') submitDuelAnswer()">
    </div>

    <div id="duelFeedback" style="text-align:center;margin:15px 0;font-size:0.8rem;min-height:40px;"></div>

    <div style="text-align:center;">
      <button class="primary" id="duelSubmitBtn" onclick="submitDuelAnswer()">‚úÖ R√©pondre</button>
      <button class="danger" onclick="confirmAbandonDuel()">üè≥Ô∏è Abandonner</button>
    </div>
  </div>
</div>

<!-- ===== DUEL RESULT SCREEN ===== -->
<div id="duelResultScreen" class="screen">
  <h1 class="game-title" id="duelResultTitle">R√âSULTAT</h1>

  <div style="display:flex;flex-direction:column;gap:12px;margin:25px 0;" id="duelResultCards"></div>

  <div id="duelRewardsBox" style="background:rgba(16,185,129,0.1);border:2px solid #10b981;border-radius:12px;padding:15px;text-align:center;margin:15px 0;font-size:0.65rem;"></div>

  <div style="text-align:center;margin-top:25px;">
    <button class="primary" onclick="showScreen('multiplayerScreen'); initMultiplayer();">üîÑ Rejouer</button>
    <button class="gold" onclick="showScreen('homeScreen'); updateHomeScreen();">üè† Menu</button>
  </div>
</div>

<!-- AVATAR -->
<div id="avatarScreen" class="screen">
  <button class="danger" onclick="showScreen('homeScreen'); updateHomeScreen();">‚¨ÖÔ∏è Retour</button>
  
  <h2 class="game-title">üé® √âDITEUR D'AVATAR</h2>
  
  <div class="pixel-grid" id="pixelGrid"></div>
  
  <div class="color-palette" id="colorPalette"></div>
  
  <div style="text-align:center; margin-top:20px;">
    <button class="primary" onclick="saveAvatar()">üíæ Sauvegarder</button>
    <button onclick="randomAvatar()">üé≤ Al√©atoire</button>
    <button class="danger" onclick="clearAvatar()">üóëÔ∏è Effacer</button>
  </div>
</div>

<script>
// ========================================
// FIREBASE CONFIGURATION
// ========================================
// ‚ö†Ô∏è IMPORTANT: Remplace ces valeurs par ta propre configuration Firebase
// Tu peux obtenir ces informations depuis la console Firebase:
// https://console.firebase.google.com/ > Param√®tres du projet > Applications

// ========================================
// ‚öôÔ∏è COLLE TA CONFIG FIREBASE ICI
// Console Firebase ‚Üí Param√®tres ‚Üí Tes applications ‚Üí Config
// ========================================
const firebaseConfig = {


¬† apiKey: "AIzaSyAf0oJHNukISOzRkgjAFNPbR_irvyXeDyM",


¬† authDomain: "schoolmes-games.firebaseapp.com",


¬† databaseURL: "https://schoolmes-games-default-rtdb.europe-west1.firebasedatabase.app",


¬† projectId: "schoolmes-games",


¬† storageBucket: "schoolmes-games.firebasestorage.app",


¬† messagingSenderId: "623068569178",


¬† appId: "1:623068569178:web:657b9188d85d7ae89c8263"


};
// ========================================

// Initialiser Firebase de fa√ßon s√©curis√©e
let database = null;
let auth = null;
let firebaseReady = false;
let currentUserId = null;

function initFirebase() {
  const statusEl = document.getElementById('loginFirebaseStatus');
  const setStatus = (msg, color) => {
    if (statusEl) statusEl.innerHTML = '<span style="color:' + color + ';">' + msg + '</span>';
  };

  // Scripts non charg√©s ?
  if (typeof firebase === "undefined" || window._fbCDNFailed) {
    console.error("‚ùå Scripts Firebase non charg√©s ‚Äî Internet requis, ou ouvre via un serveur (pas double-clic)");
    setStatus("‚ùå Firebase non charg√© ‚Äî v√©rifie ta connexion internet", "#ef4444");
    firebaseReady = false;
    return;
  }

  try {
    // √âviter double init si rechargement
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    database = firebase.database();
    auth = firebase.auth();
    firebaseReady = true;
    console.log("‚úÖ Firebase initialis√©:", firebaseConfig.projectId);
    setStatus("üî• Firebase pr√™t ‚Äî connecte-toi !", "#10b981");

    // Surveiller l'√©tat de connexion + restauration de session
    auth.onAuthStateChanged(async (user) => {
      const loginScreen = document.getElementById('loginScreen');
      const isOnLogin = loginScreen && loginScreen.classList.contains('active');
      if (user && !player && !currentUserId) {
        // Session Firebase persistante d√©tect√©e (rechargement de page)
        // On d√©connecte pour forcer une reconnexion manuelle (s√©curit√©)
        auth.signOut();
        if (isOnLogin) setStatus("üî• Firebase pr√™t ‚Äî reconnecte-toi !", "#10b981");
      } else if (isOnLogin) {
        if (user) {
          setStatus("üî• Firebase connect√© ‚úì", "#10b981");
        } else {
          setStatus("üî• Firebase pr√™t ‚Äî connecte-toi !", "#10b981");
        }
      }
    });

  } catch(e) {
    console.error("‚ùå Firebase ERREUR:", e.message);
    setStatus("‚ùå Erreur Firebase: " + e.message, "#ef4444");
    firebaseReady = false;
  }
}

// ========================================
// GLOBALS
// ========================================
let player = null;
let currentLevel = 1;
let currentQuestion = null;
let skipCost = 50;
let pixelData = [];
let selectedColor = '#ff0000';

// NOUVEAUX: pour le syst√®me d'erreurs
let sessionErrors = 0;
let sessionCorrect = 0;
let sessionCoinsStart = 0;
let failedQuestions = new Set(); // Questions d√©j√† rat√©es (ne pas les proposer √† nouveau)

const GRID_SIZE = 16;
const COLORS = ['#000000', '#ffffff', '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#800080', '#ff69b4', '#8b4513'];

const BIOMES = [
  { range: [1, 1000], name: 'Plaines', emoji: 'üåæ', class: 'plains' },
  { range: [1001, 2000], name: 'For√™t', emoji: 'üå≤', class: 'forest' },
  { range: [2001, 3000], name: 'D√©sert', emoji: 'üèúÔ∏è', class: 'desert' },
  { range: [3001, 4000], name: 'Neige', emoji: '‚ùÑÔ∏è', class: 'snow' },
  { range: [4001, 5000], name: 'Volcan', emoji: 'üåã', class: 'volcano' },
  { range: [5001, 10000], name: 'Oc√©an', emoji: 'üåä', class: 'ocean' }
];

const SHOP_ITEMS = [
  // ---- CONSOMMABLES ----
  { id: 1,  emoji: 'üí°', name: 'Indice',          desc: 'R√©v√®le une lettre de la r√©ponse',      price: 100,  category: 'üéí Consommables' },
  { id: 2,  emoji: '‚è≠Ô∏è', name: 'Passer √ó1',       desc: 'Passe 1 question gratuitement',        price: 150,  category: 'üéí Consommables' },
  { id: 3,  emoji: 'üîÑ', name: '2√®me Chance',      desc: 'Efface une erreur (1 vie recup√©r√©e)',  price: 200,  category: 'üéí Consommables' },
  { id: 8,  emoji: 'üí°', name: 'Pack 3 Indices',   desc: '3 indices en une fois',               price: 250,  category: 'üéí Consommables' },
  { id: 9,  emoji: '‚è≠Ô∏è', name: 'Pack 3 Passes',    desc: '3 passes en une fois',                price: 400,  category: 'üéí Consommables' },
  { id: 10, emoji: 'üîÑ', name: 'Pack 3 Chances',   desc: '3 secondes chances en une fois',      price: 550,  category: 'üéí Consommables' },
  { id: 11, emoji: 'üõ°Ô∏è', name: 'Bouclier',         desc: 'Bloque la prochaine erreur',          price: 350,  category: 'üéí Consommables' },
  { id: 12, emoji: 'üéØ', name: 'Viseur',           desc: '√âlimine 2 mauvais choix (QCM)',       price: 175,  category: 'üéí Consommables' },
  { id: 13, emoji: '‚è≥', name: 'Gel du temps',     desc: 'G√®le 1 erreur (ne compte pas)',       price: 300,  category: 'üéí Consommables' },
  // ---- PI√àCES & XP ----

  { id: 5,  emoji: '‚ö°', name: 'Boost XP √ó2',      desc: 'Double XP pendant 10 questions',      price: 300,  category: 'üí∞ Pi√®ces & XP' },
  { id: 16, emoji: 'üåü', name: 'Boost XP √ó3',      desc: 'Triple XP pendant 10 questions',      price: 700,  category: 'üí∞ Pi√®ces & XP' },
  { id: 17, emoji: 'üí∏', name: 'Bonus Pi√®ces √ó2',  desc: 'Double pi√®ces pendant 20 questions',  price: 500,  category: 'üí∞ Pi√®ces & XP' },
  // ---- BADGES ----
  { id: 6,  emoji: 'üéì', name: 'Badge √âlite',      desc: 'Badge exclusif affich√© sur ton profil', price: 1000, category: 'üèÖ Badges' },
  { id: 7,  emoji: 'üëë', name: 'Badge L√©gende',    desc: 'Le badge ultime des champions',       price: 5000, category: 'üèÖ Badges' },
  { id: 18, emoji: 'üî•', name: 'Badge Flamme',     desc: 'Tu es en feu !',                      price: 800,  category: 'üèÖ Badges' },
  { id: 19, emoji: '‚öîÔ∏è', name: 'Badge Guerrier',   desc: 'Brave comme un chevalier',            price: 1200, category: 'üèÖ Badges' },
  { id: 20, emoji: 'üåà', name: 'Badge Arc-en-ciel', desc: 'Pour les esprits color√©s',           price: 900,  category: 'üèÖ Badges' },
  { id: 21, emoji: 'ü¶Ñ', name: 'Badge Licorne',    desc: 'Rare et magique',                     price: 2500, category: 'üèÖ Badges' },
  { id: 22, emoji: 'üß†', name: 'Badge G√©nie',      desc: 'Pour les cerveaux hors-norme',        price: 3000, category: 'üèÖ Badges' },
  { id: 23, emoji: 'üèÜ', name: 'Badge Champion',   desc: 'Pour les vrais vainqueurs',           price: 4000, category: 'üèÖ Badges' },
  // ---- SP√âCIAUX ----
  { id: 24, emoji: 'üé≤', name: 'Loterie',          desc: 'Tente ta chance : 50‚Äì2000 pi√®ces',    price: 100,  category: '‚ú® Sp√©ciaux' },
  { id: 25, emoji: 'üì¶', name: 'Coffre Myst√®re',   desc: 'Contient un bonus surprise !',        price: 250,  category: '‚ú® Sp√©ciaux' },
  { id: 26, emoji: 'üéÅ', name: 'Mega Coffre',      desc: 'Coffre premium = gros bonus',         price: 600,  category: '‚ú® Sp√©ciaux' },
  { id: 27, emoji: '‚ôªÔ∏è', name: 'Reset Erreurs',    desc: 'Remet √† 0 tes erreurs de session',   price: 1500, category: '‚ú® Sp√©ciaux' },
  { id: 28, emoji: '‚ö°', name: 'Recharge √ânergie', desc: 'Restaure 5 points d\'√©nergie',         price: 200,  category: '‚ú® Sp√©ciaux' },
  { id: 29, emoji: '‚ö°', name: '√ânergie Compl√®te', desc: 'Restaure toute ton √©nergie (10/10)',   price: 400,  category: '‚ú® Sp√©ciaux' },
];

// QUESTIONS (adapt√©es pour validation flexible)
function generateQuestion(level) {
  const isBoss = level % 100 === 0;
  
  // V√©rifier si cette question a d√©j√† √©t√© rat√©e
  let questionData;
  let attempts = 0;
  do {
    questionData = getQuestionForLevel(level, isBoss);
    attempts++;
  } while (failedQuestions.has(questionData.id) && attempts < 10);
  
  return questionData;
}

// QUESTIONS ‚Äî SYST√àME G√âN√âRATEUR 10 000 QUESTIONS
function getQuestionForLevel(level, isBoss) {
  // S√©lection al√©atoire de mati√®re avec progression de difficult√©
  // Toutes les mati√®res disponibles par niveau de difficult√©
  const allSubjects = ['math', 'geo', 'sciences', 'culture', 'histoire', 'sports', 'langues'];
  
  // Plus le niveau est √©lev√©, plus les questions difficiles apparaissent souvent
  const difficultyLevel = Math.min(10, Math.floor(level / 1000) + 1);
  
  // Questions tri√©es par difficult√©
  const easySubjects = ['culture', 'sports', 'langues'];
  const mediumSubjects = ['math', 'geo'];
  const hardSubjects = ['sciences', 'histoire'];
  
  // Probabilit√©s selon le niveau
  let subjectPool;
  if (difficultyLevel <= 2) {
    subjectPool = [...easySubjects, ...easySubjects, ...mediumSubjects]; // Surtout facile
  } else if (difficultyLevel <= 5) {
    subjectPool = [...easySubjects, ...mediumSubjects, ...mediumSubjects, ...hardSubjects]; // Mixte
  } else if (difficultyLevel <= 8) {
    subjectPool = [...mediumSubjects, ...hardSubjects, ...hardSubjects, 'math']; // Difficile
  } else {
    subjectPool = [...hardSubjects, 'math', 'sciences', 'geo', 'histoire']; // Tr√®s difficile
  }
  
  // S√©lection al√©atoire de la mati√®re (diff√©rente de la derni√®re utilis√©e)
  let chosenSubject;
  do {
    chosenSubject = subjectPool[Math.floor(Math.random() * subjectPool.length)];
  } while (chosenSubject === window._lastQuestionSubject && subjectPool.length > 1);
  window._lastQuestionSubject = chosenSubject;

  const questionBank = {
    // MATH√âMATIQUES (2000 questions)
    math: {
      additions: Array.from({length: 200}, (_, i) => {
        const a = Math.floor(Math.random() * 50) + 1;
        const b = Math.floor(Math.random() * 50) + 1;
        return { type: 'text', question: `Combien font ${a} + ${b} ?`, answer: String(a + b) };
      }),
      soustractions: Array.from({length: 200}, (_, i) => {
        const a = Math.floor(Math.random() * 100) + 10;
        const b = Math.floor(Math.random() * a);
        return { type: 'text', question: `Combien font ${a} - ${b} ?`, answer: String(a - b) };
      }),
      multiplications: Array.from({length: 200}, (_, i) => {
        const a = Math.floor(Math.random() * 15) + 1;
        const b = Math.floor(Math.random() * 15) + 1;
        return { type: 'text', question: `Combien font ${a} √ó ${b} ?`, answer: String(a * b) };
      }),
      divisions: Array.from({length: 200}, (_, i) => {
        const b = Math.floor(Math.random() * 12) + 1;
        const result = Math.floor(Math.random() * 20) + 1;
        const a = b * result;
        return { type: 'text', question: `Combien font ${a} √∑ ${b} ?`, answer: String(result) };
      }),
      geometrie: [
        { type: 'qcm', question: 'Combien de c√¥t√©s a un triangle ?', choices: ['2', '3', '4', '5'], answer: '3' },
        { type: 'qcm', question: 'Combien de c√¥t√©s a un carr√© ?', choices: ['3', '4', '5', '6'], answer: '4' },
        { type: 'qcm', question: 'Combien de c√¥t√©s a un pentagone ?', choices: ['4', '5', '6', '7'], answer: '5' },
        { type: 'qcm', question: 'Combien de c√¥t√©s a un hexagone ?', choices: ['5', '6', '7', '8'], answer: '6' },
        { type: 'qcm', question: 'Combien de c√¥t√©s a un octogone ?', choices: ['6', '7', '8', '9'], answer: '8' },
        { type: 'qcm', question: 'Combien de degr√©s dans un angle droit ?', choices: ['45', '60', '90', '180'], answer: '90' },
        { type: 'qcm', question: 'Combien de degr√©s dans un cercle complet ?', choices: ['180', '270', '360', '400'], answer: '360' },
        { type: 'text', question: 'Combien de faces a un cube ?', answer: '6' },
        { type: 'text', question: 'Combien d\'ar√™tes a un cube ?', answer: '12' },
        { type: 'text', question: 'Combien de sommets a un cube ?', answer: '8' }
      ]
    },

    // G√âOGRAPHIE (2000 questions)
    geo: {
      capitales: [
        { type: 'qcm', question: 'Capitale de la France ?', choices: ['Lyon', 'Marseille', 'Paris', 'Bordeaux'], answer: 'Paris' },
        { type: 'qcm', question: 'Capitale de l\'Italie ?', choices: ['Milan', 'Rome', 'Venise', 'Florence'], answer: 'Rome' },
        { type: 'qcm', question: 'Capitale de l\'Espagne ?', choices: ['Barcelone', 'S√©ville', 'Madrid', 'Valence'], answer: 'Madrid' },
        { type: 'qcm', question: 'Capitale de l\'Allemagne ?', choices: ['Munich', 'Hambourg', 'Francfort', 'Berlin'], answer: 'Berlin' },
        { type: 'qcm', question: 'Capitale du Royaume-Uni ?', choices: ['Manchester', 'Londres', '√âdimbourg', 'Liverpool'], answer: 'Londres' },
        { type: 'text', question: 'Capitale des √âtats-Unis ?', answer: 'washington' },
        { type: 'text', question: 'Capitale du Canada ?', answer: 'ottawa' },
        { type: 'text', question: 'Capitale de l\'Australie ?', answer: 'canberra' },
        { type: 'text', question: 'Capitale du Japon ?', answer: 'tokyo' },
        { type: 'text', question: 'Capitale de la Chine ?', answer: 'pekin' },
        { type: 'text', question: 'Capitale de l\'Inde ?', answer: 'newdelhi' },
        { type: 'text', question: 'Capitale du Br√©sil ?', answer: 'brasilia' },
        { type: 'text', question: 'Capitale du Mexique ?', answer: 'mexico' },
        { type: 'text', question: 'Capitale de l\'Argentine ?', answer: 'buenosaires' },
        { type: 'text', question: 'Capitale de la Russie ?', answer: 'moscou' }
      ],
      pays: [
        { type: 'qcm', question: 'Pays de la tour Eiffel ?', choices: ['Belgique', 'Suisse', 'France', 'Luxembourg'], answer: 'France' },
        { type: 'qcm', question: 'Pays de la pizza ?', choices: ['France', 'Espagne', 'Gr√®ce', 'Italie'], answer: 'Italie' },
        { type: 'qcm', question: 'Pays des pyramides ?', choices: ['Mexique', '√âgypte', 'P√©rou', 'Chine'], answer: '√âgypte' },
        { type: 'qcm', question: 'Pays du carnaval de Rio ?', choices: ['Argentine', 'Chili', 'Br√©sil', 'Colombie'], answer: 'Br√©sil' },
        { type: 'qcm', question: 'Pays du Taj Mahal ?', choices: ['Pakistan', 'Bangladesh', 'Inde', 'N√©pal'], answer: 'Inde' }
      ],
      oceans: [
        { type: 'qcm', question: 'Plus grand oc√©an du monde ?', choices: ['Atlantique', 'Pacifique', 'Indien', 'Arctique'], answer: 'Pacifique' },
        { type: 'qcm', question: 'Oc√©an entre Europe et Am√©rique ?', choices: ['Pacifique', 'Indien', 'Atlantique', 'Arctique'], answer: 'Atlantique' },
        { type: 'text', question: 'Combien y a-t-il de continents ?', answer: '7' },
        { type: 'text', question: 'Continent le plus grand ?', answer: 'asie' },
        { type: 'text', question: 'Continent le plus petit ?', answer: 'oceanie' }
      ]
    },

    // SCIENCES (2000 questions)
    sciences: {
      astronomie: [
        { type: 'qcm', question: 'Plan√®te la plus proche du Soleil ?', choices: ['V√©nus', 'Mercure', 'Mars', 'Terre'], answer: 'Mercure' },
        { type: 'qcm', question: 'Plus grosse plan√®te du syst√®me solaire ?', choices: ['Saturne', 'Neptune', 'Jupiter', 'Uranus'], answer: 'Jupiter' },
        { type: 'qcm', question: 'Plan√®te surnomm√©e la plan√®te rouge ?', choices: ['V√©nus', 'Mars', 'Jupiter', 'Saturne'], answer: 'Mars' },
        { type: 'qcm', question: 'Plan√®te avec des anneaux visibles ?', choices: ['Jupiter', 'Saturne', 'Uranus', 'Neptune'], answer: 'Saturne' },
        { type: 'text', question: 'Combien de plan√®tes dans le syst√®me solaire ?', answer: '8' },
        { type: 'text', question: '√âtoile la plus proche de la Terre ?', answer: 'soleil' },
        { type: 'text', question: 'Satellite naturel de la Terre ?', answer: 'lune' }
      ],
      corps_humain: [
        { type: 'qcm', question: 'Organe qui pompe le sang ?', choices: ['Poumon', 'Foie', 'C≈ìur', 'Estomac'], answer: 'C≈ìur' },
        { type: 'qcm', question: 'Plus grand organe du corps ?', choices: ['Foie', 'Peau', 'Cerveau', 'Poumon'], answer: 'Peau' },
        { type: 'text', question: 'Combien d\'os dans le corps humain ?', answer: '206' },
        { type: 'text', question: 'Combien de dents a un adulte ?', answer: '32' },
        { type: 'qcm', question: 'Quel organe filtre le sang ?', choices: ['Foie', 'Rein', 'Rate', 'Pancr√©as'], answer: 'Rein' }
      ],
      chimie: [
        { type: 'qcm', question: 'Formule chimique de l\'eau ?', choices: ['H2O', 'CO2', 'O2', 'H2O2'], answer: 'H2O' },
        { type: 'qcm', question: 'Gaz que nous respirons ?', choices: ['Azote', 'Oxyg√®ne', 'CO2', 'Hydrog√®ne'], answer: 'Oxyg√®ne' },
        { type: 'text', question: '√Ä quelle temp√©rature l\'eau bout-elle (¬∞C) ?', answer: '100' },
        { type: 'text', question: '√Ä quelle temp√©rature l\'eau g√®le-t-elle (¬∞C) ?', answer: '0' }
      ]
    },

    // CULTURE G√âN√âRALE (2000 questions)
    culture: {
      animaux: [
        { type: 'qcm', question: 'Animal qui miaule ?', choices: ['Chien', 'Chat', 'Souris', 'Lapin'], answer: 'Chat' },
        { type: 'qcm', question: 'Animal qui aboie ?', choices: ['Chat', 'Loup', 'Chien', 'Renard'], answer: 'Chien' },
        { type: 'qcm', question: 'Animal le plus rapide du monde ?', choices: ['Lion', 'Gu√©pard', 'L√©opard', 'Tigre'], answer: 'Gu√©pard' },
        { type: 'qcm', question: 'Plus grand animal du monde ?', choices: ['√âl√©phant', 'Requin', 'Baleine bleue', 'Girafe'], answer: 'Baleine bleue' },
        { type: 'text', question: 'Combien de pattes a une araign√©e ?', answer: '8' },
        { type: 'text', question: 'Combien de pattes a un insecte ?', answer: '6' },
        { type: 'qcm', question: 'Animal qui pond des ≈ìufs et allaite ?', choices: ['Kangourou', 'Ornithorynque', '√âchidn√©', 'Koala'], answer: 'Ornithorynque' }
      ],
      fruits: [
        { type: 'qcm', question: 'Fruit jaune courb√© ?', choices: ['Mangue', 'Ananas', 'Banane', 'Citron'], answer: 'Banane' },
        { type: 'qcm', question: 'Fruit orange rond ?', choices: ['Pamplemousse', 'Orange', 'Mandarine', 'Cl√©mentine'], answer: 'Orange' },
        { type: 'text', question: 'Fruit rouge rond ?', answer: 'pomme' },
        { type: 'text', question: 'Fruit d\'√©t√© vert dehors, rouge dedans ?', answer: 'pasteque' }
      ],
      couleurs: [
        { type: 'qcm', question: 'Couleur du ciel ?', choices: ['Vert', 'Bleu', 'Gris', 'Blanc'], answer: 'Bleu' },
        { type: 'qcm', question: 'Couleur du soleil ?', choices: ['Blanc', 'Orange', 'Jaune', 'Rouge'], answer: 'Jaune' },
        { type: 'text', question: 'Couleur de l\'herbe ?', answer: 'vert' },
        { type: 'text', question: 'Couleur de la neige ?', answer: 'blanc' },
        { type: 'qcm', question: 'Couleur m√©lange bleu + jaune ?', choices: ['Violet', 'Vert', 'Orange', 'Rose'], answer: 'Vert' }
      ],
      temps: [
        { type: 'qcm', question: 'Combien de jours dans une semaine ?', choices: ['5', '6', '7', '8'], answer: '7' },
        { type: 'qcm', question: 'Combien de mois dans une ann√©e ?', choices: ['10', '11', '12', '13'], answer: '12' },
        { type: 'text', question: 'Combien d\'heures dans une journ√©e ?', answer: '24' },
        { type: 'text', question: 'Combien de minutes dans une heure ?', answer: '60' },
        { type: 'text', question: 'Combien de secondes dans une minute ?', answer: '60' }
      ]
    },

    // HISTOIRE (1000 questions)
    histoire: [
      { type: 'qcm', question: 'Ann√©e de la R√©volution fran√ßaise ?', choices: ['1789', '1799', '1815', '1830'], answer: '1789' },
      { type: 'qcm', question: 'Qui a d√©couvert l\'Am√©rique ?', choices: ['Magellan', 'Colomb', 'Vespucci', 'Cort√©s'], answer: 'Colomb' },
      { type: 'qcm', question: 'Premi√®re Guerre mondiale ann√©e d√©but ?', choices: ['1912', '1914', '1916', '1918'], answer: '1914' },
      { type: 'text', question: 'En quelle ann√©e l\'homme a march√© sur la Lune ?', answer: '1969' },
      { type: 'qcm', question: 'Qui a peint la Joconde ?', choices: ['Picasso', 'Vinci', 'Michel-Ange', 'Rapha√´l'], answer: 'Vinci' }
    ],

    // SPORTS (1000 questions)
    sports: [
      { type: 'qcm', question: 'Sport avec ballon rond et buts ?', choices: ['Rugby', 'Football', 'Handball', 'Basketball'], answer: 'Football' },
      { type: 'qcm', question: 'Sport avec panier et ballon orange ?', choices: ['Volleyball', 'Handball', 'Basketball', 'Football'], answer: 'Basketball' },
      { type: 'text', question: 'Combien de joueurs dans une √©quipe de foot ?', answer: '11' },
      { type: 'qcm', question: 'Sport avec raquette et volant ?', choices: ['Tennis', 'Ping-pong', 'Badminton', 'Squash'], answer: 'Badminton' },
      { type: 'qcm', question: 'Sport de combat japonais ?', choices: ['Karat√©', 'Judo', 'Taekwondo', 'Kung-fu'], answer: 'Judo' }
    ],

    // LANGUES (1000 questions)
    langues: [
      { type: 'qcm', question: 'Langue parl√©e en Espagne ?', choices: ['Portugais', 'Italien', 'Espagnol', 'Catalan'], answer: 'Espagnol' },
      { type: 'qcm', question: 'Langue parl√©e en Allemagne ?', choices: ['Anglais', 'N√©erlandais', 'Allemand', 'Su√©dois'], answer: 'Allemand' },
      { type: 'text', question: 'Langue parl√©e au Japon ?', answer: 'japonais' },
      { type: 'text', question: 'Langue parl√©e en Chine ?', answer: 'chinois' },
      { type: 'text', question: 'Langue parl√©e en Italie ?', answer: 'italien' }
    ]
  };

  // (questions s√©lectionn√©es dynamiquement ci-dessus)

  // Construire le pool de questions pour la mati√®re choisie avec g√©n√©ration dynamique selon niveau
  let pool = [];
  
  // Param√®tres de difficult√© math√©matique selon le niveau
  const mathMax = Math.min(200, 10 + level * 2);
  const multiMax = Math.min(30, 5 + Math.floor(level / 10));
  
  if (chosenSubject === 'math') {
    // Additions simples niveau bas, puis plus complexe
    if (difficultyLevel <= 3) {
      for (let i = 0; i < 50; i++) {
        const a = Math.floor(Math.random() * mathMax) + 1;
        const b = Math.floor(Math.random() * mathMax) + 1;
        pool.push({ type: 'text', question: `Combien font ${a} + ${b} ?`, answer: String(a + b) });
      }
      for (let i = 0; i < 30; i++) {
        const a = Math.floor(Math.random() * 50) + 10;
        const b = Math.floor(Math.random() * a);
        pool.push({ type: 'text', question: `Combien font ${a} - ${b} ?`, answer: String(a - b) });
      }
      pool.push(...questionBank.math.geometrie);
    } else if (difficultyLevel <= 6) {
      for (let i = 0; i < 50; i++) {
        const a = Math.floor(Math.random() * multiMax) + 1;
        const b = Math.floor(Math.random() * multiMax) + 1;
        pool.push({ type: 'text', question: `Combien font ${a} √ó ${b} ?`, answer: String(a * b) });
      }
      for (let i = 0; i < 30; i++) {
        const b = Math.floor(Math.random() * 12) + 1;
        const r = Math.floor(Math.random() * 20) + 1;
        pool.push({ type: 'text', question: `Combien font ${b * r} √∑ ${b} ?`, answer: String(r) });
      }
      pool.push(...questionBank.math.geometrie);
    } else {
      // Niveau avanc√©: tout m√©lang√©
      pool.push(...questionBank.math.geometrie);
      for (let i = 0; i < 30; i++) {
        const a = Math.floor(Math.random() * 500) + 100;
        const b = Math.floor(Math.random() * a);
        pool.push({ type: 'text', question: `Combien font ${a} - ${b} ?`, answer: String(a - b) });
        const c = Math.floor(Math.random() * 25) + 1;
        const d = Math.floor(Math.random() * 25) + 1;
        pool.push({ type: 'text', question: `Combien font ${c} √ó ${d} ?`, answer: String(c * d) });
      }
    }
  } else if (chosenSubject === 'geo') {
    pool.push(...questionBank.geo.capitales, ...questionBank.geo.pays, ...questionBank.geo.oceans);
  } else if (chosenSubject === 'sciences') {
    pool.push(...questionBank.sciences.astronomie, ...questionBank.sciences.corps_humain, ...questionBank.sciences.chimie);
  } else if (chosenSubject === 'culture') {
    pool.push(...questionBank.culture.animaux, ...questionBank.culture.fruits, ...questionBank.culture.couleurs, ...questionBank.culture.temps);
  } else if (chosenSubject === 'histoire') {
    pool.push(...questionBank.histoire);
  } else if (chosenSubject === 'sports') {
    pool.push(...questionBank.sports);
  } else if (chosenSubject === 'langues') {
    pool.push(...questionBank.langues);
  }
  
  if (pool.length === 0) pool = [...questionBank.culture.animaux];
  
  // Boss: questions plus difficiles
  if (isBoss) {
    const hardPool = [
      ...questionBank.sciences.astronomie,
      ...questionBank.sciences.chimie,
      ...questionBank.histoire,
      ...questionBank.math.geometrie
    ];
    pool = hardPool.length > 0 ? hardPool : pool;
  }
  
  const q = pool[Math.floor(Math.random() * pool.length)];
  return { id: `q${level}_${chosenSubject}_${Math.random()}`, ...q };
}

function getBiome(level) {
  for (let biome of BIOMES) {
    if (level >= biome.range[0] && level <= biome.range[1]) {
      return biome;
    }
  }
  return BIOMES[BIOMES.length - 1];
}

// NORMALISATION POUR VALIDATION FLEXIBLE
function normalizeText(text) {
  return text
    .toLowerCase()
    .trim()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '') // Supprime les accents
    .replace(/[^a-z0-9]/g, ''); // Garde que lettres et chiffres
}

// AUTH
async function login() {
  const username = document.getElementById('loginUsername').value.trim();
  const code = document.getElementById('loginCode').value.trim();
  
  if (!username || !code || code.length < 4) {
    alert('‚ö†Ô∏è Pseudo et code requis (min 4 caract√®res) !');
    return;
  }

  // Admins locaux (toujours en local, sans Firebase)
  const ADMINS = [
    { username: 'titi',   code: '120511', display: 'Titi'   },
    { username: 'darius', code: '#2012#', display: 'Darius' },
  ];
  const matchedAdmin = ADMINS.find(a => username.toLowerCase() === a.username && code === a.code);
  if (matchedAdmin) {
    player = {
      username: matchedAdmin.display, code: code, level: 1, xp: 0,
      coins: 999999, maxLevel: 10000, badges: ['üëë ADMIN'], isAdmin: true,
      inventory: { hints: 999, skips: 999, secondChances: 999, xpBoost: 999 },
      avatarData: null, stats: { questionsAnswered: 0, bossesDefeated: 0 },
      playTime: 0, createdAt: Date.now()
    };
    currentUserId = 'admin_' + matchedAdmin.username;
    // Charger depuis Firebase si dispo
    if (firebaseReady) {
      try {
        const snap = await database.ref('players/' + currentUserId).once('value');
        if (snap.exists()) {
          const saved = snap.val();
          player = { ...player, ...saved, isAdmin: true, badges: saved.badges || ['üëë ADMIN'] };
        } else {
          await savePlayerToFirebase();
        }
      } catch(e) { /* fallback: utiliser les valeurs par d√©faut */ }
    }
    startAutoSave();
    showScreen('homeScreen');
    updateHomeScreen();
    return;
  }

  // Si Firebase n'est PAS configur√© ‚Üí mode localStorage
  if (!firebaseReady) {
    loginLocal(username, code);
    return;
  }

  // Mode Firebase
  const email = `${username.toLowerCase()}@schoolmes.game`;
  const btn = document.querySelector('#loginScreen button');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Connexion...'; }

  try {
    try {
      const cred = await auth.signInWithEmailAndPassword(email, code);
      currentUserId = cred.user.uid;
      // V√©rifier le ban AVANT de charger
      if (await checkBanStatus(currentUserId)) return;
      await loadPlayerFromFirebase(currentUserId);
      startAutoSave();
      checkSpecialBadges();
      showScreen('homeScreen');
      updateHomeScreen();
    } catch (err) {
      if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
        if (confirm(`üÜï Aucun compte pour "${username}". En cr√©er un ?`)) {
          const cred = await auth.createUserWithEmailAndPassword(email, code);
          currentUserId = cred.user.uid;
          player = {
            username: username, code: code, level: 1, xp: 0,
            coins: 100, maxLevel: 1, badges: [], isAdmin: false,
            inventory: { hints: 0, skips: 0, secondChances: 0, xpBoost: 0 },
            avatarData: null, stats: { questionsAnswered: 0, bossesDefeated: 0 }
          };
          await savePlayerToFirebase();
          startAutoSave();
          checkSpecialBadges();
          alert('üéâ Compte cr√©√© !');
          showScreen('homeScreen');
          updateHomeScreen();
        }
      } else {
        throw err;
      }
    }
  } catch (error) {
    console.error('Erreur Firebase login:', error);
    alert('‚ùå Erreur: ' + error.message);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'üöÄ Connexion / Inscription'; }
  }
}

// Connexion locale (sans Firebase)
function loginLocal(username, code) {
  const accounts = JSON.parse(localStorage.getItem('schoolmesAccounts') || '{}');
  const key = username.toLowerCase();
  if (accounts[key]) {
    if (accounts[key].code === code) {
      player = accounts[key];
      if (!player.inventory) player.inventory = { hints: 0, skips: 0, secondChances: 0, xpBoost: 0 };
      currentUserId = 'local_' + key;
      checkSpecialBadges();
      showScreen('homeScreen');
      updateHomeScreen();
    } else {
      alert('‚ùå Code incorrect !');
    }
  } else {
    player = {
      username: username, code: code, level: 1, xp: 0,
      coins: 100, maxLevel: 1, badges: [], isAdmin: false,
      inventory: { hints: 0, skips: 0, secondChances: 0, xpBoost: 0 },
      avatarData: null, stats: { questionsAnswered: 0, bossesDefeated: 0 },
      playTime: 0, createdAt: Date.now()
    };
    accounts[key] = player;
    localStorage.setItem('schoolmesAccounts', JSON.stringify(accounts));
    currentUserId = 'local_' + key;
    checkSpecialBadges();
    alert('üéâ Compte cr√©√© (mode local) !');
    showScreen('homeScreen');
    updateHomeScreen();
  }
  startAutoSave();
  startPlayTimeTracking();
}

async function logout() {
  if (confirm('üö™ Te d√©connecter ?')) {
    // Forcer la sauvegarde Firebase imm√©diatement avant de partir
    clearTimeout(_fbSaveDebounce);
    if (player) await savePlayerToFirebase().catch(()=>{});
    if (autoSaveTimer) clearInterval(autoSaveTimer);
    if (_playTimeInterval) clearInterval(_playTimeInterval);
    window._ptStarted = false;
    if (firebaseReady && auth) auth.signOut().catch(()=>{});
    player = null;
    currentUserId = null;
    _lbLastUpdate = 0;
    const gearBtn = document.getElementById('settingsGearBtn');
    if (gearBtn) gearBtn.style.display = 'none';
    showScreen('loginScreen');
  }
}

// ========================================
// SYST√àME DE BAN
// ========================================

async function checkBanStatus(uid) {
  if (!firebaseReady || !uid) return false;
  try {
    const snap = await database.ref('bans/' + uid).once('value');
    if (!snap.exists()) return false;
    const ban = snap.val();
    // V√©rifier si ban temporaire expir√©
    if (ban.expiresAt && ban.expiresAt < Date.now()) {
      // Ban expir√© ‚Äî on l'ignore (la suppression est faite par l'admin ou une Cloud Function)
      return false;
    }
    showBanScreen(ban);
    return true;
  } catch(e) {
    console.error('Ban check error:', e);
    return false;
  }
}

function showBanScreen(ban) {
  // D√©connecter si besoin
  if (firebaseReady && auth) auth.signOut().catch(()=>{});
  player = null; currentUserId = null;
  // Masquer tous les √©crans
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  // Afficher l'√©cran de ban
  let existing = document.getElementById('banScreen');
  if (existing) existing.remove();
  const div = document.createElement('div');
  div.id = 'banScreen';
  div.className = 'ban-screen';
  const expireText = ban.expiresAt
    ? `<br>üïê Expiration : ${new Date(ban.expiresAt).toLocaleString('fr-FR')}`
    : '<br>‚õî Banissement permanent';
  div.innerHTML = `
    <div style="font-size:4rem;margin-bottom:10px;">üî®</div>
    <h1>COMPTE BANNI</h1>
    <div class="ban-reason">
      <div style="font-size:0.8rem;color:#ef4444;margin-bottom:12px;">Tu as √©t√© banni de Schoolmes</div>
      <div><span style="color:#9ca3af;">Raison :</span> <span style="color:#fbbf24;">${ban.reason || 'Non pr√©cis√©e'}</span></div>
      <div><span style="color:#9ca3af;">Banni par :</span> ${ban.bannedBy || 'Admin'}</div>
      <div><span style="color:#9ca3af;">Date :</span> ${ban.bannedAt ? new Date(ban.bannedAt).toLocaleString('fr-FR') : '‚Äî'}${expireText}</div>
    </div>
    <div style="font-size:0.5rem;color:#6b7280;margin-top:20px;">Si tu penses que c'est une erreur, contacte un administrateur.</div>
    <button class="danger" style="margin-top:20px;" onclick="document.getElementById('banScreen').remove();showScreen('loginScreen');">‚Ü© Retour</button>
  `;
  document.body.appendChild(div);
}

async function openAdminBan() {
  if (!player?.isAdmin || !firebaseReady) {
    alert('‚ùå Firebase requis.'); return;
  }
  // Charger la liste des joueurs + bans actuels
  const [snapLb, snapBans] = await Promise.all([
    database.ref('leaderboard').once('value'),
    database.ref('bans').once('value').catch(() => ({ val: () => ({}) }))
  ]);
  const lbData = snapLb.val() || {};
  const bansData = (snapBans && typeof snapBans.val === 'function') ? (snapBans.val() || {}) : {};

  const entries = Object.entries(lbData)
    .filter(([, p]) => p && p.username && !p.isAdmin)
    .sort((a, b) => (a[1].username || '').localeCompare(b[1].username || ''));

  const overlay = document.createElement('div');
  overlay.id = 'adminBanOverlay';
  overlay.className = 'admin-ban-modal';

  overlay.innerHTML = `
    <div style="max-width:700px;margin:0 auto;background:#1a0a0a;border:3px solid #ef4444;border-radius:20px;padding:25px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="color:#ef4444;font-size:0.9rem;">üî® GESTION DES BANS</h2>
        <button class="danger" style="margin:0;" onclick="document.getElementById('adminBanOverlay').remove()">‚úñ</button>
      </div>

      <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:15px;margin-bottom:20px;">
        <div style="font-size:0.6rem;color:#fbbf24;margin-bottom:12px;">üî® BANNIR UN JOUEUR</div>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <select id="ban_target" style="background:#000;color:#fff;border:2px solid #ef4444;border-radius:8px;padding:10px;font-family:'Press Start 2P';font-size:0.55rem;">
            ${entries.map(([uid, p]) => {
              const isBanned = !!bansData[uid];
              return `<option value="${uid}" data-banned="${isBanned}">${isBanned ? 'üö´ ' : ''}${p.username} (Niv.${p.maxLevel||1})</option>`;
            }).join('')}
          </select>
          <input id="ban_reason" type="text" placeholder="Raison du ban (ex: triche, insultes...)" style="background:#000;color:#fff;border:2px solid #ef4444;border-radius:8px;padding:10px;font-family:'Press Start 2P';font-size:0.55rem;width:100%;box-sizing:border-box;">
          <div style="display:flex;gap:10px;align-items:center;">
            <label style="font-size:0.5rem;color:#9ca3af;">Dur√©e :</label>
            <select id="ban_duration" style="background:#000;color:#fff;border:2px solid #ef4444;border-radius:8px;padding:8px;font-family:'Press Start 2P';font-size:0.5rem;flex:1;">
              <option value="0">‚õî Permanent</option>
              <option value="1">1 jour</option>
              <option value="3">3 jours</option>
              <option value="7">7 jours</option>
              <option value="30">30 jours</option>
            </select>
          </div>
          <div style="display:flex;gap:10px;">
            <button class="danger" style="flex:1;padding:12px;" onclick="executeBan()">üî® BANNIR</button>
            <button style="flex:1;padding:12px;background:linear-gradient(135deg,#10b981,#059669);" onclick="executeUnban()">‚úÖ D√âBANNIR</button>
          </div>
        </div>
      </div>

      <div style="font-size:0.6rem;color:#fbbf24;margin-bottom:10px;">üìã JOUEURS BANNIS (${Object.keys(bansData).length})</div>
      <div style="max-height:250px;overflow-y:auto;" id="banListContainer">
        ${Object.keys(bansData).length === 0 
          ? '<div style="font-size:0.55rem;color:#6b7280;text-align:center;padding:20px;">Aucun joueur banni</div>'
          : Object.entries(bansData).map(([uid, ban]) => `
            <div class="admin-ban-card is-banned">
              <div>
                <div style="color:#ef4444;font-weight:bold;">${ban.username || uid}</div>
                <div style="color:#9ca3af;margin-top:4px;">Raison : ${ban.reason || '‚Äî'}</div>
                <div style="color:#6b7280;margin-top:2px;">${ban.expiresAt ? 'Expire : ' + new Date(ban.expiresAt).toLocaleDateString('fr-FR') : 'Permanent'}</div>
              </div>
              <button style="background:linear-gradient(135deg,#10b981,#059669);padding:6px 10px;font-size:0.45rem;margin:0;" onclick="quickUnban('${uid}', this)">‚úÖ D√©bannir</button>
            </div>
          `).join('')
        }
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

async function executeBan() {
  const uid = document.getElementById('ban_target').value;
  const reason = document.getElementById('ban_reason').value.trim();
  const duration = parseInt(document.getElementById('ban_duration').value);
  const lbSnap = await database.ref('leaderboard/' + uid).once('value');
  const targetData = lbSnap.val() || {};

  if (!uid) { alert('‚ö†Ô∏è S√©lectionne un joueur.'); return; }
  if (!reason) { alert('‚ö†Ô∏è Entre une raison pour le ban.'); return; }
  const _confirmMsg = 'üî® Bannir ' + (targetData.username || uid) + '?\nRaison : ' + reason + (duration > 0 ? '\nDur√©e : ' + duration + ' jour(s)' : '\nDur√©e : Permanent');
  if (!confirm(_confirmMsg)) return;

  const banData = {
    username: targetData.username || uid,
    reason: reason,
    bannedAt: Date.now(),
    bannedBy: player.username,
    expiresAt: duration > 0 ? Date.now() + duration * 86400000 : null
  };

  try {
    await database.ref('bans/' + uid).set(banData);
    // Mettre √† jour le leaderboard avec le flag banni
    await database.ref('leaderboard/' + uid).update({ isBanned: true });
    alert(`‚úÖ ${banData.username} a √©t√© banni !`);
    document.getElementById('adminBanOverlay').remove();
  } catch(e) {
    alert('‚ùå Erreur : ' + e.message);
  }
}

async function executeUnban() {
  const uid = document.getElementById('ban_target').value;
  const lbSnap = await database.ref('leaderboard/' + uid).once('value');
  const targetData = lbSnap.val() || {};
  if (!uid) { alert('‚ö†Ô∏è S√©lectionne un joueur.'); return; }
  if (!confirm(`‚úÖ D√©bannir ${targetData.username || uid} ?`)) return;
  try {
    await database.ref('bans/' + uid).remove();
    await database.ref('leaderboard/' + uid).update({ isBanned: false });
    alert(`‚úÖ ${targetData.username || uid} a √©t√© d√©banni !`);
    document.getElementById('adminBanOverlay').remove();
  } catch(e) {
    alert('‚ùå Erreur : ' + e.message);
  }
}

async function quickUnban(uid, btn) {
  if (!confirm('‚úÖ D√©bannir ce joueur ?')) return;
  try {
    await database.ref('bans/' + uid).remove();
    await database.ref('leaderboard/' + uid).update({ isBanned: false });
    btn.closest('.admin-ban-card').remove();
  } catch(e) {
    alert('‚ùå Erreur : ' + e.message);
  }
}

// ========================================
// FIREBASE - SAUVEGARDE ET CHARGEMENT
// ========================================

async function savePlayerToFirebase() {
  if (!player || !currentUserId || !database || !firebaseReady) return;
  try {
    AC.check(); // V√©rification anticheat avant chaque sauvegarde Firebase
    // Nettoyer l'objet player avant envoi (supprimer undefined, couper avatarData si trop grand)
    const data = JSON.parse(JSON.stringify(player));
    data.lastSave = Date.now();
    // S√©curit√© : limiter avatarData √† 256 items max
    if (data.avatarData && data.avatarData.length > 256) data.avatarData = data.avatarData.slice(0, 256);
    await database.ref('players/' + currentUserId).set(data);
    showSaveNotification();
  } catch (error) {
    console.error('Erreur sauvegarde Firebase:', error.message);
    savePlayerLocal(); // Fallback local
  }
}

async function loadPlayerFromFirebase(userId) {
  try {
    const snapshot = await database.ref('players/' + userId).once('value');
    if (snapshot.exists()) {
      const data = snapshot.val();
      // Fusionner avec le player existant pour ne rien perdre
      player = {
        ...player,
        ...data,
        inventory: {
          hints: 0, skips: 0, secondChances: 0, xpBoost: 0,
          ...(data.inventory || {})
        },
        badges: data.badges || [],
        stats: data.stats || { questionsAnswered: 0, bossesDefeated: 0 }
      };
      console.log('üì• Progression charg√©e depuis Firebase - Niveau:', player.level, '/ Carte:', player.maxLevel);
    } else {
      // Nouveau joueur ‚Äî d√©j√† cr√©√© dans login(), on sauvegarde tout de suite
      console.log('üÜï Nouveau joueur, sauvegarde initiale...');
      await savePlayerToFirebase();
    }
  } catch (error) {
    console.error('Erreur chargement Firebase:', error.message);
    loadPlayerLocal();
  }
}

// Fonctions de fallback localStorage
function savePlayerLocal() {
  if (!player) return;
  const accounts = JSON.parse(localStorage.getItem('schoolmesAccounts') || '{}');
  accounts[player.username] = player;
  localStorage.setItem('schoolmesAccounts', JSON.stringify(accounts));
  showSaveNotification();
}

function loadPlayerLocal() {
  const accounts = JSON.parse(localStorage.getItem('schoolmesAccounts') || '{}');
  if (player && accounts[player.username]) {
    player = accounts[player.username];
  }
}

// showSaveNotification et manualSave d√©finis plus bas
// NOTE: savePlayer() et savePlayerNow() sont d√©finis √† la fin du script (avec startAutoSave)

// SCREENS
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(screenId);
  if (el) el.classList.add('active');
  // Changer la musique imm√©diatement (on est dans un event handler = AudioContext autoris√©)
  try { updateMusicForScreen(screenId); } catch(e) { console.warn('Music error:', e); }
}

// GAME
function initGame(newSession = true) {
  if (!player) return;
  
  // Nouvelle session (depuis accueil) : on remet les vies √† z√©ro
  // Retour √† la carte en cours de partie : on conserve les vies
  if (newSession) {
    sessionErrors = 0;
    sessionCorrect = 0;
    failedQuestions.clear();
  }
  
  document.getElementById('gameLevel').textContent = player.level;
  document.getElementById('gameCoins').textContent = player.coins;
  
  const xpNeeded = player.level * 100;
  const xpProgress = (player.xp / xpNeeded) * 100;
  
  document.getElementById('gameXP').textContent = `${player.xp} / ${xpNeeded}`;
  document.getElementById('xpBar').style.width = xpProgress + '%';
  document.getElementById('xpBar').textContent = Math.floor(xpProgress) + '%';
  
  renderMap();
}

function renderMap() {
  const map = document.getElementById('map');
  map.innerHTML = '';
  
  const startLevel = Math.max(1, player.maxLevel - 19);
  const endLevel = player.maxLevel + 30;
  
  for (let i = startLevel; i <= endLevel; i++) {
    const tile = document.createElement('div');
    tile.className = 'tile';
    
    const biome = getBiome(i);
    const isBoss = i % 100 === 0;
    
    if (isBoss) {
      tile.classList.add('boss');
      tile.innerHTML = 'üëπ';
    } else {
      tile.classList.add(biome.class);
      tile.innerHTML = biome.emoji;
    }
    
    const number = document.createElement('div');
    number.className = 'tile-number';
    number.textContent = i;
    tile.appendChild(number);
    
    if (i < player.maxLevel) {
      tile.classList.add('completed');
    } else if (i === player.maxLevel) {
      tile.classList.add('current');
      tile.onclick = () => startQuiz(i);
    } else {
      tile.classList.add('locked');
    }
    
    map.appendChild(tile);
  }
}

function startQuiz(level) {
  currentLevel = level;
  currentQuestion = generateQuestion(level);
  selectedChoiceValue = null; // Reset pour QCM
  
  // On ne remet PAS sessionErrors √† 0 ici : les vies persistent entre les niveaux
  // (reset uniquement au restartGame ou au d√©but d'une nouvelle session de jeu)
  sessionCoinsStart = player.coins;
  
  showScreen('quizScreen');
  startQuestionTimer();
  
  const biome = getBiome(level);
  const isBoss = level % 100 === 0;
  
  if (isBoss) {
    document.getElementById('quizBiomeInfo').innerHTML = '<span style="color:#ef4444; font-size:1.2rem;">üëπ BOSS - R√©compenses x5</span>';
    playBossSound();
  } else {
    document.getElementById('quizBiomeInfo').innerHTML = `${biome.emoji} ${biome.name.toUpperCase()}`;
  }
  
  document.getElementById('questionText').textContent = currentQuestion.question;
  document.getElementById('quizFeedback').innerHTML = '';
  
  skipCost = 50 + Math.floor(level / 100) * 50;
  document.getElementById('skipCost').textContent = skipCost;
  
  // Afficher QCM ou champ texte selon le type de question
  if (currentQuestion.type === 'qcm') {
    // Mode QCM : afficher les boutons, cacher l'input
    document.getElementById('textAnswerGroup').style.display = 'none';
    document.getElementById('choiceButtons').style.display = 'flex';
    renderChoiceButtons();
  } else {
    // Mode texte : afficher l'input, cacher les boutons
    document.getElementById('textAnswerGroup').style.display = 'block';
    document.getElementById('choiceButtons').style.display = 'none';
    document.getElementById('answerInput').value = '';
    document.getElementById('answerInput').focus();
  }
  
  updateHeartsDisplay();
  renderBonusBar();
}

function renderChoiceButtons() {
  const container = document.getElementById('choiceButtons');
  container.innerHTML = '';
  
  if (!currentQuestion.choices) return;
  
  currentQuestion.choices.forEach(choice => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = choice;
    btn.onclick = () => selectChoice(choice, btn);
    container.appendChild(btn);
  });
}

let selectedChoiceValue = null;

function selectChoice(value, btnElement) {
  // D√©s√©lectionner tous les boutons
  document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
  // S√©lectionner celui-ci
  btnElement.classList.add('selected');
  selectedChoiceValue = value;
  // Auto-submit selon r√©glages
  if (getSettings().autoSubmit) {
    setTimeout(() => submitAnswer(), 500);
  }
}

function updateHeartsDisplay() {
  const heartsDiv = document.getElementById('heartsDisplay');
  heartsDiv.innerHTML = '';
  
  for (let i = 0; i < 5; i++) {
    const heart = document.createElement('span');
    heart.className = 'heart';
    heart.textContent = '‚ù§Ô∏è';
    if (i < sessionErrors) {
      heart.classList.add('lost');
    }
    heartsDiv.appendChild(heart);
  }
  
  document.getElementById('errorsCount').textContent = sessionErrors;
}

function renderBonusBar() {
  const bonusBar = document.getElementById('bonusBar');
  bonusBar.innerHTML = '<div style="font-size:0.7rem; color:#fbbf24; margin-bottom:10px; width:100%; text-align:center;">‚ú® MES BONUS ‚ú®</div>';

  const inv = player.inventory;

  const bonusDefs = [
    { key: 'hints',         label: 'üí° Indice',       fn: useHint,         cond: true },
    { key: 'skips',         label: '‚è≠Ô∏è Passer',        fn: useSkipBonus,    cond: true },
    { key: 'secondChances', label: 'üîÑ 2√®me Chance',   fn: useSecondChance, cond: sessionErrors > 0 },
    { key: 'shields',       label: 'üõ°Ô∏è Bouclier',      fn: useShield,       cond: true },
    { key: 'aimers',        label: 'üéØ Viseur',         fn: useAimer,        cond: currentQuestion && currentQuestion.type === 'qcm' },
    { key: 'freezes',       label: '‚è≥ Gel',            fn: useFreeze,       cond: true },
    { key: 'xpBoost',       label: '‚ö° Boost XP√ó2',    fn: null,            cond: true, info: true },
    { key: 'xpBoost3',      label: 'üåü Boost XP√ó3',    fn: null,            cond: true, info: true },
    { key: 'coinBoost',     label: 'üí∏ Bonus Pi√®ces',  fn: null,            cond: true, info: true },
  ];

  bonusDefs.forEach(({ key, label, fn, cond, info }) => {
    const count = inv[key] || 0;
    if (count === 0) return; // masquer si vide
    const btn = document.createElement('button');
    btn.className = 'bonus-button';
    btn.innerHTML = `${label} <span class="bonus-count">x${count}</span>`;
    if (!fn || !cond) {
      btn.disabled = true;
      btn.title = info ? 'Actif automatiquement' : 'Non disponible maintenant';
    } else {
      btn.onclick = fn;
    }
    bonusBar.appendChild(btn);
  });

  // Si aucun bonus
  const btns = bonusBar.querySelectorAll('.bonus-button');
  if (btns.length === 0) {
    bonusBar.innerHTML += '<div style="font-size:0.6rem; color:#6b7280; text-align:center;">Aucun bonus en stock ‚Äî va √† la boutique !</div>';
  }
}

function useHint() {
  if (player.inventory.hints <= 0) return;
  const answer = currentQuestion.answer;
  const revealed = answer.charAt(Math.floor(Math.random() * answer.length));
  player.inventory.hints--;
  savePlayer();
  alert(`üí° Indice : La r√©ponse contient la lettre "${revealed.toUpperCase()}"`);
  renderBonusBar();
}

function useSkipBonus() {
  if (player.inventory.skips <= 0) return;
  if (confirm('‚è≠Ô∏è Utiliser un bonus Passer ?')) {
    player.inventory.skips--;
    if (currentLevel >= player.maxLevel) player.maxLevel = currentLevel + 1;
    currentLevel++;
    savePlayer();
    // Charger la question suivante directement
    currentQuestion = generateQuestion(currentLevel);
    selectedChoiceValue = null;
    startQuestionTimer();
    document.getElementById('quizLevelTitle').textContent = `Niveau ${currentLevel}`;
  // Musique boss si niveau multiple de 100
  if (getSettings().musicEnabled) {
    const isBoss = currentLevel % 100 === 0;
    const targetSong = isBoss ? 'boss' : 'quiz';
    if (MUSIC._currentSong !== targetSong) MUSIC.play(targetSong);
  }
    document.getElementById('quizFeedback').innerHTML = '';
    document.getElementById('questionText').textContent = currentQuestion.question;
    const choiceDiv = document.getElementById('choiceButtons');
    const textDiv = document.getElementById('textAnswerGroup');
    if (currentQuestion.type === 'qcm') {
      choiceDiv.style.display = 'flex';
      textDiv.style.display = 'none';
      renderChoiceButtons();
    } else {
      choiceDiv.style.display = 'none';
      textDiv.style.display = 'block';
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
    }
    renderBonusBar();
  }
}

function useShield() {
  if ((player.inventory.shields || 0) <= 0) return;
  if (confirm('üõ°Ô∏è Activer le Bouclier ? La prochaine erreur ne comptera pas.')) {
    player.inventory.shields--;
    player._shieldActive = true;
    savePlayer();
    renderBonusBar();
    alert('üõ°Ô∏è Bouclier activ√© ! Ta prochaine erreur sera bloqu√©e.');
  }
}

function useAimer() {
  if ((player.inventory.aimers || 0) <= 0) return;
  if (!currentQuestion || currentQuestion.type !== 'qcm') {
    alert('üéØ Le Viseur ne fonctionne que sur les QCM !'); return;
  }
  // √âliminer 2 mauvaises r√©ponses
  const wrongBtns = Array.from(document.querySelectorAll('.choice-btn'))
    .filter(b => normalizeText(b.textContent) !== normalizeText(currentQuestion.answer));
  const toHide = wrongBtns.sort(() => Math.random() - 0.5).slice(0, 2);
  toHide.forEach(b => { b.disabled = true; b.style.opacity = '0.2'; });
  player.inventory.aimers--;
  savePlayer();
  renderBonusBar();
}

function useFreeze() {
  if ((player.inventory.freezes || 0) <= 0) return;
  if (confirm('‚è≥ Activer le Gel du temps ? Ta prochaine erreur ne comptera pas.')) {
    player.inventory.freezes--;
    player._freezeActive = true;
    savePlayer();
    renderBonusBar();
    alert('‚è≥ Gel activ√© ! Ta prochaine erreur sera ignor√©e.');
  }
}

function useSecondChance() {
  if (player.inventory.secondChances <= 0 || sessionErrors === 0) return;
  
  if (confirm('üîÑ Utiliser une 2√®me Chance pour effacer une erreur ?')) {
    player.inventory.secondChances--;
    sessionErrors--;
    savePlayer();
    updateHeartsDisplay();
    renderBonusBar();
    alert('‚úÖ Une erreur a √©t√© effac√©e !');
  }
}

function submitAnswer() {
  let userAnswer;
  
  // D√©terminer la r√©ponse selon le type de question
  if (currentQuestion.type === 'qcm') {
    userAnswer = selectedChoiceValue;
    if (!userAnswer) {
      alert('‚ö†Ô∏è S√©lectionne une r√©ponse !');
      return;
    }
  } else {
    userAnswer = document.getElementById('answerInput').value.trim();
    if (!userAnswer) {
      alert('‚ö†Ô∏è Entre une r√©ponse !');
      return;
    }
  }
  
  const correctAnswer = currentQuestion.answer;
  
  // VALIDATION FLEXIBLE
  const normalizedUser = normalizeText(userAnswer);
  const normalizedCorrect = normalizeText(correctAnswer);
  
  const isCorrect = normalizedUser === normalizedCorrect;
  
  if (isCorrect) {
    // ===== ADDICTIVE MECHANICS: CORRECT ANSWER =====
    clearInterval(questionTimer);
    incrementCombo();
    const comboMult = getComboMultiplier();
    const timeBonus = getTimeBonus();
    playCorrectSound();
    spawnParticles(window.innerWidth/2, window.innerHeight/2, 'correct');

    const isBoss = currentLevel % 100 === 0;
    let xpGain = isBoss ? 250 : 50;
    
    // Talent: extra XP
    if (player.talents && player.talents.includes('t2')) xpGain = Math.floor(xpGain * 1.1);
    if (player.talents && player.talents.includes('t8')) xpGain *= 2;
    
    // Time bonus
    xpGain += timeBonus * 10;
    
    // Boost XP √ó2
    if (player.inventory.xpBoost > 0) {
      xpGain *= 2;
      player.inventory.xpBoost--;
    }
    // Boost XP √ó3 (priorit√© sur √ó2 si les deux sont actifs)
    if (player.inventory.xpBoost3 > 0) {
      xpGain = (isBoss ? 250 : 50) * 3;
      player.inventory.xpBoost3--;
    }
    
    // Event multiplier
    xpGain = Math.floor(xpGain * getEventMultiplier('xp'));
    if (isBoss) xpGain = Math.floor(xpGain * getEventMultiplier('boss'));
    
    // COMBO MULTIPLIER on XP
    xpGain = Math.floor(xpGain * comboMult);

    let coinGain = isBoss ? 100 : 20;
    
    // Talent: extra coins
    if (player.talents && player.talents.includes('t1')) coinGain = Math.floor(coinGain * 1.1);
    if (player.talents && player.talents.includes('t7')) coinGain = Math.floor(coinGain * 1.25);
    
    // Bonus Pi√®ces √ó2
    if ((player.inventory.coinBoost || 0) > 0) {
      coinGain *= 2;
      player.inventory.coinBoost--;
    }
    
    // Event multiplier
    coinGain = Math.floor(coinGain * getEventMultiplier('coins'));
    // COMBO MULTIPLIER on coins
    coinGain = Math.floor(coinGain * comboMult);
    
    // Prestige bonus
    if (player.prestigeLevel) coinGain = Math.floor(coinGain * (1 + player.prestigeLevel * 0.5));
    
    // Ami des Admins bonus: +10% XP et pi√®ces
    if (isAmiAdmin()) {
      xpGain = Math.floor(xpGain * 1.1);
      coinGain = Math.floor(coinGain * 1.1);
    }
    
    player.xp += xpGain;
    player.coins += coinGain;
    player.stats.questionsAnswered++;
    sessionCorrect++;
    if (isBoss) player.stats.bossesDefeated++;
    
    // Quest tracking
    updateQuestProgress('questionsAnswered', 1);
    if (comboCount >= 5) updateQuestProgress('maxCombo', comboCount);
    updateQuestProgress('sessionCoins', coinGain);
    if (isBoss) updateQuestProgress('bossesDefeated', 1);
    
    const xpNeeded = player.level * 100;
    if (player.xp >= xpNeeded) {
      player.level++;
      player.xp -= xpNeeded;
      checkBadges();
      checkTalentPoints();
      playLevelUpSound();
    }
    
    if (currentLevel >= player.maxLevel) player.maxLevel = currentLevel + 1;
    
    // Loot drop (20% chance, 30% with lucky talent)
    const dropChance = (player.talents && player.talents.includes('t5')) ? 0.35 : 0.2;
    setTimeout(() => tryDropLoot(dropChance), 2200);
    
    savePlayer();
    
    const comboTxt = comboMult > 1 ? ` üî•√ó${comboMult}` : '';
    const timeTxt = timeBonus > 0 ? ` ‚è±Ô∏è+${timeBonus*10}XP` : '';
    const boostMsg = player.inventory.xpBoost > 0 || player.inventory.xpBoost3 > 0 ? ' ‚ö° BOOST !' : '';
    const coinMsg = (player.inventory.coinBoost || 0) > 0 ? ' üí∏ BONUS !' : '';
    document.getElementById('quizFeedback').innerHTML = `
      <div style="color:#10b981; font-size:1.2rem;">‚úÖ CORRECT !${comboTxt}</div>
      <div style="color:#fbbf24;">+${xpGain} XP${boostMsg}${timeTxt} | +${coinGain} üí∞${coinMsg}</div>
    `;
    
    setTimeout(() => {
      showScreen('gameScreen');
      initGame(false);
    }, 2000);
    
  } else {
    // ERREUR ‚Äî v√©rifier Bouclier ou Gel
    clearInterval(questionTimer);
    resetCombo();
    playWrongSound();
    let blocked = false;
    if (player._shieldActive) {
      player._shieldActive = false;
      blocked = true;
      document.getElementById('quizFeedback').innerHTML = `
        <div style="color:#f59e0b; font-size:1rem;">üõ°Ô∏è Bouclier activ√© ! Erreur bloqu√©e !</div>
        <div style="color:#9ca3af; margin-top:10px;">R√©ponse: ${correctAnswer}</div>
      `;
    } else if (player._freezeActive) {
      player._freezeActive = false;
      blocked = true;
      document.getElementById('quizFeedback').innerHTML = `
        <div style="color:#38bdf8; font-size:1rem;">‚è≥ Gel du temps ! Erreur ignor√©e !</div>
        <div style="color:#9ca3af; margin-top:10px;">R√©ponse: ${correctAnswer}</div>
      `;
    }

    if (!blocked) {
      sessionErrors++;
      failedQuestions.add(currentQuestion.id);
    }

    if (!blocked && sessionErrors >= 5) {
      document.getElementById('quizFeedback').innerHTML = `
        <div style="color:#ef4444;">‚ùå Incorrect !</div>
        <div style="color:#9ca3af; margin-top:10px;">R√©ponse: ${correctAnswer}</div>
        <div style="color:#ef4444; margin-top:15px; font-size:1rem;">üíÄ GAME OVER !</div>
      `;
      updateHeartsDisplay();
      setTimeout(() => { showGameOver(); }, 2000);
      return;
    }

    if (!blocked) {
      updateHeartsDisplay();
      screenShake();
      document.getElementById('quizFeedback').innerHTML = `
        <div style="color:#ef4444;">‚ùå Incorrect !</div>
        <div style="color:#9ca3af; margin-top:10px;">R√©ponse: ${correctAnswer}</div>
      `;
    }
    
    setTimeout(() => {
      currentQuestion = generateQuestion(currentLevel);
      selectedChoiceValue = null;
      startQuestionTimer();
      document.getElementById('questionText').textContent = currentQuestion.question;
      document.getElementById('quizFeedback').innerHTML = '';
      const choiceDiv = document.getElementById('choiceButtons');
      const textDiv = document.getElementById('textAnswerGroup');
      if (currentQuestion.type === 'qcm') {
        choiceDiv.style.display = 'flex';
        textDiv.style.display = 'none';
        renderChoiceButtons();
      } else {
        choiceDiv.style.display = 'none';
        textDiv.style.display = 'block';
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').focus();
      }
      renderBonusBar();
    }, 3000);
  }
}

function showGameOver() {
  savePlayer();
  
  document.getElementById('goLevel').textContent = currentLevel;
  document.getElementById('goCorrect').textContent = sessionCorrect;
  document.getElementById('goCoins').textContent = player.coins - sessionCoinsStart;
  
  showScreen('gameOverScreen');
}

function restartGame() {
  sessionErrors = 0;
  sessionCorrect = 0;
  failedQuestions.clear();
  showScreen('gameScreen');
  initGame(true);
}

function skipQuestion() {
  if (player.coins >= skipCost) {
    if (confirm(`Passer pour ${skipCost} pi√®ces ?`)) {
      player.coins -= skipCost;
      if (currentLevel >= player.maxLevel) player.maxLevel = currentLevel + 1;
      currentLevel++;
      savePlayer();
      // Charger directement la question suivante sans repasser par la carte
      currentQuestion = generateQuestion(currentLevel);
      selectedChoiceValue = null;
      startQuestionTimer();
      document.getElementById('quizLevelTitle').textContent = `Niveau ${currentLevel}`;
      document.getElementById('quizFeedback').innerHTML = '';
      document.getElementById('questionText').textContent = currentQuestion.question;
      const choiceDiv = document.getElementById('choiceButtons');
      const textDiv = document.getElementById('textAnswerGroup');
      if (currentQuestion.type === 'qcm') {
        choiceDiv.style.display = 'flex';
        textDiv.style.display = 'none';
        renderChoiceButtons();
      } else {
        choiceDiv.style.display = 'none';
        textDiv.style.display = 'block';
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').focus();
      }
      renderBonusBar();
      // Mettre √† jour l'affichage pi√®ces
      document.getElementById('shopCoins') && (document.getElementById('shopCoins').textContent = player.coins);
    }
  } else {
    alert('‚ùå Pas assez de pi√®ces !');
  }
}

function quitQuiz() {
  if (confirm('Quitter ce niveau ?')) {
    clearInterval(questionTimer);
    savePlayer();
    showScreen('homeScreen');
    updateHomeScreen();
  }
}

function checkBadges() {
  const badges = [
    [50, 'ü•â Niveau 50'],
    [100, 'ü•à Niveau 100'],
    [500, 'ü•á Niveau 500'],
    [1000, 'üíé Niveau 1000']
  ];
  
  badges.forEach(([lvl, badge]) => {
    if (player.level >= lvl && !player.badges.includes(badge)) {
      player.badges.push(badge);
    }
  });
  
  checkSpecialBadges();
}

// ====== BADGES SP√âCIAUX ======
const AMI_ADMIN_PSEUDOS = ['lapro34', 'le 34290', 'le34290'];
const AMI_ADMIN_BADGE = 'üíó Ami(e) des Admins';
const OJ_BADGE = 'üéñÔ∏è OJ';

function checkSpecialBadges() {
  if (!player) return;
  if (!player.badges) player.badges = [];
  
  // Badge Ami(e) des Admins
  const uLow = (player.username || '').toLowerCase().replace(/\s+/g,'');
  const isAmiAdmin = AMI_ADMIN_PSEUDOS.some(p => uLow === p.replace(/\s+/g,''));
  if (isAmiAdmin && !player.badges.includes(AMI_ADMIN_BADGE)) {
    player.badges.push(AMI_ADMIN_BADGE);
    player.isAmiAdmin = true;
  }
  if (isAmiAdmin) player.isAmiAdmin = true;
  
  // Badge OJ (Ancien joueur ‚Äî d√©j√† pr√©sent dans la DB = a des stats ou un compte)
  // Badge OJ pour les anciens joueurs (ont d√©j√† jou√©)
  if (!player.isAdmin && !player.badges.includes(OJ_BADGE)) {
    if ((player.maxLevel > 1) || (player.stats && player.stats.questionsAnswered > 0)) {
      player.badges.push(OJ_BADGE);
    }
  }
}

function isAmiAdmin() {
  return player && player.isAmiAdmin === true;
}

// ====== TEMPS DE JEU ======
let _playTimeInterval = null;

function startPlayTimeTracking() {
  if (_playTimeInterval) clearInterval(_playTimeInterval);
  let _banCheckTick = 0;
  _playTimeInterval = setInterval(async () => {
    if (!player) return;
    if (!player.isAdmin) {
      if (!player.playTime) player.playTime = 0;
      player.playTime += 60000; // +1 minute par tick
    }
    // V√©rification du ban toutes les 5 minutes
    _banCheckTick++;
    if (_banCheckTick >= 5 && firebaseReady && currentUserId && !player.isAdmin) {
      _banCheckTick = 0;
      await checkBanStatus(currentUserId);
    }
  }, 60000);
}

// ====== ANTICHEAT ======
const AC = {
  _lastCoins: 0, _lastLevel: 0, _lastSave: 0,
  _coinsPerMin: [], _levelJumps: [],
  MAX_COINS_PER_SAVE: 5000,    // Max pi√®ces gagn√©es entre 2 sauvegardes
  MAX_LEVEL_JUMP: 10,          // Max niveaux en 1 save
  
  check() {
    if (!player || player.isAdmin) return;
    const now = Date.now();
    
    // D√©tection de saut de niveaux suspect
    const levelDiff = (player.maxLevel || 0) - (this._lastLevel || 0);
    if (this._lastLevel > 0 && levelDiff > this.MAX_LEVEL_JUMP) {
      console.warn('[AC] Saut de niveau suspect:', levelDiff);
      this._flag('level_jump', levelDiff);
    }
    
    // D√©tection de gain de pi√®ces suspect
    const coinDiff = (player.coins || 0) - (this._lastCoins || 0);
    const timeDiff = now - (this._lastSave || now);
    const coinsThreshold = player.isAmiAdmin ? this.MAX_COINS_PER_SAVE * 2 : this.MAX_COINS_PER_SAVE;
    if (this._lastCoins > 0 && coinDiff > coinsThreshold && timeDiff < 5000) {
      console.warn('[AC] Gain de pi√®ces suspect:', coinDiff, 'en', timeDiff, 'ms');
      this._flag('coin_hack', coinDiff);
    }
    
    this._lastCoins = player.coins || 0;
    this._lastLevel = player.maxLevel || 0;
    this._lastSave = now;
  },
  
  _flag(type, value) {
    if (!player) return;
    if (!player._acFlags) player._acFlags = [];
    player._acFlags.push({ type, value, ts: Date.now() });
    // Reporter √† Firebase si dispo
    if (firebaseReady && currentUserId && !currentUserId.startsWith('local_')) {
      database.ref('anticheat/' + currentUserId).push({ type, value, ts: Date.now(), username: player.username })
        .catch(() => {});
    }
  }
};

// L'anticheat est appel√© directement dans savePlayerToFirebase (pas de hook)

// ====== JOUEURS CONNECT√âS ======
let opCurrentTab = 'online';

function switchOpTab(tab) {
  opCurrentTab = tab;
  document.getElementById('opTabOnline').className = tab === 'online' ? 'primary' : '';
  document.getElementById('opTabAll').className = tab === 'all' ? 'primary' : '';
  renderOnlinePlayers();
}

async function renderOnlinePlayers() {
  const el = document.getElementById('onlinePlayersList');
  if (!el) return;
  if (!firebaseReady) {
    el.innerHTML = '<div style="color:#9ca3af;font-size:0.6rem;text-align:center;padding:30px;">‚ö†Ô∏è Firebase requis pour voir les joueurs</div>';
    return;
  }
  el.innerHTML = '<div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:30px;">‚è≥ Chargement...</div>';
  
  try {
    const now = Date.now();
    const ONLINE_THRESHOLD = 90000; // 90s
    
    if (opCurrentTab === 'online') {
      const snap = await database.ref('presence').once('value');
      const data = snap.val() || {};
      const onlinePlayers = Object.entries(data)
        .filter(([uid, p]) => p.online && (now - (p.ts || 0)) < ONLINE_THRESHOLD)
        .map(([uid, p]) => ({ ...p, uid, isOnline: true }));
      
      if (onlinePlayers.length === 0) {
        el.innerHTML = '<div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:40px;">üò¥ Aucun joueur en ligne actuellement</div>';
        return;
      }
      renderOnlineList(el, onlinePlayers);
    } else {
      // Tous les joueurs (leaderboard + pr√©sence)
      const [snapLb, snapPres] = await Promise.all([
        database.ref('leaderboard').once('value'),
        database.ref('presence').once('value')
      ]);
      const presData = snapPres.val() || {};
      const lbData = snapLb.val() || {};
      
      const allPlayers = Object.entries(lbData)
        .filter(([, p]) => p.username && !p.isAdmin)
        .map(([uid, p]) => {
          const pres = presData[uid];
          const isOnline = pres && pres.online && (now - (pres.ts || 0)) < ONLINE_THRESHOLD;
          return { ...p, uid, isOnline, lastSeen: pres?.ts || p.lastSave || 0 };
        })
        .sort((a, b) => (b.isOnline ? 1 : 0) - (a.isOnline ? 1 : 0) || b.lastSeen - a.lastSeen);
      
      renderOnlineList(el, allPlayers);
    }
  } catch(e) {
    el.innerHTML = `<div style="color:#ef4444;font-size:0.6rem;text-align:center;padding:20px;">Erreur: ${e.message}</div>`;
  }
}

function renderOnlineList(el, players) {
  if (players.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:30px;">Aucun joueur trouv√©</div>';
    return;
  }
  el.innerHTML = players.map(p => {
    const isMe = player && p.username === player.username;
    const statusColor = p.isOnline ? '#10b981' : '#6b7280';
    const statusText = p.isOnline ? 'üü¢ En ligne' : '‚ö´ Hors ligne';
    const timeSince = p.lastSeen ? formatTimeSince(Date.now() - p.lastSeen) : '';
    return `
      <div class="online-player-card ${p.isOnline ? 'is-online' : 'is-offline'}">
        <div style="width:12px;height:12px;border-radius:50%;background:${statusColor};box-shadow:0 0 8px ${statusColor};flex-shrink:0;"></div>
        <div style="flex:1;">
          <div style="font-size:0.65rem;color:#fbbf24;">${p.username}${isMe ? ' <span style="color:#10b981;">(toi)</span>' : ''}</div>
          <div style="font-size:0.5rem;color:#9ca3af;">${statusText} &nbsp;‚Ä¢&nbsp; Niv.${p.level||1} &nbsp;‚Ä¢&nbsp; üó∫Ô∏è${p.maxLevel||1}</div>
          ${!p.isOnline && timeSince ? `<div style="font-size:0.45rem;color:#6b7280;">Vu il y a ${timeSince}</div>` : ''}
        </div>
        ${p.isOnline && !isMe && !player?.isAdmin ? `<button class="primary" style="margin:0;padding:6px 10px;font-size:0.45rem;" onclick="challengePlayer('${p.uid}','${p.username}')">‚öîÔ∏è D√©fier</button>` : ''}
      </div>
    `;
  }).join('');
}

function formatTimeSince(ms) {
  const m = Math.floor(ms / 60000);
  const h = Math.floor(ms / 3600000);
  const d = Math.floor(ms / 86400000);
  if (d > 0) return `${d}j`;
  if (h > 0) return `${h}h`;
  return `${m}min`;
}

// ====== R√âGLAGES ======
const SETTINGS_DEFAULTS = {
  soundEnabled: true,
  musicEnabled: true,
  particlesEnabled: true,
  screenShakeEnabled: true,
  timerEnabled: true,
  autoSubmit: true,
  theme: 'default',
  fontSize: 'normal',
  notifications: true,
  comboDisplay: true,
  language: 'fr',
  hardMode: false
};

function getSettings() {
  try {
    return { ...SETTINGS_DEFAULTS, ...JSON.parse(localStorage.getItem('schoolmesSettings') || '{}') };
  } catch(e) { return { ...SETTINGS_DEFAULTS }; }
}

function saveSetting(key, value) {
  const s = getSettings();
  s[key] = value;
  localStorage.setItem('schoolmesSettings', JSON.stringify(s));
  applySettings();
  // R√©agir au toggle musique
  if (key === 'musicEnabled') {
    if (value) {
      const active = document.querySelector('.screen.active');
      if (active) updateMusicForScreen(active.id);
    } else {
      MUSIC.stop();
    }
  }
  // Mettre √† jour le label du morceau actuel dans les r√©glages

}

function applySettings() {
  const s = getSettings();
  // Taille du texte
  if (s.fontSize === 'large') {
    document.body.style.fontSize = '110%';
  } else if (s.fontSize === 'small') {
    document.body.style.fontSize = '85%';
  } else {
    document.body.style.fontSize = '';
  }
  // Th√®mes
  document.body.classList.remove('theme-dark','theme-neon');
  if (s.theme === 'dark') document.body.classList.add('theme-dark');
  else if (s.theme === 'neon') document.body.classList.add('theme-neon');
}

function renderSettings() {
  const el = document.getElementById('settingsContent');
  if (!el) return;
  const s = getSettings();
  
  const toggle = (key, label, desc) => `
    <div class="settings-item">
      <div>
        <div class="settings-label">${label}</div>
        <div class="settings-desc">${desc}</div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" ${s[key] ? 'checked' : ''} onchange="saveSetting('${key}', this.checked)">
        <span class="toggle-slider"></span>
      </label>
    </div>
  `;
  
  const select = (key, label, desc, options) => `
    <div class="settings-item">
      <div>
        <div class="settings-label">${label}</div>
        <div class="settings-desc">${desc}</div>
      </div>
      <select class="settings-select" onchange="saveSetting('${key}', this.value)">
        ${options.map(o => `<option value="${o.v}" ${s[key]===o.v?'selected':''}>${o.l}</option>`).join('')}
      </select>
    </div>
  `;
  
  el.innerHTML = `
    <div style="max-width:600px;margin:0 auto;">
      <div style="font-size:0.7rem;color:#fbbf24;margin:15px 0 8px;">üîä AUDIO</div>
      ${toggle('soundEnabled', 'üîä Sons', 'Active/d√©sactive les effets sonores')}
      ${toggle('musicEnabled', 'üéµ Musique', 'Active/d√©sactive la musique de fond')}
      
      <div style="font-size:0.7rem;color:#fbbf24;margin:20px 0 8px;">üéÆ JEU</div>
      ${toggle('particlesEnabled', '‚ú® Particules', 'Affiche les effets de particules')}
      ${toggle('screenShakeEnabled', 'üì≥ Vibration √©cran', 'Effet de secousse lors des erreurs')}
      ${toggle('timerEnabled', '‚è±Ô∏è Minuteur', 'Affiche le compte √† rebours')}
      ${toggle('autoSubmit', '‚ö° Auto-valider QCM', 'Valide automatiquement les QCM en cliquant')}
      ${toggle('comboDisplay', 'üî• Affichage combo', 'Affiche le compteur de combo')}
      ${toggle('hardMode', 'üíÄ Mode difficile', 'R√©duit le temps de r√©ponse √† 8s')}
      
      <div style="font-size:0.7rem;color:#fbbf24;margin:20px 0 8px;">üëÅÔ∏è AFFICHAGE</div>
      ${select('fontSize', 'üî§ Taille du texte', 'Ajuste la taille globale du texte', [
        {v:'small',l:'Petit'},{v:'normal',l:'Normal'},{v:'large',l:'Grand'}
      ])}
      ${select('theme', 'üé® Th√®me', 'Choisir l\'apparence', [
        {v:'default',l:'D√©faut (Bleu/Violet)'},{v:'dark',l:'Sombre'},{v:'neon',l:'N√©on'}
      ])}
      ${toggle('notifications', 'üîî Notifications', 'Affiche les notifications de jeu')}
      
      <div style="font-size:0.7rem;color:#fbbf24;margin:20px 0 8px;">üìä COMPTE</div>
      <div class="settings-item">
        <div>
          <div class="settings-label">üíæ Sauvegarde manuelle</div>
          <div class="settings-desc">Sauvegarder imm√©diatement ta progression</div>
        </div>
        <button onclick="manualSave()" style="margin:0;padding:8px 12px;font-size:0.55rem;">üíæ Sauver</button>
      </div>
      <div class="settings-item">
        <div>
          <div class="settings-label">üìã Informations</div>
          <div class="settings-desc">Version du jeu et infos</div>
        </div>
        <div style="font-size:0.5rem;color:#9ca3af;">v1.3.0</div>
      </div>
      ${player?.isAdmin ? `
      <div style="font-size:0.7rem;color:#fbbf24;margin:20px 0 8px;">üëë ADMIN</div>
      <div class="settings-item">
        <div><div class="settings-label">üîÑ Reset local</div><div class="settings-desc">R√©initialise les donn√©es locales</div></div>
        <button class="danger" style="margin:0;padding:8px 12px;font-size:0.55rem;" onclick="adminReset()">Reset</button>
      </div>
      ` : ''}
    </div>
  `;
  applySettings();
}

// SHOP
function renderShop() {
  document.getElementById('shopCoins').textContent = player.coins;
  const shopDiv = document.getElementById('shopItems');
  shopDiv.innerHTML = '';
  
  const amiDiscount = isAmiAdmin();
  
  if (amiDiscount) {
    const banner = document.createElement('div');
    banner.style.cssText = 'grid-column:1/-1;background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(190,24,93,0.2));border:2px solid #ec4899;border-radius:12px;padding:12px;text-align:center;font-size:0.6rem;margin-bottom:10px;';
    banner.innerHTML = 'üíó <span style="color:#ec4899;">Ami(e) des Admins</span> ‚Äî <span style="color:#10b981;">-10% sur tous les achats !</span>';
    shopDiv.appendChild(banner);
  }

  // Grouper par cat√©gorie
  const categories = {};
  SHOP_ITEMS.forEach(item => {
    const cat = item.category || 'Divers';
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push(item);
  });

  Object.entries(categories).forEach(([catName, items]) => {
    // Titre de cat√©gorie
    const title = document.createElement('div');
    title.style.cssText = 'grid-column: 1/-1; margin-top:20px; margin-bottom:5px; font-size:0.85rem; color:#fbbf24; border-bottom:2px solid #fbbf24; padding-bottom:8px;';
    title.textContent = catName;
    shopDiv.appendChild(title);

    items.forEach(item => {
      const finalPrice = amiDiscount ? Math.floor(item.price * 0.9) : item.price;
      const div = document.createElement('div');
      div.className = 'shop-item';
      div.innerHTML = `
        <div class="shop-item-icon">${item.emoji}</div>
        <div class="shop-item-name">${item.name}</div>
        <div class="shop-item-desc">${item.desc}</div>
        <div class="shop-item-price">üí∞ ${amiDiscount ? `<span style="text-decoration:line-through;color:#6b7280;font-size:0.65rem;">${item.price}</span> <span style="color:#ec4899;">${finalPrice}</span>` : finalPrice}</div>
        <button onclick="buyItem(${item.id})" ${player.coins < finalPrice ? 'disabled' : ''}>
          ${player.coins < finalPrice ? '‚ùå Trop cher' : '‚úÖ Acheter'}
        </button>
      `;
      shopDiv.appendChild(div);
    });
  });
}

function buyItem(id) {
  const item = SHOP_ITEMS.find(i => i.id === id);
  if (!item) return;
  
  const finalPrice = isAmiAdmin() ? Math.floor(item.price * 0.9) : item.price;
  if (player.coins < finalPrice) return;
  
  player.coins -= finalPrice;
  
  if      (id === 1)  { player.inventory.hints++; }
  else if (id === 2)  { player.inventory.skips++; }
  else if (id === 3)  { player.inventory.secondChances++; }
  else if (id === 4)  { player.coins += 500; }
  else if (id === 5)  { player.inventory.xpBoost += 10; }
  else if (id === 6 || id === 7 || id === 18 || id === 19 || id === 20 || id === 21 || id === 22 || id === 23) {
    const badge = item.emoji + ' ' + item.name;
    if (!player.badges.includes(badge)) player.badges.push(badge);
  }
  // Packs consommables
  else if (id === 8)  { player.inventory.hints += 3; }
  else if (id === 9)  { player.inventory.skips += 3; }
  else if (id === 10) { player.inventory.secondChances += 3; }
  else if (id === 11) { player.inventory.shields = (player.inventory.shields || 0) + 1; }
  else if (id === 12) { player.inventory.aimers = (player.inventory.aimers || 0) + 1; }
  else if (id === 13) { player.inventory.freezes = (player.inventory.freezes || 0) + 1; }
  // Pi√®ces
  else if (id === 14) { player.coins += 2000; }
  else if (id === 15) { player.coins += 5000; }
  // Boosts XP
  else if (id === 16) { player.inventory.xpBoost3 = (player.inventory.xpBoost3 || 0) + 10; }
  else if (id === 17) { player.inventory.coinBoost = (player.inventory.coinBoost || 0) + 20; }
  // Sp√©ciaux
  else if (id === 24) {
    const gains = [50, 100, 150, 200, 300, 500, 1000, 2000];
    const gain = gains[Math.floor(Math.random() * gains.length)];
    player.coins += gain;
    savePlayer(); renderShop(); updateHomeScreen();
    alert(`üé≤ Loterie ! Tu as gagn√© ${gain} pi√®ces !`); return;
  }
  else if (id === 25) {
    // Coffre myst√®re
    const prizes = [
      () => { player.inventory.hints += 2; return 'üí° 2 Indices'; },
      () => { player.inventory.skips += 1; return '‚è≠Ô∏è 1 Passe'; },
      () => { player.inventory.secondChances += 1; return 'üîÑ 1 Seconde Chance'; },
      () => { player.coins += 300; return 'üí∞ 300 Pi√®ces'; },
      () => { player.inventory.xpBoost += 5; return '‚ö° Boost XP √ó2 (5Q)'; },
    ];
    const prize = prizes[Math.floor(Math.random() * prizes.length)];
    const msg = prize();
    savePlayer(); renderShop(); updateHomeScreen();
    alert(`üì¶ Coffre ouvert ! Tu as gagn√© : ${msg}`); return;
  }
  else if (id === 26) {
    // Mega coffre
    const megaPrizes = [
      () => { player.inventory.hints += 5; player.inventory.skips += 2; return 'üí°√ó5 + ‚è≠Ô∏è√ó2'; },
      () => { player.coins += 1500; return 'üí∞ 1 500 Pi√®ces'; },
      () => { player.inventory.xpBoost += 10; return '‚ö° Boost XP √ó2 (10Q)'; },
      () => { player.inventory.secondChances += 3; return 'üîÑ 3 Secondes Chances'; },
      () => { player.coins += 500; player.inventory.skips += 3; return 'üí∞ 500 + ‚è≠Ô∏è√ó3'; },
    ];
    const prize = megaPrizes[Math.floor(Math.random() * megaPrizes.length)];
    const msg = prize();
    savePlayer(); renderShop(); updateHomeScreen();
    alert(`üéÅ Mega Coffre ouvert ! Gain : ${msg}`); return;
  }
  else if (id === 27) {
    sessionErrors = 0;
    updateHeartsDisplay && updateHeartsDisplay();
  }
  else if (id === 28) {
    getEnergy(); player.energy = Math.min(MAX_ENERGY, player.energy + 5); updateEnergyDisplay();
  }
  else if (id === 29) {
    player.energy = MAX_ENERGY; player.lastEnergyTime = Date.now(); updateEnergyDisplay();
  }

  savePlayer();
  playBuySound();
  alert(`üéâ ${item.name} achet√© !`);
  renderShop();
  updateHomeScreen();
}


// AVATAR
function initAvatarEditor() {
  if (player.avatarData && player.avatarData.length === GRID_SIZE * GRID_SIZE) {
    pixelData = [...player.avatarData];
  } else {
    pixelData = new Array(GRID_SIZE * GRID_SIZE).fill('#000000');
  }
  renderPixelGrid();
  renderColorPalette();
}

let isDrawing = false;

function renderPixelGrid() {
  const grid = document.getElementById('pixelGrid');
  grid.innerHTML = '';

  // Stop drawing when mouse released anywhere
  const stopDrawing = () => { isDrawing = false; };
  document.removeEventListener('mouseup', stopDrawing);
  document.removeEventListener('touchend', stopDrawing);
  document.addEventListener('mouseup', stopDrawing);
  document.addEventListener('touchend', stopDrawing);

  // Prevent scrolling while drawing on touch
  grid.addEventListener('touchmove', (e) => { if (isDrawing) e.preventDefault(); }, { passive: false });

  for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
    const pixel = document.createElement('div');
    pixel.className = 'pixel';
    pixel.style.backgroundColor = pixelData[i];
    pixel.dataset.index = i;

    const paintPixel = (el) => {
      const idx = parseInt(el.dataset.index);
      if (pixelData[idx] !== selectedColor) {
        pixelData[idx] = selectedColor;
        el.style.backgroundColor = selectedColor;
      }
    };

    // Mouse support
    pixel.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isDrawing = true;
      paintPixel(pixel);
    });
    pixel.addEventListener('mouseover', () => {
      if (isDrawing) paintPixel(pixel);
    });

    // Touch support
    pixel.addEventListener('touchstart', (e) => {
      e.preventDefault();
      isDrawing = true;
      paintPixel(pixel);
    }, { passive: false });

    grid.appendChild(pixel);
  }

  // Touch move: find element under finger and paint it
  grid.addEventListener('touchmove', (e) => {
    if (!isDrawing) return;
    const touch = e.touches[0];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if (el && el.classList.contains('pixel')) paintPixel(el);
  }, { passive: false });
}

function renderColorPalette() {
  const palette = document.getElementById('colorPalette');
  palette.innerHTML = '';
  
  COLORS.forEach(color => {
    const div = document.createElement('div');
    div.className = 'color-option';
    if (color === selectedColor) div.classList.add('selected');
    div.style.backgroundColor = color;
    div.onclick = () => {
      selectedColor = color;
      renderColorPalette();
    };
    palette.appendChild(div);
  });
}

function saveAvatar() {
  player.avatarData = [...pixelData];
  savePlayer();
  alert('üíæ Avatar sauvegard√© !');
}

function clearAvatar() {
  pixelData = new Array(GRID_SIZE * GRID_SIZE).fill('#000000');
  renderPixelGrid();
}

function randomAvatar() {
  for (let i = 0; i < pixelData.length; i++) {
    pixelData[i] = COLORS[Math.floor(Math.random() * COLORS.length)];
  }
  renderPixelGrid();
}

// ========================================
// CLASSEMENT EN LIGNE ‚Äî lit /leaderboard (public)
// ========================================
// ‚ö†Ô∏è R√àGLES FIREBASE ‚Äî Colle ceci dans Firebase Console > Realtime Database > R√®gles :
/*
====================================================
  R√àGLES FIREBASE SCHOOLMES v1.4 ‚Äî COPIER-COLLER
====================================================
{
  "rules": {

    "players": {
      "$uid": {
        ".read":  "auth != null && ($uid === auth.uid
                   || root.child('players/admin_titi/isAdmin').val()   === true
                   || root.child('players/admin_darius/isAdmin').val() === true)",
        ".write": "auth != null && ($uid === auth.uid
                   || root.child('players/admin_titi/isAdmin').val()   === true
                   || root.child('players/admin_darius/isAdmin').val() === true)"
      }
    },

    "leaderboard": {
      ".read": true,
      "$uid": {
        ".write": "auth != null && ($uid === auth.uid
                   || root.child('players/admin_titi/isAdmin').val()   === true
                   || root.child('players/admin_darius/isAdmin').val() === true)"
      }
    },

    "bans": {
      ".read": "auth != null && (root.child('players/admin_titi/isAdmin').val()   === true
                                || root.child('players/admin_darius/isAdmin').val() === true)",
      "$uid": {
        ".read":  "auth != null && $uid === auth.uid",
        ".write": "auth != null && (root.child('players/admin_titi/isAdmin').val()   === true
                                   || root.child('players/admin_darius/isAdmin').val() === true)"
      }
    },

    "presence": {
      ".read":  "auth != null",
      ".write": "auth != null"
    },

    "rooms": {
      ".read":  "auth != null",
      ".write": "auth != null"
    },

    "challenges": {
      "$uid": {
        ".read":  "auth != null && $uid === auth.uid",
        ".write": "auth != null"
      }
    },

    "anticheat": {
      ".read":  "auth != null && (root.child('players/admin_titi/isAdmin').val()   === true
                                 || root.child('players/admin_darius/isAdmin').val() === true)",
      ".write": "auth != null"
    }

  }
}
====================================================
NOTES IMPORTANTES :
  - players/$uid  : chaque joueur lit/√©crit ses propres donn√©es.
                    Les admins peuvent tout lire et modifier.
  - leaderboard   : lecture publique (non-connect√©s inclus).
                    Chaque joueur √©crit sa propre entr√©e.
                    Les admins peuvent modifier n'importe quelle entr√©e.
  - bans          : les admins lisent TOUT le n≈ìud /bans.
                    Chaque joueur connect√© peut lire SEULEMENT son propre ban
                    (n√©cessaire pour la v√©rification au login).
                    SEULS les admins peuvent bannir / d√©bannir.
  - presence      : tous les joueurs connect√©s peuvent lire/√©crire.
  - anticheat     : lecture r√©serv√©e aux admins, √©criture ouverte
                    (le client peut √©crire ses propres flags suspects).
====================================================
*/

let currentLbSort = 'maxLevel';

// Mettre √† jour le leaderboard public apr√®s chaque sauvegarde
async function updateLeaderboardEntry() {
  if (!firebaseReady || !currentUserId || currentUserId.startsWith('local_')) return;
  try {
    await database.ref('leaderboard/' + currentUserId).set({
      username: player.username,
      level: player.level || 1,
      maxLevel: player.maxLevel || 1,
      coins: player.coins || 0,
      questionsAnswered: player.stats?.questionsAnswered || 0,
      bossesDefeated: player.stats?.bossesDefeated || 0,
      avatarData: player.avatarData || null,
      playTime: player.playTime || 0,
      badges: player.badges || [],
      isAdmin: player.isAdmin === true
    });
  } catch(e) { /* silencieux */ }
}

async function renderLeaderboard(sortBy) {
  sortBy = sortBy || currentLbSort;
  currentLbSort = sortBy;

  ['lbBtnLevel','lbBtnXP','lbBtnCoins'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.className = '';
  });
  if (sortBy === 'maxLevel') document.getElementById('lbBtnLevel').className = 'primary';
  if (sortBy === 'level')    document.getElementById('lbBtnXP').className = 'primary';
  if (sortBy === 'coins')    document.getElementById('lbBtnCoins').className = 'gold';

  const listEl = document.getElementById('leaderboardList');
  const loadEl = document.getElementById('lbLoading');
  const rankEl = document.getElementById('myRank');
  listEl.innerHTML = '';
  loadEl.style.display = 'block';
  loadEl.textContent = '‚è≥ Chargement...';

  if (!firebaseReady) {
    loadEl.innerHTML = '‚ö†Ô∏è Firebase non configur√© ‚Äî classement indisponible en mode local';
    return;
  }

  try {
    // Charger tout depuis /leaderboard (admins inclus gr√¢ce au flag isAdmin)
    const snapLb = await database.ref('leaderboard').once('value');
    
    const lbData = snapLb.val();
    if (!lbData) { loadEl.textContent = 'üèúÔ∏è Aucun joueur encore inscrit au classement !'; loadEl.style.display='block'; return; }

    loadEl.style.display = 'none';

    const labels  = { maxLevel: 'Niv. carte', level: 'Niv. joueur', coins: 'Pi√®ces' };
    const icons   = { maxLevel: 'üó∫Ô∏è', level: '‚≠ê', coins: 'üí∞' };
    const rankIcons = ['ü•á','ü•à','ü•â'];

    // S√©parer admins et joueurs directement depuis /leaderboard
    const adminPlayers = [];
    const normalPlayers = [];
    
    Object.values(lbData).filter(p => p && p.username).forEach(p => {
      if (p.isAdmin === true) adminPlayers.push(p);
      else normalPlayers.push(p);
    });
    
    // Les bannis en bas de liste
    normalPlayers.sort((a, b) => {
      if (a.isBanned && !b.isBanned) return 1;
      if (!a.isBanned && b.isBanned) return -1;
      return (b[sortBy] || 0) - (a[sortBy] || 0);
    });
    adminPlayers.sort((a, b) => (b[sortBy] || 0) - (a[sortBy] || 0));

    function formatPlayTime(ms) {
      if (!ms) return '0min';
      const h = Math.floor(ms / 3600000);
      const m = Math.floor((ms % 3600000) / 60000);
      return h > 0 ? `${h}h${m}min` : `${m}min`;
    }
    
    function buildPlayerRow(p, rank, showRankIcon = true) {
      const isMe = player && p.username === player.username;
      const div = document.createElement('div');
      div.className = 'leaderboard-item' +
        (rank === 1 ? ' podium-1' : rank === 2 ? ' podium-2' : rank === 3 ? ' podium-3' : '') +
        (isMe ? ' me' : '');
      
      const badgesHtml = (p.badges || []).map(b => `<span style="font-size:0.45rem;background:rgba(251,191,36,0.2);border:1px solid #fbbf24;border-radius:8px;padding:2px 6px;margin:2px;">${b}</span>`).join('');
      const avatarCanvasId = 'lbAvatar_' + Math.random().toString(36).substr(2,6);
      
      div.innerHTML = `
        <div class="lb-rank">${showRankIcon && rank <= 3 ? rankIcons[rank-1] : '#' + rank}</div>
        <canvas id="${avatarCanvasId}" class="mini-avatar-canvas lb-avatar" width="36" height="36" style="${p.avatarData ? '' : 'display:none;'}"></canvas>
        <div class="lb-info">
          <div class="lb-name">${p.username}${isMe ? ' <span style="color:#10b981;">‚óÄ toi</span>' : ''}${p.isAdmin ? ' <span style="font-size:0.4rem;background:#fbbf24;color:#000;padding:2px 5px;border-radius:5px;">ADMIN</span>' : ''}${p.isBanned ? ' <span style="font-size:0.4rem;background:#ef4444;color:#fff;padding:2px 5px;border-radius:5px;">üö´ BANNI</span>' : ''}</div>
          <div style="margin:3px 0;">${badgesHtml}</div>
          <div class="lb-stats">Niv.${p.level||1} &nbsp;‚Ä¢&nbsp; ${p.questionsAnswered||0} Q &nbsp;‚Ä¢&nbsp; ${p.bossesDefeated||0} boss &nbsp;‚Ä¢&nbsp; ‚è±Ô∏è${formatPlayTime(p.playTime)}</div>
        </div>
        <div class="lb-score">${icons[sortBy]} ${(p[sortBy]||0).toLocaleString()}<br><span style="font-size:0.45rem;color:#9ca3af;">${labels[sortBy]}</span></div>
      `;
      
      if (p.avatarData) {
        setTimeout(() => {
          const canvas = document.getElementById(avatarCanvasId);
          if (canvas) drawMiniAvatar(canvas, p.avatarData, 36);
        }, 50);
      }
      return div;
    }

    // Section Admins
    if (adminPlayers.length > 0) {
      const adminTitle = document.createElement('div');
      adminTitle.className = 'lb-section-title admin-section';
      adminTitle.innerHTML = 'üëë ADMINS';
      listEl.appendChild(adminTitle);
      adminPlayers.forEach((p, i) => listEl.appendChild(buildPlayerRow(p, i+1, false)));
    }
    
    // Section Joueurs
    const playersTitle = document.createElement('div');
    playersTitle.className = 'lb-section-title players-section';
    playersTitle.innerHTML = `üéÆ JOUEURS (${normalPlayers.length})`;
    listEl.appendChild(playersTitle);
    normalPlayers.slice(0, 50).forEach((p, i) => listEl.appendChild(buildPlayerRow(p, i+1)));

    if (player) {
      const myIdx = normalPlayers.findIndex(p => p.username === player.username);
      rankEl.textContent = myIdx >= 0
        ? `üéØ Ton classement : #${myIdx + 1} sur ${normalPlayers.length} joueurs`
        : `üë§ ${normalPlayers.length} joueurs au classement`;
    }
  } catch(e) {
    loadEl.innerHTML = `‚ùå Erreur : ${e.message}<br><span style="font-size:0.55rem;color:#9ca3af;">V√©rifie les r√®gles Firebase</span>`;
    loadEl.style.display = 'block';
  }
}

// ========================================
// ADMIN ‚Äî PANEL DONNER
// ========================================

// Dessine un mini-avatar pixel art sur un canvas √† partir d'avatarData
function drawMiniAvatar(canvas, avatarData, size) {
  if (!avatarData || avatarData.length !== GRID_SIZE * GRID_SIZE) return false;
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  const pixelSize = size / GRID_SIZE;
  for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
    const x = (i % GRID_SIZE) * pixelSize;
    const y = Math.floor(i / GRID_SIZE) * pixelSize;
    ctx.fillStyle = avatarData[i] || '#000000';
    ctx.fillRect(x, y, pixelSize, pixelSize);
  }
  return true;
}

function updateHomeScreen() {
  if (!player) return;
  document.getElementById('homeUsername').textContent = player.username;
  document.getElementById('homeLevel').textContent = player.level;
  document.getElementById('homeCoins').textContent = player.coins;
  document.getElementById('homeXP').textContent = player.xp;

  // Mini avatar √† l'accueil
  const homeCanvas = document.getElementById('homeAvatarCanvas');
  if (player.avatarData && drawMiniAvatar(homeCanvas, player.avatarData, 40)) {
    homeCanvas.style.display = 'inline-block';
  } else {
    homeCanvas.style.display = 'none';
  }

  let badgesHTML = '';
  if (player.isAdmin) badgesHTML += '<div class="badge admin">üëë ADMIN</div>';
  (player.badges || []).forEach(b => {
    let cls = 'badge';
    if (b === 'üíó Ami(e) des Admins') cls = 'badge ami-admin';
    else if (b === 'üéñÔ∏è OJ') cls = 'badge oj';
    badgesHTML += `<div class="${cls}">${b}</div>`;
  });
  
  // Prestige badge
  if (player.prestigeLevel) badgesHTML += `<span class="prestige-badge">‚≠ê Prestige ${player.prestigeLevel}</span>`;
  
  // League badge
  const league = getLeague(player.maxLevel || 1);
  badgesHTML += `<span class="league-badge ${league.class}">${league.emoji} ${league.name}</span>`;
  
  document.getElementById('homePlayerBadges').innerHTML = badgesHTML;

  const firebaseStatus = document.getElementById('firebaseStatus');
  if (firebaseReady && currentUserId && !currentUserId.startsWith('local_')) {
    firebaseStatus.innerHTML = '<span style="color:#10b981;">üî• Firebase actif ‚Äî sauvegarde cloud toutes les 30s</span>';
    firebaseStatus.style.display = 'block';
  } else {
    firebaseStatus.innerHTML = '<span style="color:#f59e0b;">üíæ Mode local ‚Äî configure Firebase pour le cloud</span>';
    firebaseStatus.style.display = 'block';
  }
  
  // Afficher le bouton r√©glages
  const gearBtn = document.getElementById('settingsGearBtn');
  if (gearBtn) gearBtn.style.display = 'block';

  if (player.isAdmin) {
    document.getElementById('adminPanelHome').innerHTML = `
      <div class="admin-panel">
        <h3 style="color:#fbbf24;margin-bottom:15px;">‚öôÔ∏è PANNEAU ADMIN</h3>
        <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:10px;">
          <button class="gold" onclick="openAdminGive()">üéÅ Donner √† un joueur</button>
          <button class="gold" onclick="adminGiveAll()">üåç Donner √† TOUS</button>
          <button class="danger" onclick="openAdminBan()">üî® Bannir / D√©bannir</button>
          <button class="danger" onclick="adminReset()">üîÑ Reset local</button>
          <button style="background:linear-gradient(135deg,#7c3aed,#6d28d9);" onclick="triggerRandomEvent()">‚ö° D√©clencher √âv√©nement</button>
          <button style="background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000;" onclick="openPrestigeModal()">‚≠ê Test Prestige</button>
        </div>
      </div>
    `;
  } else {
    document.getElementById('adminPanelHome').innerHTML = '';
  }

  // Addictive features
  updateEnergyDisplay();
  checkDailyLogin();
  getDailyQuests();
  renderQuestsPreview();
  refreshEventBanner();
  
  // Show prestige button if eligible
  if (canPrestige()) {
    const existing = document.getElementById('prestigeBtn');
    if (!existing) {
      const btn = document.createElement('button');
      btn.id = 'prestigeBtn';
      btn.style.cssText = 'background:linear-gradient(135deg,#ffd700,#ff6b00);color:#000;width:100%;margin:10px 0;padding:15px;font-size:0.8rem;border:3px solid #fff;box-shadow:0 0 30px rgba(255,215,0,0.7);animation:eventPulse 2s infinite;';
      btn.innerHTML = '‚≠ê PRESTIGE DISPONIBLE ! Clique pour recommencer avec des bonus !';
      btn.onclick = openPrestigeModal;
      document.getElementById('dailyQuestBanner').before(btn);
    }
  }
}

async function openAdminGive() {
  if (!player?.isAdmin || !firebaseReady) {
    alert('‚ùå Firebase requis pour cette action.');
    return;
  }

  // Charger la liste depuis /leaderboard (accessible publiquement)
  const snap = await database.ref('leaderboard').once('value');
  const data = snap.val() || {};
  const entries = Object.entries(data).filter(([, p]) => p.username);

  if (entries.length === 0) {
    alert('Aucun joueur trouv√© dans le classement.');
    return;
  }

  const overlay = document.createElement('div');
  overlay.id = 'adminOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:20000;overflow-y:auto;padding:20px;';
  overlay.innerHTML = `
    <div style="max-width:700px;margin:0 auto;background:#1a1a2e;border:3px solid #fbbf24;border-radius:20px;padding:25px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="color:#fbbf24;font-size:0.9rem;">üéÅ DONNER √Ä UN JOUEUR</h2>
        <button class="danger" style="margin:0;" onclick="document.getElementById('adminOverlay').remove()">‚úñ</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div>
          <div style="font-size:0.6rem;color:#9ca3af;margin-bottom:6px;">üë§ Joueur cible</div>
          <select id="ag_target" style="width:100%;background:#000;color:#fff;border:2px solid #fbbf24;border-radius:8px;padding:10px;font-family:'Press Start 2P';font-size:0.6rem;">
            ${entries.map(([uid, p]) => `<option value="${uid}">${p.username} (Niv.${p.level||1} ‚Ä¢ üó∫Ô∏è${p.maxLevel||1} ‚Ä¢ üí∞${p.coins||0})</option>`).join('')}
          </select>
        </div>
        <div>
          <div style="font-size:0.6rem;color:#9ca3af;margin-bottom:6px;">üéÅ Type de r√©compense</div>
          <select id="ag_type" style="width:100%;background:#000;color:#fff;border:2px solid #fbbf24;border-radius:8px;padding:10px;font-family:'Press Start 2P';font-size:0.6rem;">
            <option value="coins">üí∞ Pi√®ces</option>
            <option value="xp">‚ú® XP</option>
            <option value="hints">üí° Indices</option>
            <option value="skips">‚è≠Ô∏è Passes</option>
            <option value="secondChances">üîÑ 2√®mes Chances</option>
            <option value="xpBoost">‚ö° Boost XP</option>
            <option value="badge">üèÖ Badge (texte)</option>
          </select>
        </div>
        <div>
          <div style="font-size:0.6rem;color:#9ca3af;margin-bottom:6px;">üî¢ Quantit√© / Texte badge</div>
          <input id="ag_amount" type="text" placeholder="ex: 500 ou üéñÔ∏è H√©ros" style="width:100%;background:#000;color:#fff;border:2px solid #fbbf24;border-radius:8px;padding:10px;font-family:'Press Start 2P';font-size:0.6rem;">
        </div>
        <button class="gold" style="width:100%;padding:15px;" onclick="adminGiveOne()">‚úÖ DONNER</button>
      </div>
      <div style="margin-top:20px;">
        <div style="font-size:0.6rem;color:#9ca3af;margin-bottom:10px;">üë• Tous les joueurs (${entries.length})</div>
        <div style="max-height:200px;overflow-y:auto;">
          ${entries.map(([, p]) => `
            <div style="display:flex;justify-content:space-between;padding:8px 10px;margin:4px 0;background:rgba(255,255,255,0.05);border-radius:8px;font-size:0.55rem;">
              <span style="color:#fbbf24;">${p.username}</span>
              <span>Niv.${p.level||1}</span>
              <span>üó∫Ô∏è${p.maxLevel||1}</span>
              <span>üí∞${p.coins||0}</span>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

async function adminGiveOne() {
  const uid = document.getElementById('ag_target').value;
  const type = document.getElementById('ag_type').value;
  const amount = document.getElementById('ag_amount').value.trim();
  if (!uid || !amount) { alert('‚ö†Ô∏è Remplis tous les champs !'); return; }

  try {
    // Modifier les donn√©es du joueur dans /players
    const snap = await database.ref('players/' + uid).once('value');
    const target = snap.val();
    if (!target) { alert('‚ùå Joueur introuvable dans la DB.'); return; }

    if (!target.inventory) target.inventory = { hints:0, skips:0, secondChances:0, xpBoost:0 };
    if (!target.badges) target.badges = [];

    if (type === 'coins') target.coins = (target.coins||0) + parseInt(amount);
    else if (type === 'xp') target.xp = (target.xp||0) + parseInt(amount);
    else if (type === 'badge') { if (!target.badges.includes(amount)) target.badges.push(amount); }
    else target.inventory[type] = (target.inventory[type]||0) + parseInt(amount);

    await database.ref('players/' + uid).set(target);

    // Mettre √† jour le leaderboard public aussi
    await database.ref('leaderboard/' + uid).update({
      username: target.username,
      level: target.level || 1,
      maxLevel: target.maxLevel || 1,
      coins: target.coins || 0
    });

    alert(`‚úÖ ${amount} ${type} donn√© √† ${target.username} !`);
    document.getElementById('adminOverlay')?.remove();
  } catch(e) {
    alert('‚ùå Erreur : ' + e.message);
  }
}

async function adminGiveAll() {
  if (!player?.isAdmin || !firebaseReady) {
    alert('‚ùå Firebase requis pour cette action.');
    return;
  }

  const overlay = document.createElement('div');
  overlay.id = 'adminGiveAllOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:20000;overflow-y:auto;padding:20px;';
  overlay.innerHTML = `
    <div style="max-width:600px;margin:0 auto;background:#1a1a2e;border:3px solid #fbbf24;border-radius:20px;padding:25px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="color:#fbbf24;font-size:0.9rem;">üåç DONNER √Ä TOUS LES JOUEURS</h2>
        <button class="danger" style="margin:0;" onclick="document.getElementById('adminGiveAllOverlay').remove()">‚úñ</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div>
          <div style="font-size:0.6rem;color:#9ca3af;margin-bottom:6px;">üéÅ Type de r√©compense</div>
          <select id="aga_type" style="width:100%;background:#000;color:#fff;border:2px solid #fbbf24;border-radius:8px;padding:10px;font-family:'Press Start 2P';font-size:0.6rem;">
            <option value="coins">üí∞ Pi√®ces</option>
            <option value="xp">‚ú® XP</option>
            <option value="hints">üí° Indices</option>
            <option value="skips">‚è≠Ô∏è Passes</option>
            <option value="secondChances">üîÑ 2√®mes Chances</option>
            <option value="xpBoost">‚ö° Boost XP</option>
            <option value="badge">üèÖ Badge (texte)</option>
          </select>
        </div>
        <div>
          <div style="font-size:0.6rem;color:#9ca3af;margin-bottom:6px;">üî¢ Quantit√© / Texte badge</div>
          <input id="aga_amount" type="text" placeholder="ex: 500 ou üéñÔ∏è H√©ros" style="width:100%;background:#000;color:#fff;border:2px solid #fbbf24;border-radius:8px;padding:10px;font-family:'Press Start 2P';font-size:0.6rem;">
        </div>
        <div style="background:rgba(239,68,68,0.15);border:2px solid #ef4444;border-radius:10px;padding:12px;font-size:0.6rem;color:#fca5a5;">
          ‚ö†Ô∏è Cette action modifie TOUS les joueurs existants en Firebase !
        </div>
        <button class="gold" style="width:100%;padding:15px;" onclick="confirmGiveAll()">üåç DONNER √Ä TOUS</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

async function confirmGiveAll() {
  const type = document.getElementById('aga_type').value;
  const amount = document.getElementById('aga_amount').value.trim();
  if (!amount) { alert('‚ö†Ô∏è Remplis le montant !'); return; }
  if (!confirm(`‚ö†Ô∏è Donner "${amount}" (${type}) √† TOUS les joueurs Firebase ?`)) return;

  document.getElementById('adminGiveAllOverlay').remove();

  try {
    const snap = await database.ref('players').once('value');
    const data = snap.val() || {};
    const updates = {};
    let count = 0;

    for (const [uid, p] of Object.entries(data)) {
      if (p.isAdmin) continue;
      const updated = JSON.parse(JSON.stringify(p)); // deep copy
      if (!updated.inventory) updated.inventory = { hints:0, skips:0, secondChances:0, xpBoost:0 };
      if (!updated.badges) updated.badges = [];

      if (type === 'coins') updated.coins = (updated.coins||0) + parseInt(amount);
      else if (type === 'xp') updated.xp = (updated.xp||0) + parseInt(amount);
      else if (type === 'badge') { if (!updated.badges.includes(amount)) updated.badges.push(amount); }
      else updated.inventory[type] = (updated.inventory[type]||0) + parseInt(amount);

      updates['players/' + uid] = updated;

      // Mettre √† jour le leaderboard public
      updates['leaderboard/' + uid] = {
        username: updated.username,
        level: updated.level || 1,
        maxLevel: updated.maxLevel || 1,
        coins: updated.coins || 0,
        questionsAnswered: updated.stats?.questionsAnswered || 0,
        bossesDefeated: updated.stats?.bossesDefeated || 0
      };
      count++;
    }

    await database.ref().update(updates);
    alert(`‚úÖ Don "${amount}" (${type}) envoy√© √† ${count} joueurs !`);
  } catch(e) {
    alert('‚ùå Erreur : ' + e.message);
  }
}

function adminReset() {
  if (!player?.isAdmin) return;
  if (confirm('‚ö†Ô∏è R√©initialiser les donn√©es locales ?')) {
    localStorage.removeItem('schoolmesAccounts');
    alert('‚úÖ Local r√©initialis√© !');
    location.reload();
  }
}

// ========================================
// üéØ M√âCANIQUES ADDICTIVES
// ========================================

// --- 1. COMBO & STREAK SYSTEM ---
let comboCount = 0;
let comboTimer = null;
let questionTimer = null;
let questionTimeLeft = 15;
const COMBO_TIMEOUT = 8000; // 8 secondes entre bonnes r√©ponses pour garder le combo

function resetCombo() {
  comboCount = 0;
  updateComboDisplay();
}

function incrementCombo() {
  comboCount++;
  clearTimeout(comboTimer);
  comboTimer = setTimeout(resetCombo, COMBO_TIMEOUT);
  updateComboDisplay();
  announceCombo();
}

function getComboMultiplier() {
  if (comboCount >= 10) return 5;
  if (comboCount >= 7) return 4;
  if (comboCount >= 5) return 3;
  if (comboCount >= 3) return 2;
  return 1;
}

function updateComboDisplay() {
  const el = document.getElementById('comboDisplay');
  if (!el) return;
  if (!getSettings().comboDisplay || comboCount < 2) { el.innerHTML = ''; return; }
  const mult = getComboMultiplier();
  let cls = 'combo-badge';
  if (comboCount >= 10) cls += ' ultra';
  else if (comboCount >= 5) cls += ' mega';
  el.innerHTML = `<div class="${cls}">üî• COMBO x${comboCount}<br><span style="font-size:0.5rem;">√ó${mult} XP/üí∞</span></div>`;
}

function announceCombo() {
  const el = document.getElementById('comboAnnouncement');
  if (!el) return;
  const msgs = { 3:'üî• COMBO!', 5:'üí• SUPER COMBO!', 7:'‚ö° MEGA COMBO!', 10:'üåü ULTRA COMBO!', 15:'üëë LEGENDARY!', 20:'üåå GODLIKE!!' };
  const msg = msgs[comboCount];
  if (!msg) return;
  el.textContent = msg;
  el.classList.remove('show');
  void el.offsetWidth;
  el.classList.add('show');
  playComboSound(comboCount);
  setTimeout(() => el.classList.remove('show'), 1500);
}

// --- TIMER SYSTEM ---
function startQuestionTimer() {
  clearInterval(questionTimer);
  const s = getSettings();
  const maxTime = s.hardMode ? 8 : 15;
  questionTimeLeft = maxTime;
  document.getElementById('timerBar').style.display = s.timerEnabled ? 'block' : 'none';
  document.getElementById('timerText').style.display = s.timerEnabled ? 'block' : 'none';
  updateTimerDisplay();
  questionTimer = setInterval(() => {
    questionTimeLeft--;
    updateTimerDisplay();
    if (questionTimeLeft <= 0) {
      clearInterval(questionTimer);
    }
  }, 1000);
}

function updateTimerDisplay() {
  const countdown = document.getElementById('timerCountdown');
  const fill = document.getElementById('timerFill');
  if (!countdown || !fill) return;
  countdown.textContent = Math.max(0, questionTimeLeft);
  const pct = (questionTimeLeft / 15) * 100;
  fill.style.width = pct + '%';
  if (questionTimeLeft <= 5) fill.style.background = '#ef4444';
  else if (questionTimeLeft <= 10) fill.style.background = 'linear-gradient(90deg,#fbbf24,#ef4444)';
  else fill.style.background = 'linear-gradient(90deg,#10b981,#fbbf24)';
}

function getTimeBonus() {
  if (questionTimeLeft >= 12) return 3;
  if (questionTimeLeft >= 8) return 2;
  if (questionTimeLeft >= 4) return 1;
  return 0;
}

// --- 2. PARTICLES & SOUND ---
function spawnParticles(x, y, type = 'correct') {
  if (!getSettings().particlesEnabled) return;
  const container = document.getElementById('particles');
  if (!container) return;
  const emojis = type === 'correct' ? ['‚ú®','‚≠ê','üí´','üåü','üí•'] : ['üí¢','‚ùå','üíî'];
  for (let i = 0; i < 6; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    p.style.left = (x + (Math.random()-0.5)*100) + 'px';
    p.style.top = (y + (Math.random()-0.5)*50) + 'px';
    p.style.animationDelay = (Math.random()*0.3) + 's';
    container.appendChild(p);
    setTimeout(() => p.remove(), 2000);
  }
}

function screenShake(intensity = 'light') {
  if (!getSettings().screenShakeEnabled) return;
  const screens = document.querySelectorAll('.screen.active');
  screens.forEach(s => {
    s.classList.add('shake');
    setTimeout(() => s.classList.remove('shake'), 400);
  });
}

function _sfxCtx() {
  // R√©utiliser le contexte audio de MUSIC (√©vite le quota de 6 AudioContext)
  try {
    if (typeof MUSIC !== 'undefined' && MUSIC._getCtx) {
      const ctx = MUSIC._getCtx();
      if (ctx) return ctx;
    }
  } catch(e) {}
  // Fallback : contexte unique pour les SFX
  if (!window._sfxAudioCtx) {
    window._sfxAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (window._sfxAudioCtx.state === 'suspended') window._sfxAudioCtx.resume().catch(()=>{});
  return window._sfxAudioCtx;
}

function playComboSound(combo) {
  if (!getSettings().soundEnabled) return;
  try {
    const ctx = _sfxCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    const baseFreq = 440 + Math.min(combo, 20) * 30;
    osc.frequency.setValueAtTime(baseFreq, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.5, ctx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.3);
  } catch(e) {}
}

function playCorrectSound() {
  if (!getSettings().soundEnabled) return;
  try {
    const ctx = _sfxCtx();
    [523, 659, 784].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.08);
      gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + i * 0.08 + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.08 + 0.2);
      osc.start(ctx.currentTime + i * 0.08);
      osc.stop(ctx.currentTime + i * 0.08 + 0.25);
    });
  } catch(e) {}
}

function playWrongSound() {
  if (!getSettings().soundEnabled) return;
  try {
    const ctx = _sfxCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'square';
    osc.frequency.setValueAtTime(200, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.3);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.3);
  } catch(e) {}
}

function playLevelUpSound() {
  if (!getSettings().soundEnabled) return;
  try {
    const ctx = _sfxCtx();
    const freqs = [523, 659, 784, 1047];
    freqs.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.12);
      gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + i * 0.12 + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.12 + 0.35);
      osc.start(ctx.currentTime + i * 0.12);
      osc.stop(ctx.currentTime + i * 0.12 + 0.4);
    });
  } catch(e) {}
}

function playBuySound() {
  if (!getSettings().soundEnabled) return;
  try {
    const ctx = _sfxCtx();
    [800, 1000].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.1);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.2);
      osc.start(ctx.currentTime + i * 0.1);
      osc.stop(ctx.currentTime + i * 0.1 + 0.25);
    });
  } catch(e) {}
}

function playBossSound() {
  if (!getSettings().soundEnabled) return;
  try {
    const ctx = _sfxCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(100, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(60, ctx.currentTime + 0.5);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.5);
  } catch(e) {}
}

function playClickSound() {
  if (!getSettings().soundEnabled) return;
  try {
    const ctx = _sfxCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = 1200;
    gain.gain.setValueAtTime(0.05, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.05);
  } catch(e) {}
}

// ============================================================
// üéµ MOTEUR MUSICAL SCHOOLMES ‚Äî Web Audio API Chiptune Engine
// 3 morceaux : Home / Quiz / Boss + Victoire
// ============================================================

const MUSIC = {
  _ctx: null,
  _masterGain: null,
  _nodes: [],          // Tous les nodes actifs (pour les stopper)
  _timeouts: [],       // Tous les timeouts (pour les annuler)
  _loopTimer: null,
  _currentSong: null,
  _isPlaying: false,
  _volume: 0.18,

  // --- Fr√©quences des notes ---
  N: {
    '_' : 0,  // silence
    // Octave 3
    C3:130.81, D3:146.83, E3:164.81, F3:174.61, G3:196.00, A3:220.00, B3:246.94,
    Bb3:233.08, Eb3:155.56,
    // Octave 4
    C4:261.63, D4:293.66, E4:329.63, F4:349.23, G4:392.00, A4:440.00, B4:493.88,
    Cs4:277.18, Ds4:311.13, Fs4:369.99, Gs4:415.30, Bb4:466.16, Eb4:311.13,
    // Octave 5
    C5:523.25, D5:587.33, E5:659.25, F5:698.46, G5:783.99, A5:880.00, B5:987.77,
    Cs5:554.37, Ds5:622.25, Fs5:739.99, Gs5:830.61, Bb5:932.33,
    // Octave 6
    C6:1046.5, D6:1174.7, E6:1318.5,
  },

  _getCtx() {
    if (!this._ctx || this._ctx.state === 'closed') {
      this._ctx = new (window.AudioContext || window.webkitAudioContext)();
      this._masterGain = null;
    }
    if (!this._masterGain) {
      this._masterGain = this._ctx.createGain();
      this._masterGain.gain.value = this._volume;
      this._masterGain.connect(this._ctx.destination);
    }
    // Resume si suspendu (autoris√© car appel√© depuis event handler via showScreen/clic)
    if (this._ctx.state === 'suspended') {
      this._ctx.resume().catch(()=>{});
    }
    return this._ctx;
  },

  // Joue une note individuelle
  _note(freq, startTime, duration, type='square', vol=0.15, detune=0) {
    if (!freq) return;
    const ctx = this._getCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    if (detune) osc.detune.value = detune;
    const att = 0.01;
    const rel = Math.min(0.08, duration * 0.3);
    gain.gain.setValueAtTime(0, startTime);
    gain.gain.linearRampToValueAtTime(vol, startTime + att);
    gain.gain.setValueAtTime(vol, startTime + duration - rel);
    gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
    osc.connect(gain);
    gain.connect(this._masterGain);
    osc.start(startTime);
    osc.stop(startTime + duration + 0.01);
    this._nodes.push(osc, gain);
  },

  // Joue un accord (array de fr√©quences)
  _chord(freqs, startTime, duration, type='sine', vol=0.07) {
    freqs.forEach(f => this._note(f, startTime, duration, type, vol));
  },

  // Bruit de batterie (kick/snare/hihat)
  _drum(type, startTime, vol=0.4) {
    const ctx = this._getCtx();
    const buf = ctx.createBuffer(1, ctx.sampleRate * 0.3, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
    const src = ctx.createBufferSource();
    src.buffer = buf;
    const gain = ctx.createGain();
    const filter = ctx.createBiquadFilter();
    src.connect(filter); filter.connect(gain); gain.connect(this._masterGain);

    if (type === 'kick') {
      filter.type = 'lowpass'; filter.frequency.value = 120;
      const osc = ctx.createOscillator();
      const oscGain = ctx.createGain();
      osc.connect(oscGain); oscGain.connect(this._masterGain);
      osc.frequency.setValueAtTime(160, startTime);
      osc.frequency.exponentialRampToValueAtTime(40, startTime + 0.15);
      oscGain.gain.setValueAtTime(vol, startTime);
      oscGain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.25);
      osc.start(startTime); osc.stop(startTime + 0.3);
      gain.gain.setValueAtTime(vol * 0.3, startTime);
      gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.1);
      this._nodes.push(osc, oscGain);
    } else if (type === 'snare') {
      filter.type = 'highpass'; filter.frequency.value = 1500;
      gain.gain.setValueAtTime(vol * 0.5, startTime);
      gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.15);
    } else if (type === 'hihat') {
      filter.type = 'highpass'; filter.frequency.value = 8000;
      gain.gain.setValueAtTime(vol * 0.25, startTime);
      gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.04);
    } else if (type === 'openhat') {
      filter.type = 'highpass'; filter.frequency.value = 6000;
      gain.gain.setValueAtTime(vol * 0.3, startTime);
      gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.12);
    }
    src.start(startTime); src.stop(startTime + 0.3);
    this._nodes.push(src, gain, filter);
  },

  stop() {
    this._isPlaying = false;
    this._currentSong = null;
    clearTimeout(this._loopTimer);
    const ind = document.getElementById('musicIndicator');
    if (ind) ind.classList.remove('show');
    this._timeouts.forEach(t => clearTimeout(t));
    this._timeouts = [];
    this._nodes.forEach(n => { try { n.stop && n.stop(); n.disconnect && n.disconnect(); } catch(e){} });
    this._nodes = [];
    // Remettre le gain √† sa valeur normale pour la prochaine lecture
    if (this._masterGain) {
      try {
        this._masterGain.gain.cancelScheduledValues(this._ctx.currentTime);
        this._masterGain.gain.setValueAtTime(this._volume, this._ctx.currentTime);
      } catch(e){}
    }
  },

  play(songName) {
    this.stop();
    if (!getSettings().musicEnabled) return;
    this._currentSong = songName;
    this._isPlaying = true;
    if (this._masterGain) {
      try {
        this._masterGain.gain.cancelScheduledValues(this._ctx ? this._ctx.currentTime : 0);
        this._masterGain.gain.value = this._volume;
      } catch(e) {}
    }
    const songs = { home: this._playHome, quiz: this._playQuiz, boss: this._playBoss };
    const fn = songs[songName];
    if (fn) { try { fn.call(this); } catch(e) { console.warn('Music play error:', e); this._isPlaying = false; } }
    // Mettre √† jour l'indicateur
    const ind = document.getElementById('musicIndicator');
    const indLbl = document.getElementById('musicIndicatorLabel');
    if (ind && indLbl) {
      const names = { home:'üè† Home', quiz:'üß† Quiz', boss:'üíÄ Boss' };
      indLbl.textContent = names[songName] || songName;
      ind.classList.add('show');
    }
    // Label dans r√©glages

  },

  // Replanifie la boucle
  _loop(songName, durationMs) {
    this._loopTimer = setTimeout(() => {
      if (this._isPlaying && this._currentSong === songName && getSettings().musicEnabled) {
        this.play(songName);
      }
    }, durationMs - 100);
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üè† HOME THEME ‚Äî "Schoolmes Adventure"
  // Chiptune joyeux, 135 BPM, Do majeur
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  _playHome() {
    const ctx = this._getCtx();
    const t0 = ctx.currentTime + 0.05;
    const B = 60 / 135;      // dur√©e d'un beat (0.444s)
    const S = B / 2;         // double-croche
    const E = B / 4;         // triple-croche
    const N = this.N;

    // ‚Äî M√âLODIE principale (lead ‚Äî carr√©) ‚Äî
    const melody = [
      // Mesure 1 : mont√©e joyeuse
      [N.E5,B],[N.G5,B],[N.A5,B],[N.C6,B],
      // Mesure 2
      [N.B5,B*1.5],[N.A5,S],[N.G5,B],[N.E5,B],
      // Mesure 3
      [N.D5,B],[N.F5,B],[N.G5,B],[N.E5,B],
      // Mesure 4 : chute + pause
      [N.C5,B*2],[N._,B],[N.G5,B],
      // Mesure 5
      [N.A5,B],[N.G5,S],[N.F5,S],[N.E5,B],[N.D5,B],
      // Mesure 6
      [N.C5,B],[N.E5,B],[N.G5,B],[N.C6,B],
      // Mesure 7
      [N.B5,S],[N.A5,S],[N.G5,B],[N.F5,B],[N.E5,B],
      // Mesure 8 : r√©solution
      [N.C5,B*2],[N._,B*2],
    ];
    let mt = t0;
    melody.forEach(([f, d]) => {
      if (f) this._note(f, mt, d * 0.85, 'square', 0.13);
      mt += d;
    });

    // ‚Äî CONTRECHANT (sine plus doux, une octave en dessous) ‚Äî
    const counter = [
      [N.C5,B*2],[N.E5,B*2],
      [N.G4,B*2],[N.C5,B*2],
      [N.F4,B*2],[N.A4,B*2],
      [N.G4,B*2],[N.C4,B*2],
      [N.A4,B*2],[N.F4,B*2],
      [N.C5,B*2],[N.E5,B*2],
      [N.G4,B*2],[N.B4,B*2],
      [N.C5,B*4],
    ];
    let ct = t0;
    counter.forEach(([f, d]) => {
      if (f) this._note(f, ct, d * 0.7, 'sine', 0.07);
      ct += d;
    });

    // ‚Äî BASSE (sawtooth) ‚Äî
    const bassLine = [
      N.C3,N.C3, N.G3,N.G3,  N.A3,N.A3, N.E3,N.E3,
      N.F3,N.F3, N.C3,N.C3,  N.G3,N.G3, N.C3,N.C3,
    ];
    let bt = t0;
    bassLine.forEach(f => {
      this._note(f, bt, B * 0.7, 'sawtooth', 0.09);
      bt += B;
    });

    // ‚Äî ACCORDS d'accompagnement (triangle, toutes les 2 mesures) ‚Äî
    const chords = [
      [[N.C4,N.E4,N.G4], B*4],
      [[N.A3,N.C4,N.E4], B*4],
      [[N.F3,N.A3,N.C4], B*4],
      [[N.G3,N.B3,N.D4], B*4],
    ];
    let cht = t0;
    chords.forEach(([fs, dur]) => {
      this._chord(fs, cht, dur * 0.6, 'triangle', 0.055);
      cht += dur;
    });

    // ‚Äî BATTERIE chiptune ‚Äî
    const totalBeats = 16;
    for (let beat = 0; beat < totalBeats; beat++) {
      const bt2 = t0 + beat * B;
      // Kick sur temps 1 et 3
      if (beat % 4 === 0 || beat % 4 === 2) this._drum('kick', bt2, 0.5);
      // Snare sur temps 2 et 4
      if (beat % 4 === 1 || beat % 4 === 3) this._drum('snare', bt2, 0.45);
      // Hihat toutes les croches
      this._drum('hihat', bt2, 0.3);
      this._drum('hihat', bt2 + S, 0.2);
      // Open hat sur les off-beats
      if (beat % 2 === 1) this._drum('openhat', bt2 + S, 0.25);
    }

    const totalMs = (B * 16 + 0.1) * 1000;
    this._loop('home', totalMs);
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üß† QUIZ THEME ‚Äî "Focus Protocol"
  // Tendu, √©lectro, 120 BPM, La mineur
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  _playQuiz() {
    const ctx = this._getCtx();
    const t0 = ctx.currentTime + 0.05;
    const B = 60 / 120;   // 0.5s
    const S = B / 2;
    const N = this.N;

    // ‚Äî ARP√àGE de lead puls√© (carr√©) ‚Äî
    const arp = [
      N.A4,N.C5,N.E5,N.A5, N.A4,N.C5,N.E5,N.G5,
      N.F4,N.A4,N.C5,N.F5, N.F4,N.A4,N.C5,N.E5,
      N.G4,N.B4,N.D5,N.G5, N.G4,N.B4,N.D5,N.F5,
      N.A4,N.C5,N.E5,N.A5, N.A4,N.E5,N.A5,N.E6||N.A5,
    ];
    let at = t0;
    arp.forEach(f => {
      this._note(f, at, S * 0.6, 'square', 0.10);
      at += S;
    });

    // ‚Äî BASSE puls√©e (sawtooth, basse fr√©quence) ‚Äî
    const bassNotes = [
      N.A3,N._,N.A3,N._, N.A3,N._,N.C4,N._,
      N.F3,N._,N.F3,N._, N.F3,N._,N.A3,N._,
      N.G3,N._,N.G3,N._, N.G3,N._,N.D4,N._,
      N.A3,N._,N.A3,N._, N.A3,N.E4,N._,N._,
    ];
    let bbt = t0;
    bassNotes.forEach(f => {
      if (f) this._note(f, bbt, S * 0.55, 'sawtooth', 0.13);
      bbt += S;
    });

    // ‚Äî PAD harmonique (sine, fond ambiant) ‚Äî
    const padChords = [
      [[N.A3,N.C4,N.E4], B*4],
      [[N.F3,N.A3,N.C4], B*4],
      [[N.G3,N.B3,N.D4], B*4],
      [[N.A3,N.C4,N.E4], B*4],
    ];
    let pt = t0;
    padChords.forEach(([fs, dur]) => {
      this._chord(fs, pt, dur * 0.95, 'sine', 0.04);
      pt += dur;
    });

    // ‚Äî CONTREPOINT (triangle, motif r√©p√©titif) ‚Äî
    const counter2 = [
      N.E5,N.D5,N.C5,N.B4, N.A4,N.B4,N.C5,N.D5,
      N.C5,N.A4,N.F4,N.A4, N.C5,N.E5,N.D5,N.C5,
    ];
    let c2t = t0 + B * 8;
    counter2.forEach(f => {
      this._note(f, c2t, S * 0.5, 'triangle', 0.07);
      c2t += S;
    });

    // ‚Äî BATTERIE √©lectronique ‚Äî
    const totalBeats = 16;
    for (let beat = 0; beat < totalBeats; beat++) {
      const bt2 = t0 + beat * B;
      if (beat % 4 === 0) this._drum('kick', bt2, 0.55);
      if (beat % 4 === 2) this._drum('kick', bt2, 0.4);
      if (beat % 4 === 1 || beat % 4 === 3) this._drum('snare', bt2, 0.4);
      // Hihat double (groove)
      this._drum('hihat', bt2, 0.25);
      this._drum('hihat', bt2 + B*0.25, 0.15);
      this._drum('hihat', bt2 + S, 0.22);
      this._drum('hihat', bt2 + S + B*0.25, 0.12);
    }

    const totalMs = (B * 16 + 0.1) * 1000;
    this._loop('quiz', totalMs);
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üíÄ BOSS THEME ‚Äî "Final Confrontation"
  // Intense, √©pique, 160 BPM, R√© mineur
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  _playBoss() {
    const ctx = this._getCtx();
    const t0 = ctx.currentTime + 0.05;
    const B = 60 / 160;   // 0.375s
    const S = B / 2;
    const N = this.N;

    // ‚Äî RIFF PRINCIPAL (sawtooth, lead agressif) ‚Äî
    const riff = [
      N.D5,N._,N.D5,N.D5, N.F5,N._,N.A5,N._,
      N.C6||N.A5,N._,N.A5,N._, N.G5,N.F5,N.E5,N._,
      N.D5,N._,N.D5,N.D5, N.F5,N._,N.Bb5||N.A5,N._,
      N.A5,N._,N.G5,N._, N.F5,N.E5,N.D5,N._,
    ];
    let rt = t0;
    riff.forEach(f => {
      if (f) this._note(f, rt, S * 0.5, 'sawtooth', 0.12);
      rt += S;
    });

    // ‚Äî HARMONIE (quinte, carr√©, detuned) ‚Äî
    const harm = [
      N.A4,N._,N.A4,N.A4, N.C5,N._,N.E5,N._,
      N.G5,N._,N.E5,N._,  N.D5,N.C5,N.B4,N._,
      N.A4,N._,N.A4,N.A4, N.C5,N._,N.F5,N._,
      N.E5,N._,N.D5,N._,  N.C5,N.B4,N.A4,N._,
    ];
    let ht = t0;
    harm.forEach(f => {
      if (f) this._note(f, ht, S * 0.45, 'square', 0.07, 7);
      ht += S;
    });

    // ‚Äî BASSE puissante ‚Äî
    const bossBase = [
      N.D3,N.D3,N.D3,N.F3, N.A3,N.A3,N.C4,N.C4,
      N.Bb3||N.A3,N.Bb3||N.A3,N.A3,N.G3, N.F3,N.F3,N.G3,N.A3,
    ];
    let bbt = t0;
    bossBase.forEach(f => {
      if (f) this._note(f, bbt, S * 0.6, 'sawtooth', 0.15);
      bbt += S;
    });

    // ‚Äî BASSE PROFONDE (octave en dessous) ‚Äî
    [N.D3,N.A3,N.Bb3||N.A3,N.F3].forEach((f, i) => {
      this._note(f, t0 + i * B * 4, B * 3.5, 'sine', 0.12);
    });

    // ‚Äî PAD dramatique ‚Äî
    [[N.D3,N.F3,N.A3], [N.A3,N.C4,N.E4], [N.Bb3||N.A3,N.D4,N.F4], [N.F3,N.A3,N.C4]].forEach(([a,b,c], i) => {
      this._chord([a,b,c], t0 + i * B * 4, B * 3.8, 'triangle', 0.05);
    });

    // ‚Äî BATTERIE de boss (intense) ‚Äî
    const totalBeats = 16;
    for (let beat = 0; beat < totalBeats; beat++) {
      const bt2 = t0 + beat * B;
      // Double kick
      this._drum('kick', bt2, 0.6);
      if (beat % 2 === 1) this._drum('kick', bt2 + S * 0.5, 0.4);
      // Snare syncop√©
      if (beat % 4 === 1) this._drum('snare', bt2, 0.55);
      if (beat % 4 === 3) { this._drum('snare', bt2, 0.5); this._drum('snare', bt2 + S, 0.35); }
      // Hihat rapide (doubles)
      this._drum('hihat', bt2, 0.3);
      this._drum('hihat', bt2 + B * 0.25, 0.2);
      this._drum('hihat', bt2 + S, 0.28);
      this._drum('hihat', bt2 + S + B * 0.25, 0.18);
    }

    const totalMs = (B * 16 + 0.1) * 1000;
    this._loop('boss', totalMs);
  },
};

// ‚îÄ‚îÄ Int√©gration : d√©marrer/arr√™ter selon l'√©cran actif ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateMusicForScreen(screenId) {
  if (!getSettings().musicEnabled) { MUSIC.stop(); return; }
  if (screenId === 'homeScreen')   { if (MUSIC._currentSong !== 'home') MUSIC.play('home'); }
  else if (screenId === 'quizScreen') {
    const isBoss = currentLevel && currentLevel % 100 === 0;
    const song = isBoss ? 'boss' : 'quiz';
    if (MUSIC._currentSong !== song) MUSIC.play(song);
  }
  else { MUSIC.stop(); }
}

// Logique musique int√©gr√©e directement dans saveSetting()



// --- 3. LOOT & DROPS ---
const LOOT_TABLE = [
  { chance: 0.4, rarity: 'common', reward: () => { player.coins += 25; return 'üí∞ 25 Pi√®ces'; }, label: 'Pi√®ces communes', rarityClass: 'rarity-common' },
  { chance: 0.3, rarity: 'rare', reward: () => { player.inventory.hints = (player.inventory.hints||0)+1; return 'üí° 1 Indice'; }, label: 'Indice Rare', rarityClass: 'rarity-rare' },
  { chance: 0.15, rarity: 'rare', reward: () => { player.coins += 150; return 'üí∞ 150 Pi√®ces'; }, label: 'Pi√®ces Rares', rarityClass: 'rarity-rare' },
  { chance: 0.1, rarity: 'epic', reward: () => { player.inventory.xpBoost = (player.inventory.xpBoost||0)+3; return '‚ö° Boost XP x3'; }, label: 'Boost √âpique', rarityClass: 'rarity-epic' },
  { chance: 0.04, rarity: 'legendary', reward: () => { player.coins += 500; player.inventory.skips=(player.inventory.skips||0)+2; return 'üí∞ 500 + ‚è≠Ô∏è√ó2'; }, label: 'Tr√©sor L√©gendaire!', rarityClass: 'rarity-legendary' },
  { chance: 0.01, rarity: 'legendary', reward: () => { player.inventory.secondChances=(player.inventory.secondChances||0)+3; return 'üîÑ 3 Secondes Chances'; }, label: '‚ö° JACKPOT!', rarityClass: 'rarity-legendary' },
];

function rollLoot() {
  const r = Math.random();
  let cumul = 0;
  for (const item of LOOT_TABLE) {
    cumul += item.chance;
    if (r < cumul) return item;
  }
  return LOOT_TABLE[0];
}

function tryDropLoot(dropChance = 0.2) {
  if (Math.random() > dropChance) return;
  const loot = rollLoot();
  const msg = loot.reward();
  savePlayer();
  showLootPopup(loot, msg);
}

function showLootPopup(loot, msg) {
  const overlay = document.createElement('div');
  overlay.id = 'lootOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:19999;';
  const popup = document.createElement('div');
  popup.className = 'loot-popup';
  popup.innerHTML = `
    <div style="font-size:3rem;margin-bottom:10px;">üì¶</div>
    <div style="font-size:0.7rem;color:#fbbf24;margin-bottom:5px;">COFFRE SURPRISE !</div>
    <div class="${loot.rarityClass}" style="font-size:0.8rem;margin-bottom:10px;text-transform:uppercase;">${loot.label}</div>
    <div style="font-size:1.2rem;margin:15px 0;">${msg}</div>
    <button class="gold" style="width:100%;" onclick="document.getElementById('lootOverlay').remove()">üéâ Super !</button>
  `;
  overlay.appendChild(popup);
  document.body.appendChild(overlay);
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
}

// --- 4. ENERGY SYSTEM ---
const MAX_ENERGY = 10;
const ENERGY_REGEN_MS = 30 * 60 * 1000; // 30 min par √©nergie

function getEnergy() {
  if (!player) return MAX_ENERGY;
  if (!player.energy) player.energy = MAX_ENERGY;
  if (!player.lastEnergyTime) player.lastEnergyTime = Date.now();
  
  // Regen
  const elapsed = Date.now() - player.lastEnergyTime;
  const regen = Math.floor(elapsed / ENERGY_REGEN_MS);
  if (regen > 0) {
    player.energy = Math.min(MAX_ENERGY, player.energy + regen);
    player.lastEnergyTime += regen * ENERGY_REGEN_MS;
  }
  return player.energy;
}

function useEnergy() {
  getEnergy();
  if (player.energy <= 0) return false;
  player.energy--;
  player.lastEnergyTime = player.lastEnergyTime || Date.now();
  savePlayer();
  updateEnergyDisplay();
  return true;
}

function updateEnergyDisplay() {
  const energy = getEnergy();
  const energyEl = document.getElementById('energyCount');
  const fillEl = document.getElementById('energyFill');
  const timerEl = document.getElementById('energyTimer');
  if (energyEl) energyEl.textContent = energy;
  if (fillEl) fillEl.style.width = (energy / MAX_ENERGY * 100) + '%';
  if (timerEl && energy < MAX_ENERGY) {
    const nextRegen = ENERGY_REGEN_MS - ((Date.now() - player.lastEnergyTime) % ENERGY_REGEN_MS);
    const mins = Math.ceil(nextRegen / 60000);
    timerEl.textContent = `+1 dans ${mins}min`;
  } else if (timerEl) {
    timerEl.textContent = '‚úÖ Plein';
  }
}

function tryStartGame() {
  if (player && player.isAdmin) { showScreen('gameScreen'); initGame(); return; }
  const energy = getEnergy();
  if (energy <= 0) {
    alert('‚ö° Plus d\'√©nergie ! Elle se recharge automatiquement toutes les 30 minutes.\n\nOu achetez des recharges dans la boutique !');
    return;
  }
  useEnergy();
  showScreen('gameScreen');
  initGame();
}

// --- 5. DAILY LOGIN REWARDS ---
const DAILY_REWARDS = [
  { day: 1, reward: 'üí∞ 50 Pi√®ces', fn: () => player.coins += 50 },
  { day: 2, reward: 'üí° 2 Indices', fn: () => player.inventory.hints = (player.inventory.hints||0)+2 },
  { day: 3, reward: 'üí∞ 150 Pi√®ces', fn: () => player.coins += 150 },
  { day: 4, reward: '‚è≠Ô∏è 2 Passes', fn: () => player.inventory.skips = (player.inventory.skips||0)+2 },
  { day: 5, reward: '‚ö° Boost XP x5', fn: () => player.inventory.xpBoost = (player.inventory.xpBoost||0)+5 },
  { day: 6, reward: 'üí∞ 300 Pi√®ces', fn: () => player.coins += 300 },
  { day: 7, reward: 'üåü MEGA BONUS: 500üí∞ + 3 Indices + Boost XP!', fn: () => { player.coins+=500; player.inventory.hints=(player.inventory.hints||0)+3; player.inventory.xpBoost=(player.inventory.xpBoost||0)+10; } },
];

function checkDailyLogin() {
  if (!player) return;
  const today = new Date().toDateString();
  if (player.lastLoginDate === today) return;
  
  // Reset claimed status for new day
  player.dailyRewardClaimed = false;
  player.lastLoginDate = today;
  player.loginStreak = (player.loginStreak || 0) + 1;
  
  // Reset streak if missed a day
  if (player.lastLoginCheck) {
    const lastDate = new Date(player.lastLoginCheck);
    const diff = (new Date() - lastDate) / (1000 * 60 * 60 * 24);
    if (diff > 1.5) player.loginStreak = 1;
  }
  player.lastLoginCheck = new Date().toISOString();
  
  document.getElementById('dailyLoginRewardBanner').style.display = 'block';
}

function openDailyRewardModal() {
  if (!player) return;
  const streak = player.loginStreak || 1;
  const dayIndex = ((streak - 1) % 7);
  const todayReward = DAILY_REWARDS[dayIndex];
  const claimed = player.dailyRewardClaimed === true;
  
  const overlay = document.createElement('div');
  overlay.id = 'dailyRewardModal';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:20000;overflow-y:auto;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border:4px solid #fbbf24;border-radius:20px;padding:30px;max-width:500px;width:90%;text-align:center;">
      <h2 style="color:#fbbf24;font-size:0.9rem;margin-bottom:5px;">üéÅ R√âCOMPENSES DE CONNEXION</h2>
      <div style="font-size:0.6rem;color:#10b981;margin-bottom:20px;">üî• Streak: ${streak} jour${streak>1?'s':''}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:20px;">
        ${DAILY_REWARDS.map((r, i) => {
          let cls = 'upcoming';
          if (i < dayIndex) cls = 'claimed';
          else if (i === dayIndex) cls = 'today';
          return `<div class="login-day ${cls}"><div style="font-size:1.2rem;">${i < dayIndex ? '‚úÖ' : (i === dayIndex ? 'üéÅ' : 'üîí')}</div><div style="color:#fbbf24;">Jour ${i+1}</div><div style="font-size:0.45rem;color:#9ca3af;">${r.reward.split(' ').slice(0,2).join(' ')}</div></div>`;
        }).join('')}
      </div>
      <div style="background:rgba(251,191,36,0.1);border:2px solid #fbbf24;border-radius:12px;padding:15px;margin-bottom:20px;">
        <div style="font-size:0.65rem;color:#9ca3af;margin-bottom:5px;">AUJOURD'HUI ‚Äî Jour ${dayIndex+1}</div>
        <div style="font-size:1rem;color:#fbbf24;">${todayReward.reward}</div>
      </div>
      ${claimed ? 
        '<div style="color:#10b981;font-size:0.65rem;">‚úÖ D√©j√† r√©cup√©r√©e aujourd\'hui !</div>' :
        '<button class="gold" style="width:100%;padding:15px;" onclick="claimDailyReward(this)">üéÅ R√âCUP√âRER !</button>'
      }
      <button class="danger" style="width:100%;margin-top:10px;" onclick="document.getElementById('dailyRewardModal').remove()">‚úñ Fermer</button>
    </div>
  `;
  document.body.appendChild(overlay);
}

function claimDailyReward(btn) {
  if (!player || player.dailyRewardClaimed) return;
  const streak = player.loginStreak || 1;
  const dayIndex = ((streak - 1) % 7);
  DAILY_REWARDS[dayIndex].fn();
  player.dailyRewardClaimed = true;
  savePlayer();
  if (btn) { btn.textContent = '‚úÖ R√©cup√©r√©e !'; btn.disabled = true; }
  const banner = document.getElementById('dailyLoginRewardBanner');
  if (banner) banner.style.display = 'none';
  const modal = document.getElementById('dailyRewardModal');
  if (modal) setTimeout(() => modal.remove(), 800);
}

// --- 6. DAILY QUESTS ---
const QUEST_TEMPLATES = [
  { id: 'q1', desc: 'R√©ponds √† 10 questions correctement', goal: 10, key: 'questionsAnswered', reward: 'üí∞ 100 Pi√®ces', rewardFn: () => player.coins += 100 },
  { id: 'q2', desc: 'Atteins un combo x5', goal: 5, key: 'maxCombo', reward: '‚ö° 3 Boosts XP', rewardFn: () => player.inventory.xpBoost = (player.inventory.xpBoost||0)+3 },
  { id: 'q3', desc: 'D√©pense 0 indices (session)', goal: 1, key: 'noHintSession', reward: 'üí° 2 Indices', rewardFn: () => player.inventory.hints = (player.inventory.hints||0)+2 },
  { id: 'q4', desc: 'Bats 3 niveaux boss', goal: 3, key: 'bossesDefeated', reward: 'üí∞ 200 Pi√®ces', rewardFn: () => player.coins += 200 },
  { id: 'q5', desc: 'Gagne 200 pi√®ces en une session', goal: 200, key: 'sessionCoins', reward: '‚è≠Ô∏è 2 Passes', rewardFn: () => player.inventory.skips = (player.inventory.skips||0)+2 },
];

function getDailyQuests() {
  if (!player) return [];
  const today = new Date().toDateString();
  if (!player.dailyQuests || player.dailyQuests.date !== today) {
    // Assign 3 random quests for today (slice first to avoid mutating QUEST_TEMPLATES)
    const shuffled = [...QUEST_TEMPLATES].sort(() => Math.random()-0.5).slice(0, 3);
    player.dailyQuests = {
      date: today,
      quests: shuffled.map(q => ({ ...q, progress: 0, completed: false, claimed: false }))
    };
    savePlayer();
  }
  return player.dailyQuests.quests;
}

function updateQuestProgress(key, amount = 1) {
  if (!player || !player.dailyQuests) return;
  const today = new Date().toDateString();
  if (player.dailyQuests.date !== today) return;
  player.dailyQuests.quests.forEach(q => {
    if (q.key === key && !q.completed) {
      q.progress = Math.min(q.goal, (q.progress || 0) + amount);
      if (q.progress >= q.goal) {
        q.completed = true;
        showQuestComplete(q);
      }
    }
  });
  renderQuestsPreview();
}

function showQuestComplete(quest) {
  const el = document.getElementById('comboAnnouncement');
  if (el) {
    el.textContent = 'üìã QU√äTE ACCOMPLIE !';
    el.classList.remove('show');
    void el.offsetWidth;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
  }
}

function renderQuestsPreview() {
  const el = document.getElementById('questsPreview');
  if (!el) return;
  const quests = getDailyQuests();
  const completed = quests.filter(q => q.completed).length;
  el.innerHTML = `<div style="font-size:0.55rem;color:#9ca3af;margin-bottom:5px;">${completed}/${quests.length} compl√©t√©es</div>` +
    quests.map(q => `
      <div class="quest-item">
        <span>${q.completed ? '‚úÖ' : 'üî∏'}</span>
        <span style="flex:1;">${q.desc}</span>
        <div class="quest-progress-bar"><div class="quest-progress-fill" style="width:${Math.min(100,(q.progress||0)/q.goal*100)}%;"></div></div>
        <span style="font-size:0.5rem;color:#fbbf24;">${q.progress||0}/${q.goal}</span>
      </div>
    `).join('');
}

function openQuestsModal() {
  const quests = getDailyQuests();
  const overlay = document.createElement('div');
  overlay.id = 'questsModal';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:20000;overflow-y:auto;padding:20px;';
  overlay.innerHTML = `
    <div style="max-width:500px;margin:0 auto;background:#1a1a2e;border:3px solid #10b981;border-radius:20px;padding:25px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="color:#10b981;font-size:0.9rem;">üìã QU√äTES DU JOUR</h2>
        <button class="danger" onclick="document.getElementById('questsModal').remove()">‚úñ</button>
      </div>
      ${quests.map(q => `
        <div style="background:rgba(0,0,0,0.4);border:2px solid ${q.completed?'#10b981':'rgba(255,255,255,0.1)'};border-radius:12px;padding:15px;margin:10px 0;">
          <div style="font-size:0.65rem;color:#fbbf24;margin-bottom:8px;">${q.completed?'‚úÖ':q.claimed?'üì¶':'üî∏'} ${q.desc}</div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="quest-progress-bar" style="flex:1;"><div class="quest-progress-fill" style="width:${Math.min(100,(q.progress||0)/q.goal*100)}%;"></div></div>
            <span style="font-size:0.55rem;color:#9ca3af;">${q.progress||0}/${q.goal}</span>
          </div>
          <div style="font-size:0.55rem;color:#10b981;margin-top:8px;">üèÜ R√©compense: ${q.reward}</div>
          ${q.completed && !q.claimed ? `<button class="gold" style="width:100%;margin-top:10px;padding:10px;" onclick="claimQuestReward('${q.id}', this)">üéÅ R√©cup√©rer</button>` : ''}
        </div>
      `).join('')}
      <button class="primary" style="width:100%;margin-top:15px;" onclick="document.getElementById('questsModal').remove()">‚úÖ Fermer</button>
    </div>
  `;
  document.body.appendChild(overlay);
}

function claimQuestReward(questId, btn) {
  if (!player || !player.dailyQuests) return;
  const quest = player.dailyQuests.quests.find(q => q.id === questId);
  if (!quest || !quest.completed || quest.claimed) return;
  const template = QUEST_TEMPLATES.find(t => t.id === questId);
  if (template && template.rewardFn) template.rewardFn();
  quest.claimed = true;
  savePlayer();
  // Update button state before re-rendering
  if (btn) { btn.textContent = '‚úÖ R√©cup√©r√©e !'; btn.disabled = true; }
  // Refresh quest preview on home screen if visible
  renderQuestsPreview();
}

// --- 7. LEAGUE SYSTEM ---
function getLeague(maxLevel) {
  if (maxLevel >= 5000) return { name: 'Diamant', emoji: 'üíé', class: 'league-diamond' };
  if (maxLevel >= 2000) return { name: 'Or', emoji: 'ü•á', class: 'league-gold' };
  if (maxLevel >= 500) return { name: 'Argent', emoji: 'ü•à', class: 'league-silver' };
  return { name: 'Bronze', emoji: 'ü•â', class: 'league-bronze' };
}

// --- 8. TALENT TREE ---
const TALENTS = [
  { id: 't1', name: '√âconome', emoji: 'üí∞', desc: '+10% pi√®ces', cost: 100, requires: null, effect: 'coinBonus' },
  { id: 't2', name: 'Studieux', emoji: 'üìö', desc: '+10% XP', cost: 100, requires: null, effect: 'xpBonus' },
  { id: 't3', name: 'Endurant', emoji: '‚ù§Ô∏è', desc: '+1 vie max', cost: 200, requires: 't1', effect: 'extraLife' },
  { id: 't4', name: 'Rapide', emoji: '‚ö°', desc: '+5s timer bonus', cost: 200, requires: 't2', effect: 'timeBonus' },
  { id: 't5', name: 'Chanceux', emoji: 'üçÄ', desc: '+15% drop rate', cost: 300, requires: 't3', effect: 'dropBonus' },
  { id: 't6', name: 'Combo Master', emoji: 'üî•', desc: 'Combo reste 15s', cost: 300, requires: 't4', effect: 'comboExtend' },
  { id: 't7', name: 'Tr√©sorier', emoji: 'üëë', desc: '+25% toutes pi√®ces', cost: 500, requires: 't5', effect: 'megaCoinBonus' },
  { id: 't8', name: 'L√©gende', emoji: 'üåü', desc: 'x2 XP toujours', cost: 500, requires: 't6', effect: 'megaXPBonus' },
];

function openTalentTree() {
  if (!player) return;
  if (!player.talents) player.talents = [];
  const talentPoints = player.talentPoints || 0;
  
  const overlay = document.createElement('div');
  overlay.id = 'talentModal';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:20000;overflow-y:auto;padding:20px;';
  overlay.innerHTML = `
    <div style="max-width:600px;margin:0 auto;background:#1a1a2e;border:3px solid #f59e0b;border-radius:20px;padding:25px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h2 style="color:#f59e0b;font-size:0.85rem;">üå≥ ARBRE DE TALENTS</h2>
        <button class="danger" onclick="document.getElementById('talentModal').remove()">‚úñ</button>
      </div>
      <div style="text-align:center;font-size:0.6rem;color:#fbbf24;margin-bottom:20px;">
        ‚ú® Points disponibles: <span id="talentPointsDisplay">${talentPoints}</span>
        <br><span style="color:#9ca3af;font-size:0.5rem;">Gagne 1 point tous les 10 niveaux joueur</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:15px;justify-content:center;">
        ${TALENTS.map(t => {
          const unlocked = player.talents.includes(t.id);
          const reqOk = !t.requires || player.talents.includes(t.requires);
          const canUnlock = !unlocked && reqOk && talentPoints >= 1;
          let cls = unlocked ? 'unlocked' : (canUnlock ? 'available' : 'locked');
          const onclickAttr = canUnlock ? ('onclick="unlockTalent(' + "'" + t.id + "'" + ')"') : '';
          const statusBadge = unlocked ? '<span style="font-size:0.4rem;color:#10b981;">‚úÖ</span>' : (canUnlock ? '<span style="font-size:0.4rem;color:#f59e0b;">1pt</span>' : '');
          return '<div class="talent-node ' + cls + '" ' + onclickAttr + '>'
            + '<span style="font-size:1.5rem;">' + t.emoji + '</span>'
            + '<span style="font-size:0.45rem;color:#fbbf24;">' + t.name + '</span>'
            + '<span style="font-size:0.4rem;color:#9ca3af;">' + t.desc + '</span>'
            + statusBadge
            + '</div>';
        }).join('')}
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

function unlockTalent(id) {
  if (!player || !player.talents) player.talents = [];
  if (player.talents.includes(id)) return;
  if ((player.talentPoints || 0) < 1) { alert('Pas assez de points de talent !'); return; }
  const talent = TALENTS.find(t => t.id === id);
  if (talent.requires && !player.talents.includes(talent.requires)) { alert('D√©bloque le talent pr√©c√©dent d\'abord !'); return; }
  player.talents.push(id);
  player.talentPoints = (player.talentPoints || 0) - 1;
  savePlayer();
  // Reopen to refresh
  const existingModal = document.getElementById('talentModal');
  if (existingModal) existingModal.remove();
  openTalentTree();
  // Small notification instead of blocking alert
  const ann = document.getElementById('comboAnnouncement');
  if (ann) { ann.textContent = 'üå≥ ' + talent.name + ' d√©bloqu√©!'; ann.classList.remove('show'); void ann.offsetWidth; ann.classList.add('show'); setTimeout(() => ann.classList.remove('show'), 2000); }
}

function checkTalentPoints() {
  if (!player) return;
  const expectedPoints = Math.floor(player.level / 10);
  const usedPoints = (player.talents || []).length;
  const currentPoints = player.talentPoints || 0;
  if (expectedPoints > usedPoints + currentPoints) {
    player.talentPoints = expectedPoints - usedPoints;
  }
}

// --- 9. RANDOM EVENTS ---
const EVENTS = [
  { id: 'coinStorm', name: 'üåßÔ∏è Pluie de Pi√®ces!', desc: 'x2 pi√®ces pendant 5 minutes!', color: '#fbbf24', duration: 5 * 60 * 1000 },
  { id: 'xpRush', name: '‚ö° Rush XP!', desc: 'x3 XP pendant 3 minutes!', color: '#8b5cf6', duration: 3 * 60 * 1000 },
  { id: 'bossInvasion', name: 'üëπ Invasion de Boss!', desc: 'x5 r√©compenses sur les boss pendant 10 min!', color: '#ef4444', duration: 10 * 60 * 1000 },
];
let activeEvent = null;
let eventEndTime = null;

function triggerRandomEvent() {
  if (activeEvent) return;
  const event = EVENTS[Math.floor(Math.random() * EVENTS.length)];
  activeEvent = event;
  eventEndTime = Date.now() + event.duration;
  // Update banner if visible (only on homeScreen)
  const banner = document.getElementById('eventBanner');
  if (banner) {
    banner.style.display = 'block';
    banner.innerHTML = `üö® √âV√âNEMENT: ${event.name}<br><span style="font-size:0.5rem;">${event.desc} ‚Äî <span id="eventTimer"></span></span>`;
  }
  updateEventTimer();
}

function refreshEventBanner() {
  if (!activeEvent || Date.now() > eventEndTime) return;
  const banner = document.getElementById('eventBanner');
  if (banner) {
    banner.style.display = 'block';
    banner.innerHTML = `üö® √âV√âNEMENT: ${activeEvent.name}<br><span style="font-size:0.5rem;">${activeEvent.desc} ‚Äî <span id="eventTimer"></span></span>`;
    updateEventTimer();
  }
}

function updateEventTimer() {
  if (!activeEvent || !eventEndTime) return;
  const remaining = eventEndTime - Date.now();
  if (remaining <= 0) {
    activeEvent = null;
    const banner = document.getElementById('eventBanner');
    if (banner) banner.style.display = 'none';
    return;
  }
  const mins = Math.floor(remaining / 60000);
  const secs = Math.floor((remaining % 60000) / 1000);
  const el = document.getElementById('eventTimer');
  if (el) el.textContent = `${mins}m ${secs}s restant`;
  setTimeout(updateEventTimer, 1000);
}

function getEventMultiplier(type) {
  if (!activeEvent || Date.now() > eventEndTime) return 1;
  if (activeEvent.id === 'coinStorm' && type === 'coins') return 2;
  if (activeEvent.id === 'xpRush' && type === 'xp') return 3;
  if (activeEvent.id === 'bossInvasion' && type === 'boss') return 5;
  return 1;
}

function showEventDetails() {
  if (!activeEvent) return;
  alert(`üö® √âV√âNEMENT ACTIF: ${activeEvent.name}\n${activeEvent.desc}`);
}

// Trigger random event every 20-40 minutes
function scheduleRandomEvent() {
  const delay = (20 + Math.random() * 20) * 60 * 1000;
  setTimeout(() => {
    if (player) triggerRandomEvent();
    scheduleRandomEvent();
  }, delay);
}

// --- 10. PRESTIGE SYSTEM ---
function canPrestige() {
  return player && player.maxLevel >= 10000;
}

function openPrestigeModal() {
  if (!canPrestige()) { alert('Atteins le niveau 10 000 pour prestige !'); return; }
  const overlay = document.createElement('div');
  overlay.id = 'prestigeModal';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:20000;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div style="background:#1a1a2e;border:4px solid #fbbf24;border-radius:20px;padding:30px;text-align:center;max-width:400px;">
      <div style="font-size:2rem;">‚≠ê</div>
      <h2 style="color:#fbbf24;margin:10px 0;font-size:0.9rem;">PRESTIGE!</h2>
      <p style="font-size:0.6rem;color:#9ca3af;margin:15px 0;">Recommence depuis 0 avec un badge Prestige et des bonus permanents !</p>
      <p style="font-size:0.65rem;color:#10b981;margin:10px 0;">‚úÖ Tu gardes: Badges, Talents, Pi√®ces (50%)</p>
      <p style="font-size:0.65rem;color:#ef4444;margin:10px 0;">‚ùå Reset: Niveau carte, XP, Niveau joueur</p>
      <p style="font-size:0.7rem;color:#fbbf24;margin:15px 0;">üéÅ Bonus: +50% pi√®ces permanent!</p>
      <button class="gold" style="width:100%;padding:15px;margin:5px 0;" onclick="doPrestige(this)">‚≠ê PRESTIGE!</button>
      <button class="danger" style="width:100%;padding:10px;" onclick="document.getElementById('prestigeModal').remove()">Annuler</button>
    </div>
  `;
  document.body.appendChild(overlay);
}

function doPrestige(btn) {
  if (!confirm('‚ö†Ô∏è Confirmes-tu le prestige ? Toute ta progression de carte sera r√©initialis√©e !')) return;
  const prestigeLevel = (player.prestigeLevel || 0) + 1;
  const keptCoins = Math.floor(player.coins / 2);
  const keptBadges = [...(player.badges || [])];
  const keptTalents = [...(player.talents || [])];
  const keptTalentPoints = player.talentPoints || 0;
  
  player.prestigeLevel = prestigeLevel;
  player.coins = keptCoins;
  player.badges = keptBadges;
  player.badges.push(`‚≠ê Prestige ${prestigeLevel}`);
  player.talents = keptTalents;
  player.talentPoints = keptTalentPoints + 5;
  player.level = 1;
  player.xp = 0;
  player.maxLevel = 1;
  player.inventory = { hints: 0, skips: 0, secondChances: 0, xpBoost: 0 };
  player.stats = { questionsAnswered: 0, bossesDefeated: 0 };
  
  savePlayer();
  document.querySelector('div[style*="z-index:20000"]')?.remove();
  showScreen('homeScreen');
  updateHomeScreen();
  alert(`üåü PRESTIGE ${prestigeLevel} ACTIV√â ! Tu as gard√© ${keptCoins} pi√®ces et re√ßu 5 points de talent bonus !`);
}

// ========================================
// ‚öîÔ∏è SYST√àME MULTIJOUEUR ‚Äî Firebase Realtime
// ========================================
// Structure Firebase :
//  /rooms/{roomId}  ‚Üí salon de jeu
//  /rooms/{roomId}/players/{uid} ‚Üí donn√©es joueur dans le salon
//  /presence/{uid} ‚Üí pr√©sence en ligne
//  /challenges/{toUid}/{challengeId} ‚Üí demandes de d√©fi

const DUEL_QUESTIONS_COUNT = 10;
const DUEL_QUESTION_TIME = 20; // secondes par question
const DUEL_WIN_COINS = 150;
const DUEL_LOSE_COINS = 30;
const DUEL_WIN_XP = 200;
const DUEL_LOSE_XP = 50;

let currentRoomId = null;
let currentRoomRef = null;
let duelQuestions = [];
let duelCurrentQ = 0;
let duelMyScore = 0;
let duelOppScore = 0;
let duelMyCorrect = 0;
let duelOppCorrect = 0;
let duelTimer = null;
let duelTimeLeft = DUEL_QUESTION_TIME;
let duelAnswered = false;
let duelOppUid = null;
let duelOppName = '';
let duelIsHost = false;
let roomListener = null;
let presenceInterval = null;
let challengeListener = null;
let mpCurrentTab = 'rooms';

// ‚îÄ‚îÄ Pr√©sence en ligne ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startPresence() {
  if (!firebaseReady || !currentUserId || currentUserId.startsWith('admin_') || currentUserId === 'admin' || currentUserId.startsWith('local_')) return;
  const ref = database.ref('presence/' + currentUserId);
  ref.set({ username: player.username, level: player.level || 1, maxLevel: player.maxLevel || 1, online: true, ts: Date.now() });
  ref.onDisconnect().remove();
  presenceInterval = setInterval(() => {
    if (player) ref.update({ ts: Date.now(), level: player.level || 1 });
  }, 30000);
  listenForChallenges();
}

function stopPresence() {
  if (presenceInterval) clearInterval(presenceInterval);
  if (!firebaseReady || !currentUserId || currentUserId.startsWith('admin_') || currentUserId === 'admin' || currentUserId.startsWith('local_')) return;
  database.ref('presence/' + currentUserId).remove();
  if (challengeListener) { database.ref('challenges/' + currentUserId).off(); challengeListener = null; }
}

// ‚îÄ‚îÄ Challenges entrants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function listenForChallenges() {
  if (!firebaseReady || !currentUserId || currentUserId.startsWith('local_') || currentUserId.startsWith('admin_') || currentUserId === 'admin') return;
  const ref = database.ref('challenges/' + currentUserId);
  challengeListener = ref.on('child_added', snap => {
    const challenge = snap.val();
    if (!challenge) return;
    snap.ref.remove(); // consomme le challenge
    showChallengeNotif(challenge, snap.key);
  });
}

function showChallengeNotif(challenge, challengeId) {
  // Remove existing notifs
  document.querySelectorAll('.challenge-notif').forEach(el => el.remove());
  const notif = document.createElement('div');
  notif.className = 'challenge-notif';
  notif.innerHTML = `
    <div style="font-size:0.6rem;color:#fbbf24;margin-bottom:8px;">‚öîÔ∏è D√âFI RE√áU !</div>
    <div style="font-size:0.65rem;margin-bottom:12px;">${challenge.fromName} te d√©fie en duel !</div>
    <div style="display:flex;gap:8px;">
      <button class="primary" style="flex:1;padding:8px;font-size:0.55rem;" onclick="acceptChallenge('${challenge.roomId}'); this.closest('.challenge-notif').remove();">‚úÖ Accepter</button>
      <button class="danger" style="flex:1;padding:8px;font-size:0.55rem;" onclick="this.closest('.challenge-notif').remove();">‚ùå Refuser</button>
    </div>
  `;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 15000);
}

// ‚îÄ‚îÄ Initialisation √©cran multi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMultiplayer() {
  if (!firebaseReady || !currentUserId || currentUserId.startsWith('local_') || currentUserId.startsWith('admin_') || currentUserId === 'admin') {
    document.getElementById('mpFirebaseWarning').style.display = 'block';
    document.getElementById('mpRoomsList').innerHTML = '';
    document.getElementById('mpOnlineList').innerHTML = '';
    return;
  }
  document.getElementById('mpFirebaseWarning').style.display = 'none';
  switchMpTab(mpCurrentTab);
  startPresence();
}

function switchMpTab(tab) {
  mpCurrentTab = tab;
  ['rooms','challenge','history'].forEach(t => {
    document.getElementById('mpTab' + t.charAt(0).toUpperCase() + t.slice(1)).className = t === tab ? 'primary' : '';
    document.getElementById('mpTab' + t.charAt(0).toUpperCase() + t.slice(1) + 'Content').style.display = t === tab ? 'block' : 'none';
  });
  if (tab === 'rooms') refreshRooms();
  else if (tab === 'challenge') refreshOnlinePlayers();
  else if (tab === 'history') renderDuelHistory();
}

// ‚îÄ‚îÄ Salons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshRooms() {
  const el = document.getElementById('mpRoomsList');
  if (!firebaseReady) { el.innerHTML = '<div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:20px;">Firebase requis</div>'; return; }
  el.innerHTML = '<div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:20px;">‚è≥ Chargement...</div>';
  try {
    const snap = await database.ref('rooms').orderByChild('status').equalTo('waiting').limitToLast(20).once('value');
    const data = snap.val() || {};
    const rooms = Object.entries(data).filter(([, r]) => r.hostName && Date.now() - (r.createdAt || 0) < 5 * 60 * 1000);
    if (rooms.length === 0) {
      el.innerHTML = '<div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:30px;">üò¥ Aucun salon ouvert<br><br>Cr√©e-en un !</div>';
      return;
    }
    el.innerHTML = rooms.map(([roomId, room]) => `
      <div class="room-card" onclick="joinRoom('${roomId}')">
        <div>
          <div style="font-size:0.65rem;color:#fbbf24;">${room.hostName}</div>
          <div style="font-size:0.5rem;color:#9ca3af;">Niv. ${room.hostLevel || 1} ‚Ä¢ ${DUEL_QUESTIONS_COUNT} questions</div>
        </div>
        <div style="text-align:right;">
          <div class="room-status"><div class="status-dot open"></div><span style="color:#10b981;">OUVERT</span></div>
          <div style="font-size:0.45rem;color:#9ca3af;">1/2 joueurs</div>
        </div>
      </div>
    `).join('');
  } catch(e) { el.innerHTML = `<div style="color:#ef4444;font-size:0.6rem;text-align:center;padding:20px;">Erreur: ${e.message}</div>`; }
}

async function createRoom() {
  if (!firebaseReady || !player) return;
  if (currentRoomId) { alert('Tu es d√©j√† dans un salon !'); return; }

  const questions = generateDuelQuestions();
  const roomId = database.ref('rooms').push().key;
  const roomData = {
    hostUid: currentUserId,
    hostName: player.username,
    hostLevel: player.level || 1,
    status: 'waiting',
    createdAt: Date.now(),
    questions: questions,
    players: {
      [currentUserId]: { name: player.username, level: player.level || 1, score: 0, correct: 0, ready: false }
    }
  };

  await database.ref('rooms/' + roomId).set(roomData);
  currentRoomId = roomId;
  duelIsHost = true;
  openRoomLobby(roomId, roomData.questions);
}

async function joinRoom(roomId) {
  if (!firebaseReady || !player) return;
  if (currentRoomId) { leaveMpLobby(); }

  const snap = await database.ref('rooms/' + roomId).once('value');
  const room = snap.val();
  if (!room || room.status !== 'waiting') { alert('Ce salon n\'est plus disponible !'); refreshRooms(); return; }
  if (room.hostUid === currentUserId) { openRoomLobby(roomId, room.questions); return; }

  await database.ref(`rooms/${roomId}/players/${currentUserId}`).set({
    name: player.username, level: player.level || 1, score: 0, correct: 0, ready: false
  });
  await database.ref(`rooms/${roomId}/status`).set('ready');

  currentRoomId = roomId;
  duelIsHost = false;
  duelOppUid = room.hostUid;
  duelOppName = room.hostName;
  startDuel(roomId, room.questions);
}

async function acceptChallenge(roomId) {
  await joinRoom(roomId);
}

// ‚îÄ‚îÄ Lobby d'attente ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openRoomLobby(roomId, questions) {
  // Show waiting overlay
  const overlay = document.createElement('div');
  overlay.id = 'lobbyOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);z-index:18000;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div style="background:#1a1a2e;border:3px solid #6366f1;border-radius:20px;padding:30px;text-align:center;max-width:400px;width:90%;">
      <div style="font-size:2rem;margin-bottom:10px;">‚öîÔ∏è</div>
      <h2 style="color:#818cf8;font-size:0.85rem;margin-bottom:5px;">SALON D'ATTENTE</h2>
      <div style="font-size:0.55rem;color:#9ca3af;margin-bottom:20px;">Partage ce code : <span style="color:#fbbf24;">${roomId.slice(-6).toUpperCase()}</span></div>
      <div class="pvp-player-card ready" style="justify-content:center;">
        <span style="font-size:1.2rem;">üë§</span>
        <span style="font-size:0.65rem;color:#fbbf24;">${player.username}</span>
        <span style="font-size:0.55rem;color:#10b981;margin-left:auto;">‚úÖ Pr√™t</span>
      </div>
      <div class="pvp-player-card waiting" id="lobbyOppCard" style="justify-content:center;">
        <span style="font-size:1.2rem;">‚è≥</span>
        <span style="font-size:0.65rem;color:#9ca3af;">En attente d'un adversaire...</span>
      </div>
      <div style="margin-top:20px;font-size:0.55rem;color:#9ca3af;">
        <div class="dot-bounce" style="justify-content:center;margin-bottom:8px;"><span></span><span></span><span></span></div>
        Partage le lien du jeu pour inviter un ami !
      </div>
      <button class="danger" style="width:100%;margin-top:20px;" onclick="leaveMpLobby(); document.getElementById('lobbyOverlay')?.remove();">‚úñ Annuler</button>
    </div>
  `;
  document.body.appendChild(overlay);

  // Listen for opponent joining
  currentRoomRef = database.ref('rooms/' + roomId);
  roomListener = currentRoomRef.on('value', snap => {
    const room = snap.val();
    if (!room) return;
    if (room.status === 'ready') {
      // Opponent joined!
      const players = Object.entries(room.players || {});
      const opp = players.find(([uid]) => uid !== currentUserId);
      if (opp) {
        duelOppUid = opp[0];
        duelOppName = opp[1].name;
        const oppCard = document.getElementById('lobbyOppCard');
        if (oppCard) {
          oppCard.className = 'pvp-player-card ready';
          oppCard.innerHTML = `<span style="font-size:1.2rem;">üë§</span><span style="font-size:0.65rem;color:#fbbf24;">${duelOppName}</span><span style="font-size:0.55rem;color:#10b981;margin-left:auto;">‚úÖ Pr√™t</span>`;
        }
        setTimeout(() => {
          document.getElementById('lobbyOverlay')?.remove();
          startDuel(roomId, room.questions);
        }, 1000);
      }
    }
  });
}

// ‚îÄ‚îÄ G√©n√©ration de questions duel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateDuelQuestions() {
  const qs = [];
  const baseLevel = Math.max(1, (player.maxLevel || 1) - 20);
  for (let i = 0; i < DUEL_QUESTIONS_COUNT; i++) {
    const level = baseLevel + Math.floor(Math.random() * 30);
    qs.push(getQuestionForLevel(level, false));
  }
  return qs;
}

// ‚îÄ‚îÄ D√©marrer le duel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startDuel(roomId, questions) {
  duelQuestions = questions;
  duelCurrentQ = 0;
  duelMyScore = 0;
  duelOppScore = 0;
  duelMyCorrect = 0;
  duelOppCorrect = 0;
  currentRoomId = roomId;

  showScreen('duelScreen');
  updateDuelHUD();

  // Listen to room for opponent's answers
  if (roomListener) { database.ref('rooms/' + currentRoomId).off('value', roomListener); roomListener = null; }
  currentRoomRef = database.ref('rooms/' + currentRoomId);
  roomListener = currentRoomRef.child('players/' + duelOppUid).on('value', snap => {
    const opp = snap.val();
    if (!opp) return;
    duelOppScore = opp.score || 0;
    duelOppCorrect = opp.correct || 0;
    updateDuelHUD();
    // Opponent answered this round
    if (opp.lastAnsweredQ === duelCurrentQ && !duelAnswered) {
      showOppAnswered(opp.lastCorrect);
    }
    // Check if duel ended
    if (opp.finished && player._duelFinished) {
      endDuel();
    }
  });

  showDuelQuestion();
}

function updateDuelHUD() {
  const myName = document.getElementById('duelMyName');
  const myScore = document.getElementById('duelMyScore');
  const myCorrect = document.getElementById('duelMyCorrect');
  const oppName = document.getElementById('duelOppName');
  const oppScore = document.getElementById('duelOppScore');
  const oppCorrect = document.getElementById('duelOppCorrect');
  if (myName) myName.textContent = player?.username || '-';
  if (myScore) myScore.textContent = duelMyScore;
  if (myCorrect) myCorrect.textContent = duelMyCorrect + ' corrects';
  if (oppName) oppName.textContent = duelOppName || 'Adversaire';
  if (oppScore) oppScore.textContent = duelOppScore;
  if (oppCorrect) oppCorrect.textContent = duelOppCorrect + ' corrects';
  // Color my score vs opponent's
  if (myScore) myScore.style.color = duelMyScore >= duelOppScore ? '#10b981' : '#ef4444';
  if (oppScore) oppScore.style.color = duelOppScore > duelMyScore ? '#10b981' : '#ef4444';
}

// ‚îÄ‚îÄ Afficher question duel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showDuelQuestion() {
  if (duelCurrentQ >= DUEL_QUESTIONS_COUNT) { finishMyDuel(); return; }
  duelAnswered = false;

  const q = duelQuestions[duelCurrentQ];
  const roundEl = document.getElementById('duelRoundInfo');
  const feedEl = document.getElementById('duelFeedback');
  const submitBtn = document.getElementById('duelSubmitBtn');
  if (roundEl) roundEl.textContent = `Q ${duelCurrentQ + 1}/${DUEL_QUESTIONS_COUNT}`;
  if (feedEl) feedEl.innerHTML = '';
  if (submitBtn) submitBtn.disabled = false;

  // Biome
  const biome = getBiome(Math.max(1, player.maxLevel || 1));
  const biomeEl = document.getElementById('duelBiome');
  if (biomeEl) biomeEl.textContent = `${biome.emoji} ${biome.name}`;

  document.getElementById('duelQuestion').textContent = q.question;
  document.getElementById('duelOppStatus').style.display = 'flex';

  // QCM or text
  if (q.type === 'qcm' && q.choices) {
    document.getElementById('duelChoices').style.display = 'flex';
    document.getElementById('duelTextGroup').style.display = 'none';
    const choicesEl = document.getElementById('duelChoices');
    choicesEl.innerHTML = '';
    q.choices.forEach(c => {
      const btn = document.createElement('button');
      btn.className = 'choice-btn';
      btn.textContent = c;
      btn.onclick = () => { selectDuelChoice(c, btn); };
      choicesEl.appendChild(btn);
    });
  } else {
    document.getElementById('duelChoices').style.display = 'none';
    document.getElementById('duelTextGroup').style.display = 'block';
    const inp = document.getElementById('duelAnswerInput');
    inp.value = '';
    inp.focus();
  }

  // Start timer
  startDuelTimer();
}

let duelSelectedChoice = null;

function selectDuelChoice(val, btn) {
  document.querySelectorAll('#duelChoices .choice-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  duelSelectedChoice = val;
  setTimeout(() => submitDuelAnswer(), 400);
}

// ‚îÄ‚îÄ Timer duel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startDuelTimer() {
  clearInterval(duelTimer);
  duelTimeLeft = DUEL_QUESTION_TIME;
  updateDuelTimerDisplay();
  duelTimer = setInterval(() => {
    duelTimeLeft--;
    updateDuelTimerDisplay();
    if (duelTimeLeft <= 0) {
      clearInterval(duelTimer);
      if (!duelAnswered) submitDuelAnswer(true); // time out
    }
  }, 1000);
}

function updateDuelTimerDisplay() {
  const numEl = document.getElementById('duelTimerNum');
  const circleEl = document.getElementById('duelTimerCircle');
  if (numEl) numEl.textContent = Math.max(0, duelTimeLeft);
  if (circleEl) {
    const circumference = 163;
    const offset = circumference * (1 - duelTimeLeft / DUEL_QUESTION_TIME);
    circleEl.style.strokeDashoffset = offset;
    circleEl.style.stroke = duelTimeLeft <= 5 ? '#ef4444' : duelTimeLeft <= 10 ? '#f59e0b' : '#10b981';
  }
}

// ‚îÄ‚îÄ Soumettre r√©ponse duel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitDuelAnswer(timedOut = false) {
  if (duelAnswered) return;
  duelAnswered = true;
  clearInterval(duelTimer);

  const q = duelQuestions[duelCurrentQ];
  const submitBtn = document.getElementById('duelSubmitBtn');
  if (submitBtn) submitBtn.disabled = true;

  let userAnswer = '';
  if (q.type === 'qcm') {
    userAnswer = duelSelectedChoice || '';
  } else {
    userAnswer = document.getElementById('duelAnswerInput').value.trim();
  }
  duelSelectedChoice = null;

  const isCorrect = !timedOut && normalizeText(userAnswer) === normalizeText(q.answer);
  const timeBonus = isCorrect ? Math.max(0, Math.floor(duelTimeLeft / 4)) : 0;
  const points = isCorrect ? (10 + timeBonus) : 0;

  if (isCorrect) {
    duelMyScore += points;
    duelMyCorrect++;
    playCorrectSound();
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 'correct');
    document.getElementById('duelFeedback').innerHTML = `<div style="color:#10b981;font-size:1rem;">‚úÖ CORRECT ! +${points} pts</div>${timeBonus > 0 ? `<div style="font-size:0.55rem;color:#fbbf24;">‚ö° Bonus rapidit√©: +${timeBonus}</div>` : ''}`;
  } else {
    playWrongSound();
    document.getElementById('duelFeedback').innerHTML = timedOut
      ? `<div style="color:#f59e0b;">‚è∞ Temps √©coul√© !</div><div style="font-size:0.6rem;color:#9ca3af;">R√©ponse: ${q.answer}</div>`
      : `<div style="color:#ef4444;">‚ùå Incorrect !</div><div style="font-size:0.6rem;color:#9ca3af;">R√©ponse: ${q.answer}</div>`;
  }

  updateDuelHUD();

  // Push my result to Firebase so opponent can see
  if (firebaseReady && currentRoomId) {
    try {
      await database.ref(`rooms/${currentRoomId}/players/${currentUserId}`).update({
        score: duelMyScore,
        correct: duelMyCorrect,
        lastAnsweredQ: duelCurrentQ,
        lastCorrect: isCorrect
      });
    } catch(e) {}
  }

  setTimeout(() => {
    duelCurrentQ++;
    if (duelCurrentQ >= DUEL_QUESTIONS_COUNT) {
      finishMyDuel();
    } else {
      showDuelQuestion();
    }
  }, 2000);
}

function showOppAnswered(correct) {
  const el = document.getElementById('duelOppStatus');
  if (!el) return;
  el.innerHTML = correct
    ? `<span style="color:#10b981;">‚úÖ ${duelOppName} a r√©pondu !</span>`
    : `<span style="color:#ef4444;">‚ùå ${duelOppName} a r√©pondu !</span>`;
  setTimeout(() => {
    if (el) el.innerHTML = `<span>L'adversaire r√©fl√©chit</span><div class="dot-bounce"><span></span><span></span><span></span></div>`;
  }, 1500);
}

// ‚îÄ‚îÄ Fin de duel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function finishMyDuel() {
  player._duelFinished = true;
  clearInterval(duelTimer);

  if (firebaseReady && currentRoomId) {
    try {
      await database.ref(`rooms/${currentRoomId}/players/${currentUserId}`).update({
        score: duelMyScore, correct: duelMyCorrect, finished: true
      });
      await database.ref(`rooms/${currentRoomId}/status`).set('finished');
    } catch(e) {}
  }

  // Wait up to 8 seconds for opponent to finish
  let waited = 0;
  const waitInterval = setInterval(async () => {
    waited += 500;
    if (waited >= 8000) { clearInterval(waitInterval); endDuel(); return; }
    try {
      const snap = await database.ref(`rooms/${currentRoomId}/players/${duelOppUid}`).once('value');
      if (snap.val()?.finished) { clearInterval(waitInterval); endDuel(); }
    } catch(e) { clearInterval(waitInterval); endDuel(); }
  }, 500);
}

function endDuel() {
  if (roomListener) { database.ref('rooms/' + currentRoomId).off(); roomListener = null; }
  const iWon = duelMyScore > duelOppScore;
  const isDraw = duelMyScore === duelOppScore;

  // Rewards
  let coinsGain = iWon ? DUEL_WIN_COINS : (isDraw ? 80 : DUEL_LOSE_COINS);
  let xpGain = iWon ? DUEL_WIN_XP : (isDraw ? 100 : DUEL_LOSE_XP);
  player.coins += coinsGain;
  player.xp += xpGain;
  if (!player.stats) player.stats = {};
  player.stats.questionsAnswered = (player.stats.questionsAnswered || 0) + duelMyCorrect;
  if (!player.duelStats) player.duelStats = { wins: 0, losses: 0, draws: 0 };
  if (iWon) player.duelStats.wins++;
  else if (isDraw) player.duelStats.draws++;
  else player.duelStats.losses++;

  // Save duel history
  if (!player.duelHistory) player.duelHistory = [];
  player.duelHistory.unshift({
    date: new Date().toLocaleDateString('fr-FR'),
    opp: duelOppName,
    myScore: duelMyScore,
    oppScore: duelOppScore,
    result: iWon ? 'win' : isDraw ? 'draw' : 'loss',
    coinsGain, xpGain
  });
  player.duelHistory = player.duelHistory.slice(0, 20); // Garder 20

  // Check level up
  const xpNeeded = player.level * 100;
  if (player.xp >= xpNeeded) { player.level++; player.xp -= xpNeeded; checkBadges(); }

  player._duelFinished = false;
  savePlayer();

  // Clean up room (host only)
  if (duelIsHost && firebaseReady && currentRoomId) {
    setTimeout(() => database.ref('rooms/' + currentRoomId).remove().catch(()=>{}), 5000);
  }
  currentRoomId = null;

  showDuelResult(iWon, isDraw, coinsGain, xpGain);

  // Win confetti
  if (iWon) spawnConfetti();

  // Update quests
  updateQuestProgress('questionsAnswered', duelMyCorrect);
}

function showDuelResult(iWon, isDraw, coinsGain, xpGain) {
  const titleEl = document.getElementById('duelResultTitle');
  const cardsEl = document.getElementById('duelResultCards');
  const rewardsEl = document.getElementById('duelRewardsBox');

  if (titleEl) {
    titleEl.textContent = iWon ? 'üèÜ VICTOIRE !' : isDraw ? 'ü§ù √âGALIT√â !' : 'üíÄ D√âFAITE !';
    titleEl.style.color = iWon ? '#fbbf24' : isDraw ? '#818cf8' : '#ef4444';
  }

  const maxScore = Math.max(duelMyScore, duelOppScore, 1);
  const myPct = Math.round(duelMyScore / maxScore * 100);
  const oppPct = Math.round(duelOppScore / maxScore * 100);

  if (cardsEl) cardsEl.innerHTML = `
    <div class="pvp-player-card ${iWon ? 'winner' : isDraw ? '' : 'loser'}">
      <div class="pvp-info">
        <div class="pvp-name">üë§ ${player.username} ${iWon ? 'üèÜ' : isDraw ? 'ü§ù' : ''}</div>
        <div class="pvp-stats">${duelMyCorrect}/${DUEL_QUESTIONS_COUNT} correctes</div>
        <div style="margin-top:6px;">
          <div style="height:8px;background:rgba(0,0,0,0.4);border-radius:4px;overflow:hidden;width:100%;">
            <div class="result-bar" style="background:${iWon?'#10b981':'#6366f1'};width:0%;" data-pct="${myPct}"></div>
          </div>
        </div>
      </div>
      <div class="pvp-score">${duelMyScore} pts</div>
    </div>
    <div class="vs-divider">VS</div>
    <div class="pvp-player-card ${!iWon && !isDraw ? 'winner' : isDraw ? '' : 'loser'}">
      <div class="pvp-info">
        <div class="pvp-name">ü§ñ ${duelOppName} ${!iWon && !isDraw ? 'üèÜ' : ''}</div>
        <div class="pvp-stats">${duelOppCorrect}/${DUEL_QUESTIONS_COUNT} correctes</div>
        <div style="margin-top:6px;">
          <div style="height:8px;background:rgba(0,0,0,0.4);border-radius:4px;overflow:hidden;width:100%;">
            <div class="result-bar" style="background:${!iWon && !isDraw?'#10b981':'#ef4444'};width:0%;" data-pct="${oppPct}"></div>
          </div>
        </div>
      </div>
      <div class="pvp-score">${duelOppScore} pts</div>
    </div>
    <div style="text-align:center;margin-top:10px;">
      <div style="font-size:0.55rem;color:#9ca3af;">üìä Stats duel: ${player.duelStats.wins}V / ${player.duelStats.draws}N / ${player.duelStats.losses}D</div>
    </div>
  `;

  if (rewardsEl) rewardsEl.innerHTML = `
    <div style="font-size:0.65rem;color:#fbbf24;margin-bottom:8px;">üéÅ R√âCOMPENSES</div>
    <div>üí∞ +${coinsGain} pi√®ces &nbsp;&nbsp; ‚ú® +${xpGain} XP</div>
  `;

  showScreen('duelResultScreen');

  // Animate bars after render
  setTimeout(() => {
    document.querySelectorAll('.result-bar[data-pct]').forEach(bar => {
      bar.style.width = bar.dataset.pct + '%';
    });
  }, 200);
}

// ‚îÄ‚îÄ D√©fier un joueur en ligne ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshOnlinePlayers() {
  const el = document.getElementById('mpOnlineList');
  if (!firebaseReady) { el.innerHTML = '<div style="color:#9ca3af;font-size:0.6rem;text-align:center;padding:20px;">Firebase requis</div>'; return; }
  el.innerHTML = '<div style="color:#9ca3af;font-size:0.6rem;text-align:center;padding:20px;">‚è≥ Recherche...</div>';
  try {
    const snap = await database.ref('presence').once('value');
    const data = snap.val() || {};
    const now = Date.now();
    const online = Object.entries(data).filter(([uid, p]) =>
      uid !== currentUserId && p.online && (now - (p.ts || 0)) < 60000
    );
    if (online.length === 0) {
      el.innerHTML = '<div style="color:#9ca3af;font-size:0.6rem;text-align:center;padding:30px;">üò¥ Aucun joueur en ligne actuellement<br><br>Reviens plus tard !</div>';
      return;
    }
    el.innerHTML = online.map(([uid, p]) => `
      <div class="pvp-player-card" style="margin:6px 0;">
        <div class="pvp-info">
          <div class="pvp-name">${p.username}</div>
          <div class="pvp-stats">Niv. ${p.level || 1} ‚Ä¢ üó∫Ô∏è ${p.maxLevel || 1}</div>
        </div>
        <div class="status-dot online" style="width:10px;height:10px;background:#10b981;box-shadow:0 0 8px #10b981;border-radius:50%;flex-shrink:0;"></div>
        <button class="primary" style="margin:0;padding:8px 12px;font-size:0.5rem;" onclick="challengePlayer('${uid}', '${p.username}')">‚öîÔ∏è D√©fier</button>
      </div>
    `).join('');
  } catch(e) { el.innerHTML = `<div style="color:#ef4444;font-size:0.6rem;">Erreur: ${e.message}</div>`; }
}

async function challengePlayer(targetUid, targetName) {
  if (!player || !firebaseReady) return;
  // Create room and send challenge
  const questions = generateDuelQuestions();
  const roomId = database.ref('rooms').push().key;
  await database.ref('rooms/' + roomId).set({
    hostUid: currentUserId,
    hostName: player.username,
    hostLevel: player.level || 1,
    status: 'waiting',
    createdAt: Date.now(),
    questions: questions,
    players: { [currentUserId]: { name: player.username, level: player.level || 1, score: 0, correct: 0, ready: false } }
  });

  // Send challenge notification
  await database.ref(`challenges/${targetUid}`).push({
    fromUid: currentUserId,
    fromName: player.username,
    roomId: roomId,
    ts: Date.now()
  });

  currentRoomId = roomId;
  duelIsHost = true;
  duelOppUid = targetUid;
  duelOppName = targetName;
  openRoomLobby(roomId, questions);

  alert(`‚öîÔ∏è D√©fi envoy√© √† ${targetName} ! En attente de sa r√©ponse...`);
}

// ‚îÄ‚îÄ Historique duels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDuelHistory() {
  const el = document.getElementById('mpHistory');
  if (!player || !player.duelHistory || player.duelHistory.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:#9ca3af;font-size:0.6rem;padding:30px;">Aucune partie jou√©e encore.</div>';
    return;
  }
  const icons = { win: 'üèÜ', draw: 'ü§ù', loss: 'üíÄ' };
  const colors = { win: '#10b981', draw: '#818cf8', loss: '#ef4444' };
  el.innerHTML = player.duelHistory.map(d => `
    <div style="display:flex;align-items:center;gap:10px;padding:12px;margin:6px 0;background:rgba(0,0,0,0.4);border-radius:10px;border:1px solid ${colors[d.result]}33;">
      <span style="font-size:1.2rem;">${icons[d.result]}</span>
      <div style="flex:1;">
        <div style="font-size:0.6rem;color:#fbbf24;">vs ${d.opp}</div>
        <div style="font-size:0.5rem;color:#9ca3af;">${d.date} ‚Ä¢ ${d.myScore} vs ${d.oppScore} pts</div>
      </div>
      <div style="text-align:right;font-size:0.5rem;color:#10b981;">+${d.coinsGain}üí∞ +${d.xpGain}XP</div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ Abandonner / Quitter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmAbandonDuel() {
  if (confirm('üè≥Ô∏è Abandonner le duel ? Tu perdras la partie.')) {
    duelMyScore = 0;
    endDuel();
  }
}

function leaveMpLobby() {
  if (roomListener && currentRoomId) {
    database.ref('rooms/' + currentRoomId).off();
    roomListener = null;
  }
  if (currentRoomId && firebaseReady) {
    database.ref(`rooms/${currentRoomId}/players/${currentUserId}`).remove().catch(()=>{});
    if (duelIsHost) database.ref('rooms/' + currentRoomId).remove().catch(()=>{});
  }
  currentRoomId = null;
  duelIsHost = false;
  player._duelFinished = false;
  clearInterval(duelTimer);
  document.getElementById('lobbyOverlay')?.remove();
}

// ‚îÄ‚îÄ Confetti victoire ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnConfetti() {
  const colors = ['#fbbf24','#10b981','#818cf8','#ec4899','#f97316','#06b6d4'];
  for (let i = 0; i < 60; i++) {
    const c = document.createElement('div');
    c.className = 'confetti-piece';
    c.style.left = Math.random() * 100 + 'vw';
    c.style.top = '-10px';
    c.style.background = colors[Math.floor(Math.random() * colors.length)];
    c.style.width = (6 + Math.random() * 8) + 'px';
    c.style.height = (6 + Math.random() * 8) + 'px';
    c.style.animationDuration = (1.5 + Math.random() * 2) + 's';
    c.style.animationDelay = (Math.random() * 0.8) + 's';
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 4000);
  }
}

// ‚îÄ‚îÄ Hook logout pour stopper pr√©sence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origLogout = logout;
logout = function() {
  stopPresence();
  leaveMpLobby();
  _origLogout();
};

// ‚îÄ‚îÄ D√©marrer la pr√©sence apr√®s login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origShowScreen = showScreen;
showScreen = function(screenId) {
  _origShowScreen(screenId);
  if (screenId === 'homeScreen' && player && firebaseReady && currentUserId && !currentUserId.startsWith('local_') && !currentUserId.startsWith('admin_') && currentUserId !== 'admin') {
    // Refresh presence on home
    database.ref('presence/' + currentUserId).update({ ts: Date.now(), username: player.username, level: player.level || 1, maxLevel: player.maxLevel || 1, online: true }).catch(()=>{});
  }
};

// Start presence when player logs in (hook into updateHomeScreen first call)
const _origUpdateHS = updateHomeScreen;
updateHomeScreen = function() {
  _origUpdateHS();
  if (player && !player._presenceStarted && firebaseReady && currentUserId && !currentUserId.startsWith('local_') && !currentUserId.startsWith('admin_') && currentUserId !== 'admin') {
    player._presenceStarted = true;
    startPresence();
  }
  // D√©marrer le tracking du temps de jeu (une seule fois par session)
  if (player && !window._ptStarted) {
    window._ptStarted = true;
    startPlayTimeTracking();
  }
  // V√©rifier badges sp√©ciaux
  if (player && !player.isAdmin) checkSpecialBadges();
  // Appliquer les r√©glages
  applySettings();
};

// ========================================
// HOOKS INTO EXISTING FUNCTIONS
// ========================================

// Check talent points when game initializes
const _origInitGame = initGame;
initGame = function(newSession) {
  _origInitGame(newSession);
  if (player) {
    checkTalentPoints();
    updateEnergyDisplay();
  }
};

// ========================================
// SAUVEGARDE ‚Äî TOUTES LES SECONDES
// ========================================
let autoSaveTimer = null;
let _fbSaveDebounce = null;
let _lbLastUpdate = 0;
const LB_UPDATE_INTERVAL = 120000; // Leaderboard max toutes les 2 min

// savePlayer : localStorage imm√©diat + Firebase debounc√© 15s
async function savePlayer() {
  if (!player) return;
  // 1. Sauvegarde locale imm√©diate (toujours)
  savePlayerLocal();
  // 2. Firebase : debounc√© 15 secondes pour √©viter le flood
  if (firebaseReady && currentUserId && !currentUserId.startsWith('local_')) {
    clearTimeout(_fbSaveDebounce);
    _fbSaveDebounce = setTimeout(async () => {
      await savePlayerToFirebase();
    }, 15000);
  }
}

// Sauvegarde Firebase forc√©e (sans debounce) ‚Äî pour logout, beforeunload, etc.
async function savePlayerNow() {
  if (!player) return;
  savePlayerLocal();
  if (firebaseReady && currentUserId && !currentUserId.startsWith('local_')) {
    clearTimeout(_fbSaveDebounce);
    await savePlayerToFirebase();
    // Leaderboard si assez de temps √©coul√©
    if (Date.now() - _lbLastUpdate > LB_UPDATE_INTERVAL) {
      await updateLeaderboardEntry();
      _lbLastUpdate = Date.now();
    }
  }
}

function startAutoSave() {
  if (autoSaveTimer) clearInterval(autoSaveTimer);
  // Sauvegarde Firebase toutes les 30 secondes (raisonnable pour le quota)
  autoSaveTimer = setInterval(async () => {
    if (!player) return;
    clearTimeout(_fbSaveDebounce); // Annuler debounce en cours
    await savePlayerToFirebase();
    // Leaderboard toutes les 2 min max
    if (Date.now() - _lbLastUpdate > LB_UPDATE_INTERVAL) {
      await updateLeaderboardEntry();
      _lbLastUpdate = Date.now();
    }
  }, 30000); // Toutes les 30 secondes
}

function showSaveNotification() {
  const el = document.getElementById('autosaveIndicator');
  if (!el) return;
  el.classList.add('show');
  clearTimeout(el._hideTimer);
  el.textContent = '‚öôÔ∏è.';
  el._hideTimer = setTimeout(() => el.classList.remove('show'), 1200);
}

async function manualSave() {
  if (!player) return;
  clearTimeout(_fbSaveDebounce);
  await savePlayerToFirebase();
  await updateLeaderboardEntry();
  _lbLastUpdate = Date.now();
  alert('üíæ Progression sauvegard√©e !');
}

window.addEventListener('beforeunload', () => { if (player) savePlayerNow(); });
document.addEventListener('visibilitychange', () => { if (document.hidden && player) savePlayerNow(); });

// Lancer Firebase d√®s que la page est charg√©e
window.addEventListener('load', () => {
  initFirebase();
  scheduleRandomEvent();
  applySettings();
  
  // D√©marrer/d√©verrouiller l'AudioContext au premier clic (requis par les navigateurs)
  let _audioUnlocked = false;
  document.addEventListener('click', (e) => {
    if (!_audioUnlocked) {
      _audioUnlocked = true;
      try {
        // D√©verrouiller ET d√©marrer dans le m√™me event handler
        if (typeof MUSIC !== 'undefined' && MUSIC._getCtx) {
          const ctx = MUSIC._getCtx(); // cr√©e le contexte
          if (ctx.state === 'suspended') {
            ctx.resume().then(() => {
              // D√©marrer la musique apr√®s le resume
              if (getSettings().musicEnabled && !MUSIC._isPlaying) {
                const active = document.querySelector('.screen.active');
                if (active) updateMusicForScreen(active.id);
              }
            }).catch(()=>{});
          } else if (getSettings().musicEnabled && !MUSIC._isPlaying) {
            const active = document.querySelector('.screen.active');
            if (active) updateMusicForScreen(active.id);
          }
        }
      } catch(e) { console.warn('Audio unlock error:', e); }
    }
    // Son de clic sur les boutons
    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
      playClickSound();
    }
  });
});
</script>
<div style="text-align:center;padding:20px 0 10px;font-family:'Press Start 2P',cursive;font-size:0.45rem;color:rgba(255,255,255,0.25);letter-spacing:2px;">v1.3.0</div>
</body>
</html>